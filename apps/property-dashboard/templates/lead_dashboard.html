<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties for {{ client_name }} | Jon Tharp Homes</title>
    <!-- Shared Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <!-- Page-specific overrides (minimal) -->
    <style>
        /* Address column - wider for client dashboard */
        td.address-col {
            min-width: 260px;
            white-space: nowrap;
        }

        /* Centered metrics container for client view */
        .dreams-metrics {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Centered results bar for client view */
        .dreams-results-bar {
            text-align: center;
        }

        /* Table minimum width */
        .dreams-table {
            min-width: 1100px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dreams-header dreams-header-centered">
        <h1>Properties Curated for {{ client_name }}</h1>
        <div class="dreams-header-subtitle">
            Updated: {{ refresh_time }}
        </div>
    </header>

    <!-- Filters -->
    <div class="dreams-filters dreams-filters-centered">
        <div class="dreams-filter-group">
            <label>Status:</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="dreams-filter-group">
            <label>City:</label>
            <select id="cityFilter" onchange="applyFilters()">
                <option value="">All Cities</option>
                {% for city in cities %}
                <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="dreams-filter-group">
            <label>County:</label>
            <select id="countyFilter" onchange="applyFilters()">
                <option value="">All Counties</option>
                {% for county in counties %}
                <option value="{{ county }}" {% if selected_county == county %}selected{% endif %}>{{ county }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="dreams-metrics">
        <div class="dreams-metric-card highlight">
            <div class="dreams-metric-label">Properties</div>
            <div class="dreams-metric-value">{{ properties|length }}</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg Price</div>
            <div class="dreams-metric-value">{{ "${:,.0f}".format(metrics.avg_price) if metrics.avg_price else 'N/A' }}</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg $/SqFt</div>
            <div class="dreams-metric-value">{{ "${:,.0f}".format(metrics.avg_price_per_sqft) if metrics.avg_price_per_sqft else 'N/A' }}</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg Size</div>
            <div class="dreams-metric-value">{{ "{:,.0f}".format(metrics.avg_sqft) if metrics.avg_sqft else 'N/A' }} ft</div>
        </div>
    </div>

    <!-- Results Bar -->
    <div class="dreams-results-bar">
        <div class="dreams-results-count">
            <strong>{{ properties|length }}</strong> properties
            {% if metrics.status_counts %}
                ({% for status, count in metrics.status_counts.items() %}{{ status }}: {{ count }}{% if not loop.last %}, {% endif %}{% endfor %})
            {% endif %}
        </div>
    </div>

    <!-- Properties Table -->
    <div class="dreams-table-container">
        <table class="dreams-table" id="propertiesTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Image</th>
                    <th data-sort="address">Address</th>
                    <th data-sort="city">City</th>
                    <th data-sort="county">County</th>
                    <th data-sort="status">Status</th>
                    <th class="num-col" data-sort="price" data-type="number">Price</th>
                    <th class="num-col" data-sort="price_per_sqft" data-type="number">$/SqFt</th>
                    <th data-sort="property_type">Type</th>
                    <th class="num-col" data-sort="beds" data-type="number">Beds</th>
                    <th class="num-col" data-sort="baths" data-type="number">Baths</th>
                    <th class="num-col" data-sort="sqft" data-type="number">SqFt</th>
                    <th class="num-col" data-sort="lot_acres" data-type="number">Lot</th>
                    <th class="num-col" data-sort="year_built" data-type="number">Year</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in properties %}
                <tr>
                    <td class="row-num">{{ loop.index }}</td>
                    <td>
                        {% if prop.photo_url %}
                        <img src="{{ prop.photo_url }}" class="dreams-prop-image" alt="Property" onerror="this.outerHTML='<div class=\'dreams-prop-image-placeholder\'>üè†</div>'">
                        {% else %}
                        <div class="dreams-prop-image-placeholder">üè†</div>
                        {% endif %}
                    </td>
                    <td class="address-col">
                        {% if prop.mls_number %}
                        <a href="https://www.smokymountainhomes4sale.com/property/{{ prop.mls_number }}" target="_blank" class="dreams-link">{{ prop.address or 'Unknown' }}</a>
                        {% elif prop.url %}
                        <a href="{{ prop.url }}" target="_blank" class="dreams-link">{{ prop.address or 'Unknown' }}</a>
                        {% else %}
                        {{ prop.address or 'Unknown' }}
                        {% endif %}
                    </td>
                    <td>{{ prop.city or '-' }}</td>
                    <td>{{ prop.county or '-' }}</td>
                    <td>
                        <span class="dreams-badge dreams-badge-{{ (prop.status or 'unknown')|lower|replace(' ', '-') }}">
                            {{ prop.status or 'Unknown' }}
                        </span>
                    </td>
                    <td class="num-col dreams-price">{{ "${:,.0f}".format(prop.price) if prop.price else '-' }}</td>
                    <td class="num-col">{{ "${:,.0f}".format(prop.price_per_sqft) if prop.price_per_sqft else '-' }}</td>
                    <td>{{ prop.property_type or '-' }}</td>
                    <td class="num-col">{{ prop.beds or '-' }}</td>
                    <td class="num-col">{{ prop.baths or '-' }}</td>
                    <td class="num-col">{{ "{:,.0f}".format(prop.sqft) if prop.sqft else '-' }}</td>
                    <td class="num-col">{{ "{:.2f}".format(prop.lot_acres) if prop.lot_acres else '-' }}</td>
                    <td class="num-col">{{ prop.year_built or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <footer class="dreams-footer">
        Curated by <a href="https://www.jontharp.com" target="_blank">Jon Tharp Homes</a> | Joseph Williams
    </footer>

    <script>
        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const city = document.getElementById('cityFilter').value;
            const county = document.getElementById('countyFilter').value;
            const params = new URLSearchParams();

            if (status) params.set('status', status);
            if (city) params.set('city', city);
            if (county) params.set('county', county);

            const queryString = params.toString();
            window.location.search = queryString;
        }

        // Table sorting
        let currentSort = { column: null, direction: null };
        let originalOrder = [];

        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.querySelector('#propertiesTable tbody');
            if (tbody) {
                originalOrder = Array.from(tbody.querySelectorAll('tr'));
            }
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => sortTable(th));
        });

        function sortTable(th) {
            const column = th.dataset.sort;
            const isNumeric = th.dataset.type === 'number';
            const table = document.getElementById('propertiesTable');
            const tbody = table.querySelector('tbody');
            let rows = Array.from(tbody.querySelectorAll('tr'));

            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = null;
                    currentSort.column = null;
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            if (currentSort.direction) {
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            if (!currentSort.direction) {
                rows = [...originalOrder];
            } else {
                const colIndex = Array.from(th.parentElement.children).indexOf(th);

                rows.sort((a, b) => {
                    let aVal = a.children[colIndex]?.textContent?.trim() || '';
                    let bVal = b.children[colIndex]?.textContent?.trim() || '';

                    if (isNumeric) {
                        aVal = parseFloat(aVal.replace(/[$,]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[$,]/g, '')) || 0;
                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        return currentSort.direction === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    }
                });
            }

            rows.forEach((row, i) => {
                row.querySelector('.row-num').textContent = i + 1;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
