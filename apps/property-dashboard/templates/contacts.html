<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMS Contacts Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <!-- Shared Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <!-- Page-specific overrides -->
    <style>
        /* Score bar visualization */
        .score-bar {
            width: 80px;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-bar-fill.heat { background: linear-gradient(90deg, #f59e0b, #ef4444); }
        .score-bar-fill.value { background: linear-gradient(90deg, #10b981, #059669); }
        .score-bar-fill.relationship { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .score-bar-fill.priority { background: linear-gradient(90deg, var(--primary), var(--primary-light)); }

        /* Intent signals */
        .intent-signals {
            display: flex;
            gap: 4px;
        }

        .intent-signal {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .intent-signal.active {
            background: var(--success);
            color: white;
        }

        /* Contact name styling */
        .contact-name {
            font-weight: 600;
            color: var(--primary);
        }

        .contact-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Table minimum width */
        .dreams-table {
            min-width: 1500px;
        }

        /* Activity indicator */
        .activity-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .activity-indicator.recent { background: #10b981; }
        .activity-indicator.moderate { background: #f59e0b; }
        .activity-indicator.cold { background: #9ca3af; }

        /* Trend indicator */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
        }
        .trend-indicator.warming { background: #dcfce7; color: #166534; }
        .trend-indicator.cooling { background: #fee2e2; color: #991b1b; }
        .trend-indicator.stable { background: #f3f4f6; color: #6b7280; }
        .trend-indicator.none { background: transparent; color: #d1d5db; }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-btn .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .tab-btn.active .badge {
            background: rgba(255,255,255,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Suggested action badge */
        .suggested-action {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .suggested-action.urgent {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .suggested-action.high {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fef08a;
        }

        .suggested-action.medium {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        .suggested-action.low {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        /* Action Queue Cards */
        .queue-section {
            margin-bottom: 24px;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            color: white;
            font-weight: 600;
        }

        .queue-header.priority-1 { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .queue-header.priority-2 { background: linear-gradient(135deg, #d97706, #f59e0b); }
        .queue-header.priority-3 { background: linear-gradient(135deg, #059669, #10b981); }
        .queue-header.priority-4 { background: linear-gradient(135deg, #4b5563, #6b7280); }

        .queue-items {
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: var(--bg-primary);
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-item:hover {
            background: var(--bg-secondary);
        }

        .queue-item-info {
            flex: 1;
        }

        .queue-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .queue-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 16px;
        }

        .queue-item-scores {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .mini-score {
            text-align: center;
        }

        .mini-score-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .mini-score-value {
            font-weight: 700;
            font-size: 16px;
        }

        .mini-score-value.heat { color: #ef4444; }
        .mini-score-value.value { color: #10b981; }
        .mini-score-value.priority { color: var(--primary); }

        .queue-item-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
        }

        .action-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .action-btn.secondary:hover {
            background: var(--border);
        }

        /* Score Analysis */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .analysis-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .analysis-card-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .distribution-bar {
            display: flex;
            height: 32px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .dist-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: opacity 0.2s;
        }

        .dist-segment:hover {
            opacity: 0.85;
        }

        .dist-segment.excellent { background: #22c55e; }
        .dist-segment.good { background: #84cc16; }
        .dist-segment.medium { background: #eab308; }
        .dist-segment.low { background: #ef4444; }

        .dist-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Insights Cards */
        .insights-grid {
            display: grid;
            gap: 16px;
        }

        .insight-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .insight-card.opportunity {
            border-left-color: #22c55e;
            background: linear-gradient(90deg, #f0fdf4, var(--bg-primary));
        }

        .insight-card.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, #fffbeb, var(--bg-primary));
        }

        .insight-card.success {
            border-left-color: #3b82f6;
            background: linear-gradient(90deg, #eff6ff, var(--bg-primary));
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .insight-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .insight-count {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .insight-description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .insight-action {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .insight-action strong {
            color: var(--text-primary);
        }

        .insight-contacts {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .insight-contacts-title {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .insight-contact-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .insight-contact-chip {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Trends */
        .trends-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
        }

        .trend-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .trend-label {
            width: 120px;
            font-weight: 500;
            font-size: 14px;
        }

        .trend-bar-container {
            flex: 1;
            background: var(--bg-tertiary);
            height: 28px;
            border-radius: 6px;
            overflow: hidden;
        }

        .trend-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.5s ease;
        }

        .trend-bar-fill.active { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .trend-bar-fill.warm { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .trend-bar-fill.cold { background: linear-gradient(90deg, #6b7280, #9ca3af); }
        .trend-bar-fill.stale { background: linear-gradient(90deg, #dc2626, #ef4444); }

        .trend-value {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Smart List Cards Row */
        .smart-list-row {
            display: flex;
            gap: 8px;
            padding: 10px var(--space-lg, 24px);
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .sl-card {
            flex: 1;
            min-width: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            display: block;
        }
        .sl-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .sl-card.active {
            border-color: var(--primary);
            border-width: 2px;
            background: var(--bg-secondary);
        }
        .sl-card-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 2px;
            white-space: nowrap;
        }
        .sl-card-count {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.1;
        }
        .sl-card-cadence {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 1px;
        }
        /* Color themes per list */
        .sl-card.new-leads .sl-card-label { color: #2563eb; }
        .sl-card.new-leads .sl-card-count { color: #2563eb; }
        .sl-card.hot .sl-card-label { color: #dc2626; }
        .sl-card.hot .sl-card-count { color: #dc2626; }
        .sl-card.warm .sl-card-label { color: #d97706; }
        .sl-card.warm .sl-card-count { color: #d97706; }
        .sl-card.cool .sl-card-label { color: #4f46e5; }
        .sl-card.cool .sl-card-count { color: #4f46e5; }
        .sl-card.unresponsive .sl-card-label { color: #6b7280; }
        .sl-card.unresponsive .sl-card-count { color: #6b7280; }
        .sl-card.tf-empty .sl-card-label { color: #7c3aed; }
        .sl-card.tf-empty .sl-card-count { color: #7c3aed; }
        /* Slider inside card */
        .sl-slider {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--border);
        }
        .sl-slider input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            background: #d1d5db;
        }
        .sl-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: grab;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .sl-slider .sl-slider-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        /* Slider color themes */
        .sl-card.new-leads .sl-slider input[type="range"] {
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--slider-pct, 23%), #d1d5db var(--slider-pct, 23%), #d1d5db 100%);
        }
        .sl-card.new-leads .sl-slider input[type="range"]::-webkit-slider-thumb { background: #3b82f6; }
        .sl-card.hot .sl-slider input[type="range"] {
            background: linear-gradient(to right, #ef4444 0%, #ef4444 var(--slider-pct, 70%), #d1d5db var(--slider-pct, 70%), #d1d5db 100%);
        }
        .sl-card.hot .sl-slider input[type="range"]::-webkit-slider-thumb { background: #ef4444; }
        .sl-card.warm .sl-slider input[type="range"] {
            background: linear-gradient(to right, #f59e0b 0%, #f59e0b var(--slider-pct, 40%), #d1d5db var(--slider-pct, 40%), #d1d5db 100%);
        }
        .sl-card.warm .sl-slider input[type="range"]::-webkit-slider-thumb { background: #f59e0b; }
        .sl-card.cool .sl-slider input[type="range"] {
            background: linear-gradient(to right, #6366f1 0%, #6366f1 var(--slider-pct, 10%), #d1d5db var(--slider-pct, 10%), #d1d5db 100%);
        }
        .sl-card.cool .sl-slider input[type="range"]::-webkit-slider-thumb { background: #6366f1; }

        /* View Pills */
        .view-pills {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin: 0 var(--space-lg, 24px) 16px;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .view-pill {
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .view-pill:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .view-pill.active { background: var(--color-primary); color: #ffffff; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2); }

        /* Table container ‚Äî offset for header + view pills + smart list cards + tabs + filters */
        .dreams-table-container {
            max-height: calc(100vh - 380px);
        }

        /* Search box */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
        }
        .search-box .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-secondary);
            display: none;
        }
        .search-box .clear-btn.visible {
            display: block;
        }

        /* Filter active badge */
        .filter-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            margin-left: 12px;
        }
        .filter-badge a {
            color: white;
            margin-left: 8px;
            text-decoration: none;
        }

        /* (Old threshold slider CSS removed ‚Äî replaced by .sl-slider) */

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
    </style>
    {% set active_nav = 'contacts' %}
</head>
<body>
    {% include 'partials/sidebar.html' %}
    <div class="main-content">
    <!-- Header -->
    <header class="dreams-header">
        <div>
            <h1>DREAMS Contacts</h1>
            <div class="dreams-header-subtitle">Lead Scoring & Prioritization</div>
        </div>
        <span style="font-size: 13px; opacity: 0.8;">Last refreshed: {{ refresh_time }}</span>
    </header>

    <!-- View Pills -->
    <div class="view-pills">
        {% for key, view in contact_views.items() %}
        <a href="/contacts?view={{ key }}{{ '&tab=' + active_tab if active_tab else '' }}"
           class="view-pill {% if current_view == key %}active{% endif %}">
            {{ view.label }}
        </a>
        {% endfor %}
    </div>

    <!-- Smart List Cards -->
    <div class="smart-list-row">
        <div class="sl-card new-leads" id="slNewLeads" onclick="toggleSlFilter(this, 'new_leads')">
            <div class="sl-card-label">New Leads (<span id="slNewDaysLabel">7</span>d)</div>
            <div class="sl-card-count" id="slNewCount">{{ smart_lists.new_leads|length }}</div>
            <div class="sl-card-cadence">daily</div>
            <div class="sl-slider" onclick="event.stopPropagation()">
                <input type="range" id="slNewDaysSlider" min="1" max="30" value="7" oninput="updateSmartListThresholds()">
                <div class="sl-slider-label">Days: <span id="slNewDaysVal">7</span></div>
            </div>
        </div>
        <div class="sl-card hot" id="slHot" onclick="toggleSlFilter(this, 'hot')">
            <div class="sl-card-label">Hot (<span id="slHotLabel">70</span>+)</div>
            <div class="sl-card-count" id="slHotCount">{{ smart_lists.hot|length }}</div>
            <div class="sl-card-cadence">weekly</div>
            <div class="sl-slider" onclick="event.stopPropagation()">
                <input type="range" id="slHotSlider" min="0" max="100" value="70" oninput="updateSmartListThresholds()">
                <div class="sl-slider-label">Heat: <span id="slHotVal">70</span></div>
            </div>
        </div>
        <div class="sl-card warm" id="slWarm" onclick="toggleSlFilter(this, 'warm')">
            <div class="sl-card-label">Warm (<span id="slWarmLabel">40</span>+)</div>
            <div class="sl-card-count" id="slWarmCount">{{ smart_lists.warm|length }}</div>
            <div class="sl-card-cadence">monthly</div>
            <div class="sl-slider" onclick="event.stopPropagation()">
                <input type="range" id="slWarmSlider" min="0" max="100" value="40" oninput="updateSmartListThresholds()">
                <div class="sl-slider-label">Heat: <span id="slWarmVal">40</span></div>
            </div>
        </div>
        <div class="sl-card cool" id="slCool" onclick="toggleSlFilter(this, 'cool')">
            <div class="sl-card-label">Cool (<span id="slCoolLabel">10</span>+)</div>
            <div class="sl-card-count" id="slCoolCount">{{ smart_lists.cool|length }}</div>
            <div class="sl-card-cadence">quarterly</div>
            <div class="sl-slider" onclick="event.stopPropagation()">
                <input type="range" id="slCoolSlider" min="0" max="100" value="10" oninput="updateSmartListThresholds()">
                <div class="sl-slider-label">Heat: <span id="slCoolVal">10</span></div>
            </div>
        </div>
        <a href="/smart-lists" class="sl-card unresponsive" style="text-decoration:none;">
            <div class="sl-card-label">Unresponsive</div>
            <div class="sl-card-count">{{ smart_lists.unresponsive|length }}</div>
            <div class="sl-card-cadence">biweekly</div>
        </a>
        <a href="/smart-lists" class="sl-card tf-empty" style="text-decoration:none;">
            <div class="sl-card-label">TF Empty</div>
            <div class="sl-card-count">{{ smart_lists.timeframe_empty|length }}</div>
            <div class="sl-card-cadence">as needed</div>
        </a>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <button class="tab-btn {% if active_tab == 'contacts' %}active{% endif %}" onclick="switchTab('contacts')">
            üìã Contacts <span class="badge">{{ contacts|length }}</span>
        </button>
        <button class="tab-btn {% if active_tab == 'queue' %}active{% endif %}" onclick="switchTab('queue')">
            üéØ Action Queue <span class="badge">{{ action_queue[1]|length + action_queue[2]|length + action_queue[3]|length + action_queue[4]|length }}</span>
        </button>
        <button class="tab-btn {% if active_tab == 'analysis' %}active{% endif %}" onclick="switchTab('analysis')">
            üìä Score Analysis
        </button>
        <button class="tab-btn {% if active_tab == 'insights' %}active{% endif %}" onclick="switchTab('insights')">
            üí° Insights <span class="badge">{{ strategic_insights|length }}</span>
        </button>
        <button class="tab-btn {% if active_tab == 'trends' %}active{% endif %}" onclick="switchTab('trends')">
            üìà Trends
        </button>
    </div>

    <!-- Tab: Contacts -->
    <div id="tab-contacts" class="tab-content {% if active_tab == 'contacts' %}active{% endif %}">
        <!-- Filters -->
        <div class="dreams-filters">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by name, email, phone..." autocomplete="off">
                <button class="clear-btn" id="clearSearch" onclick="clearSearch()">&times;</button>
            </div>

            <div class="dreams-filter-group">
                <label>Stage:</label>
                <select id="stageFilter" onchange="applyFilters()">
                    <option value="">All Stages</option>
                    {% for stage in stages %}
                    <option value="{{ stage }}" {% if selected_stage == stage %}selected{% endif %}>{{ stage }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="dreams-filter-group">
                <label>Min Heat:</label>
                <select id="heatFilter" onchange="applyFilters()">
                    <option value="0" {% if selected_min_heat == 0 %}selected{% endif %}>All</option>
                    <option value="25" {% if selected_min_heat == 25 %}selected{% endif %}>25+</option>
                    <option value="50" {% if selected_min_heat == 50 %}selected{% endif %}>50+ (Warm)</option>
                    <option value="75" {% if selected_min_heat == 75 %}selected{% endif %}>75+ (Hot)</option>
                </select>
            </div>

            <div class="dreams-filter-group">
                <label>Sort By:</label>
                <select id="sortFilter" onchange="applyFilters()">
                    <option value="priority" {% if selected_sort == 'priority' %}selected{% endif %}>Priority Score</option>
                    <option value="heat" {% if selected_sort == 'heat' %}selected{% endif %}>Heat Score</option>
                    <option value="value" {% if selected_sort == 'value' %}selected{% endif %}>Value Score</option>
                    <option value="name" {% if selected_sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                </select>
            </div>
        </div>

        <!-- Results Bar -->
        <div class="dreams-results-bar">
            <div class="dreams-results-count">
                <strong id="visibleCount">{{ contacts|length }}</strong> contacts shown
                {% if selected_filter %}
                <span class="filter-badge">
                    {% if selected_filter == 'hot_leads' %}Hot Leads{% elif selected_filter == 'high_value' %}High Value{% elif selected_filter == 'active_week' %}Active This Week{% endif %}
                    <a href="/contacts" title="Clear filter">&times;</a>
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Contacts Table -->
        <div class="dreams-table-container">
            <table class="dreams-table" id="contactsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th data-sort="name">Name</th>
                        <th data-sort="stage">Stage</th>
                        <th>Suggested Action</th>
                        <th data-sort="views" data-type="number">Views</th>
                        <th data-sort="fav" data-type="number">Fav</th>
                        <th data-sort="trend">Trend</th>
                        <th data-sort="priority" data-type="number">Priority</th>
                        <th data-sort="heat" data-type="number">Heat</th>
                        <th data-sort="value" data-type="number">Value</th>
                        <th data-sort="relationship" data-type="number">Relationship</th>
                        <th data-sort="activity" data-type="number">Activity</th>
                        <th>Intent</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contact in contacts %}
                    {% set days_inactive = contact.days_since_activity or 999 %}
                    <tr data-heat="{{ contact.heat_score or 0 }}" data-value="{{ contact.value_score or 0 }}" data-days="{{ days_inactive }}" data-rel="{{ contact.relationship_score or 0 }}" data-stage="{{ contact.stage or '' }}">
                        <td class="row-num">{{ loop.index }}</td>
                        <td>
                            <a href="/contacts/{{ contact.id }}" class="contact-name">
                                {{ contact.first_name or '' }} {{ contact.last_name or '' }}
                            </a>
                            {% if contact.email %}
                            <div class="contact-email">{{ contact.email }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="dreams-badge dreams-badge-{{ (contact.stage or 'unknown')|lower|replace(' ', '-') }}">
                                {{ contact.stage or 'Unknown' }}
                            </span>
                        </td>
                        <td>
                            <span class="suggested-action {{ contact.suggested_action.class }}">
                                {{ contact.suggested_action.icon }} {{ contact.suggested_action.text }}
                            </span>
                        </td>
                        <td style="text-align: center;">{{ contact.properties_viewed or 0 }}</td>
                        <td style="text-align: center;">{{ contact.properties_favorited or 0 }}</td>
                        <td>
                            {% set trend = contact.score_trend or 'none' %}
                            <span class="trend-indicator {{ trend }}" title="{{ trend|capitalize }}">
                                {% if trend == 'warming' %}&#8593;{% elif trend == 'cooling' %}&#8595;{% elif trend == 'stable' %}&#8596;{% else %}&mdash;{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="score-bar"><div class="score-bar-fill priority" style="width: {{ contact.priority_score or 0 }}%;"></div></div>
                            <span>{{ "%.0f"|format(contact.priority_score or 0) }}</span>
                        </td>
                        <td>
                            <div class="score-bar"><div class="score-bar-fill heat" style="width: {{ contact.heat_score or 0 }}%;"></div></div>
                            <span>{{ "%.0f"|format(contact.heat_score or 0) }}</span>
                        </td>
                        <td>
                            <div class="score-bar"><div class="score-bar-fill value" style="width: {{ contact.value_score or 0 }}%;"></div></div>
                            <span>{{ "%.0f"|format(contact.value_score or 0) }}</span>
                        </td>
                        <td>
                            <div class="score-bar"><div class="score-bar-fill relationship" style="width: {{ contact.relationship_score or 0 }}%;"></div></div>
                            <span>{{ "%.0f"|format(contact.relationship_score or 0) }}</span>
                        </td>
                        <td>
                            <span class="activity-indicator {% if days_inactive <= 7 %}recent{% elif days_inactive <= 30 %}moderate{% else %}cold{% endif %}"></span>
                            {% if days_inactive < 999 %}{{ days_inactive }}d{% else %}--{% endif %}
                        </td>
                        <td>
                            <div class="intent-signals">
                                <span class="intent-signal {% if contact.intent_repeat_views %}active{% endif %}" title="Repeat Views">R</span>
                                <span class="intent-signal {% if contact.intent_high_favorites %}active{% endif %}" title="High Favorites">F</span>
                                <span class="intent-signal {% if contact.intent_activity_burst %}active{% endif %}" title="Activity Burst">B</span>
                                <span class="intent-signal {% if contact.intent_sharing %}active{% endif %}" title="Sharing">S</span>
                            </div>
                        </td>
                        <td>
                            {% if contact.phone %}
                            {% if contact.fub_id %}
                            <a href="{{ fub_url }}/2/people/view/{{ contact.fub_id }}" target="_blank" style="color: #6366f1; text-decoration: none;">
                                {{ contact.phone|phone }}
                            </a>
                            {% else %}
                            <a href="tel:{{ contact.phone }}" style="color: inherit;">{{ contact.phone|phone }}</a>
                            {% endif %}
                            {% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab: Action Queue -->
    <div id="tab-queue" class="tab-content {% if active_tab == 'queue' %}active{% endif %}">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Prioritized list of leads requiring attention today, grouped by urgency.</p>

        {% set priority_config = {
            1: {'label': 'üî• Priority 1: Immediate Contact', 'desc': 'Hot leads with recent activity'},
            2: {'label': 'üíé Priority 2: High Value Warm', 'desc': 'High value prospects showing engagement'},
            3: {'label': 'üå± Priority 3: Nurture Opportunities', 'desc': 'Good relationships needing attention'},
            4: {'label': '‚è∞ Priority 4: Re-engagement', 'desc': 'Valuable leads gone quiet'}
        } %}

        {% for priority_level in [1, 2, 3, 4] %}
        {% if action_queue[priority_level] %}
        <div class="queue-section">
            <div class="queue-header priority-{{ priority_level }}">
                <div>
                    <span style="font-size: 16px;">{{ priority_config[priority_level].label }}</span>
                    <div style="font-size: 12px; opacity: 0.9;">{{ priority_config[priority_level].desc }}</div>
                </div>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">
                    {{ action_queue[priority_level]|length }} leads
                </span>
            </div>
            <div class="queue-items">
                {% for contact in action_queue[priority_level][:10] %}
                <div class="queue-item">
                    <div class="queue-item-info">
                        <div class="queue-item-name">
                            <a href="/contacts/{{ contact.id }}" style="color: inherit; text-decoration: none;">
                                {{ contact.first_name or '' }} {{ contact.last_name or '' }}
                            </a>
                        </div>
                        <div class="queue-item-meta">
                            <span>{{ contact.stage or 'No stage' }}</span>
                            <span>{{ contact.email or 'No email' }}</span>
                            {% if contact.days_since_activity and contact.days_since_activity < 999 %}
                            <span>{{ contact.days_since_activity }}d ago</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="queue-item-scores">
                        <div class="mini-score">
                            <div class="mini-score-label">Priority</div>
                            <div class="mini-score-value priority">{{ "%.0f"|format(contact.priority_score or 0) }}</div>
                        </div>
                        <div class="mini-score">
                            <div class="mini-score-label">Heat</div>
                            <div class="mini-score-value heat">{{ "%.0f"|format(contact.heat_score or 0) }}</div>
                        </div>
                        <div class="mini-score">
                            <div class="mini-score-label">Value</div>
                            <div class="mini-score-value value">{{ "%.0f"|format(contact.value_score or 0) }}</div>
                        </div>
                    </div>
                    <div class="queue-item-actions">
                        <span class="suggested-action {{ contact.suggested_action.class }}">
                            {{ contact.suggested_action.icon }} {{ contact.suggested_action.text }}
                        </span>
                        {% if contact.phone %}
                        {% if contact.fub_id %}
                        <a href="{{ fub_url }}/2/people/view/{{ contact.fub_id }}" target="_blank" class="action-btn secondary" title="Call via FUB">üì± Call</a>
                        {% else %}
                        <a href="tel:{{ contact.phone }}" class="action-btn secondary">üì± Call</a>
                        {% endif %}
                        {% endif %}
                        {% if contact.email %}
                        <a href="mailto:{{ contact.email }}" class="action-btn secondary">üìß Email</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if action_queue[priority_level]|length > 10 %}
                <div style="padding: 12px 16px; text-align: center; color: var(--text-secondary); font-size: 13px;">
                    + {{ action_queue[priority_level]|length - 10 }} more leads in this tier
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        {% if not action_queue[1] and not action_queue[2] and not action_queue[3] and not action_queue[4] %}
        <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <div class="empty-state-title">All caught up!</div>
            <p>No pending actions at this time.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab: Score Analysis -->
    <div id="tab-analysis" class="tab-content {% if active_tab == 'analysis' %}active{% endif %}">
        <div class="analysis-grid">
            {% for score_type in ['priority', 'heat', 'value', 'relationship'] %}
            {% set dist = score_analysis.distribution[score_type] %}
            {% set total = dist.excellent + dist.good + dist.medium + dist.low %}
            <div class="analysis-card">
                <div class="analysis-card-title">{{ score_type|capitalize }} Score Distribution</div>
                {% if total > 0 %}
                <div class="distribution-bar">
                    {% if dist.excellent > 0 %}
                    <div class="dist-segment excellent" style="width: {{ (dist.excellent / total * 100)|round(1) }}%;" title="Excellent (90+): {{ dist.excellent }}">
                        {% if dist.excellent / total * 100 > 10 %}{{ dist.excellent }}{% endif %}
                    </div>
                    {% endif %}
                    {% if dist.good > 0 %}
                    <div class="dist-segment good" style="width: {{ (dist.good / total * 100)|round(1) }}%;" title="Good (70-89): {{ dist.good }}">
                        {% if dist.good / total * 100 > 10 %}{{ dist.good }}{% endif %}
                    </div>
                    {% endif %}
                    {% if dist.medium > 0 %}
                    <div class="dist-segment medium" style="width: {{ (dist.medium / total * 100)|round(1) }}%;" title="Medium (50-69): {{ dist.medium }}">
                        {% if dist.medium / total * 100 > 10 %}{{ dist.medium }}{% endif %}
                    </div>
                    {% endif %}
                    {% if dist.low > 0 %}
                    <div class="dist-segment low" style="width: {{ (dist.low / total * 100)|round(1) }}%;" title="Low (<50): {{ dist.low }}">
                        {% if dist.low / total * 100 > 10 %}{{ dist.low }}{% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="dist-legend">
                    <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div>Excellent {{ dist.excellent }}</div>
                    <div class="legend-item"><div class="legend-color" style="background: #84cc16;"></div>Good {{ dist.good }}</div>
                    <div class="legend-item"><div class="legend-color" style="background: #eab308;"></div>Medium {{ dist.medium }}</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div>Low {{ dist.low }}</div>
                </div>
                {% else %}
                <p style="color: var(--text-secondary);">No data available</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <h3 style="margin-bottom: 16px;">Score Insights</h3>
        <div class="analysis-grid">
            {% for insight in score_analysis.insights %}
            <div class="analysis-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="analysis-card-title" style="margin-bottom: 4px;">{{ insight.category }}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">{{ insight.description }}</div>
                    </div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--primary);">{{ insight.count }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Tab: Strategic Insights -->
    <div id="tab-insights" class="tab-content {% if active_tab == 'insights' %}active{% endif %}">
        {% if strategic_insights %}
        <div class="insights-grid">
            {% for insight in strategic_insights %}
            <div class="insight-card {{ insight.type }}">
                <div class="insight-header">
                    <div class="insight-title">
                        {% if insight.type == 'opportunity' %}üåü{% elif insight.type == 'warning' %}‚ö†Ô∏è{% else %}üéØ{% endif %}
                        {{ insight.title }}
                    </div>
                    <div class="insight-count">{{ insight.contacts|length }}</div>
                </div>
                <div class="insight-description">{{ insight.description }}</div>
                <div class="insight-action">
                    <strong>Recommended Action:</strong> {{ insight.action }}
                </div>
                {% if insight.contacts %}
                <div class="insight-contacts">
                    <div class="insight-contacts-title">Top contacts in this segment:</div>
                    <div class="insight-contact-list">
                        {% for c in insight.contacts[:5] %}
                        <a href="/contacts/{{ c.id }}" class="insight-contact-chip" style="text-decoration: none;">
                            {{ c.first_name or '' }} {{ c.last_name or '' }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üí°</div>
            <div class="empty-state-title">No insights yet</div>
            <p>Check back after more data is collected.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab: Trends -->
    <div id="tab-trends" class="tab-content {% if active_tab == 'trends' %}active{% endif %}">
        <div class="trends-card">
            <h3 style="margin-bottom: 20px;">Activity Patterns</h3>
            {% set pattern = trends.activity_pattern %}
            {% set total = trends.total %}

            {% set trend_classes = {'Active (< 7d)': 'active', 'Warm (7-30d)': 'warm', 'Cold (30-90d)': 'cold', 'Stale (> 90d)': 'stale'} %}

            {% for label, count in pattern.items() %}
            {% set pct = (count / total * 100) if total > 0 else 0 %}
            <div class="trend-row">
                <div class="trend-label">{{ label }}</div>
                <div class="trend-bar-container">
                    <div class="trend-bar-fill {{ trend_classes[label] }}" style="width: {{ pct }}%;">
                        {% if pct > 10 %}{{ "%.1f"|format(pct) }}%{% endif %}
                    </div>
                </div>
                <div class="trend-value">{{ count }}</div>
            </div>
            {% endfor %}

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-secondary);">
                Total contacts: {{ total }}
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="dreams-footer">
        DREAMS - Desktop Real Estate Agent Management System
    </footer>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function applyFilters() {
            const stage = document.getElementById('stageFilter').value;
            const heat = document.getElementById('heatFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const params = new URLSearchParams();

            if (stage) params.set('stage', stage);
            if (heat && heat !== '0') params.set('min_heat', heat);
            if (sort && sort !== 'priority') params.set('sort', sort);
            params.set('tab', 'contacts');

            window.location.search = params.toString();
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearch');
        const table = document.getElementById('contactsTable');
        const rows = table.querySelectorAll('tbody tr');
        const visibleCountEl = document.getElementById('visibleCount');

        function doSearch() {
            const query = searchInput.value.toLowerCase().trim();
            clearBtn.classList.toggle('visible', query.length > 0);

            let visibleCount = 0;
            rows.forEach((row, index) => {
                const name = row.querySelector('.contact-name')?.textContent.toLowerCase() || '';
                const email = row.querySelector('.contact-email')?.textContent.toLowerCase() || '';
                const phone = row.cells[13]?.textContent.toLowerCase() || '';

                const matches = name.includes(query) || email.includes(query) || phone.includes(query);
                row.style.display = matches ? '' : 'none';

                if (matches) {
                    visibleCount++;
                    row.querySelector('.row-num').textContent = visibleCount;
                }
            });

            visibleCountEl.textContent = visibleCount;
        }

        function clearSearch() {
            searchInput.value = '';
            clearBtn.classList.remove('visible');
            rows.forEach((row, index) => {
                row.style.display = '';
                row.querySelector('.row-num').textContent = index + 1;
            });
            visibleCountEl.textContent = rows.length;
            searchInput.focus();
        }

        searchInput.addEventListener('input', doSearch);
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') clearSearch();
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        });

        // Smart List slider logic
        // Contact scores for dynamic recounting (all contacts, not just filtered view)
        const allContactScores = {{ contact_scores | tojson }}.map(c => ({
            heat: c.heat_score || 0,
            rel: c.relationship_score || 0,
            stage: c.stage || '',
            days: c.days_since_activity || 999,
            created: c.created_at || ''
        }));

        function daysSinceCreated(createdAt) {
            if (!createdAt) return 999;
            const created = new Date(createdAt);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        }

        function updateSliderPct(slider, pct) {
            slider.style.setProperty('--slider-pct', pct + '%');
        }

        function updateSmartListThresholds() {
            const newDays = parseInt(document.getElementById('slNewDaysSlider').value);
            const hotMin = parseInt(document.getElementById('slHotSlider').value);
            const warmMin = parseInt(document.getElementById('slWarmSlider').value);
            const coolMin = parseInt(document.getElementById('slCoolSlider').value);

            // Update labels
            document.getElementById('slNewDaysLabel').textContent = newDays;
            document.getElementById('slNewDaysVal').textContent = newDays;
            document.getElementById('slHotLabel').textContent = hotMin;
            document.getElementById('slHotVal').textContent = hotMin;
            document.getElementById('slWarmLabel').textContent = warmMin;
            document.getElementById('slWarmVal').textContent = warmMin;
            document.getElementById('slCoolLabel').textContent = coolMin;
            document.getElementById('slCoolVal').textContent = coolMin;

            // Update slider track fills
            updateSliderPct(document.getElementById('slNewDaysSlider'), (newDays / 30) * 100);
            updateSliderPct(document.getElementById('slHotSlider'), hotMin);
            updateSliderPct(document.getElementById('slWarmSlider'), warmMin);
            updateSliderPct(document.getElementById('slCoolSlider'), coolMin);

            // Recount from all contacts
            let newCount = 0, hotCount = 0, warmCount = 0, coolCount = 0;
            for (const c of allContactScores) {
                if (['Trash', 'Closed', 'Past Client', 'DNC', 'Agents/Vendors/Lendors'].includes(c.stage)) continue;
                const createdDays = daysSinceCreated(c.created);
                if (c.stage === 'Lead' && createdDays <= newDays) newCount++;
                if (c.heat >= hotMin) hotCount++;
                if (c.heat >= warmMin && c.heat < hotMin) warmCount++;
                if (c.heat >= coolMin && c.heat < warmMin) coolCount++;
            }

            document.getElementById('slNewCount').textContent = newCount;
            document.getElementById('slHotCount').textContent = hotCount;
            document.getElementById('slWarmCount').textContent = warmCount;
            document.getElementById('slCoolCount').textContent = coolCount;

            // If a filter is active, re-apply it
            applySlFilter();
        }

        // Click a card to filter the contacts table to that list
        let activeSlFilter = null;

        function toggleSlFilter(card, filterKey) {
            const wasActive = card.classList.contains('active');
            // Clear all
            document.querySelectorAll('.sl-card').forEach(c => c.classList.remove('active'));
            if (wasActive) {
                activeSlFilter = null;
                resetSlFilter();
            } else {
                card.classList.add('active');
                activeSlFilter = filterKey;
                applySlFilter();
            }
        }

        function applySlFilter() {
            if (!activeSlFilter) return;
            const newDays = parseInt(document.getElementById('slNewDaysSlider').value);
            const hotMin = parseInt(document.getElementById('slHotSlider').value);
            const warmMin = parseInt(document.getElementById('slWarmSlider').value);
            const coolMin = parseInt(document.getElementById('slCoolSlider').value);

            let visibleCount = 0;
            rows.forEach(row => {
                const heat = parseFloat(row.dataset.heat) || 0;
                const days = parseFloat(row.dataset.days) || 999;
                const stage = row.dataset.stage || '';
                let show = false;

                if (activeSlFilter === 'new_leads') {
                    show = stage === 'Lead' && days <= newDays;
                } else if (activeSlFilter === 'hot') {
                    show = heat >= hotMin;
                } else if (activeSlFilter === 'warm') {
                    show = heat >= warmMin && heat < hotMin;
                } else if (activeSlFilter === 'cool') {
                    show = heat >= coolMin && heat < warmMin;
                }

                row.style.display = show ? '' : 'none';
                if (show) {
                    visibleCount++;
                    row.querySelector('.row-num').textContent = visibleCount;
                }
            });
            visibleCountEl.textContent = visibleCount;
        }

        function resetSlFilter() {
            let visibleCount = 0;
            rows.forEach((row, index) => {
                row.style.display = '';
                visibleCount++;
                row.querySelector('.row-num').textContent = visibleCount;
            });
            visibleCountEl.textContent = visibleCount;
        }

        // Initialize slider tracks
        updateSmartListThresholds();

        // Column sorting
        let currentSort = { column: null, direction: null };
        let originalOrder = Array.from(rows);

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => sortTable(th));
        });

        function sortTable(th) {
            const column = th.dataset.sort;
            const isNumeric = th.dataset.type === 'number';
            const tbody = table.querySelector('tbody');
            let rowsArray = Array.from(rows);

            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = null;
                    currentSort.column = null;
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            if (currentSort.direction) {
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            if (!currentSort.direction) {
                rowsArray = [...originalOrder];
            } else {
                const colIndex = Array.from(th.parentElement.children).indexOf(th);

                rowsArray.sort((a, b) => {
                    let valA, valB;

                    switch(column) {
                        case 'name':
                            valA = a.querySelector('.contact-name')?.textContent.trim().toLowerCase() || '';
                            valB = b.querySelector('.contact-name')?.textContent.trim().toLowerCase() || '';
                            break;
                        case 'stage':
                            valA = a.querySelector('.dreams-badge')?.textContent.trim().toLowerCase() || '';
                            valB = b.querySelector('.dreams-badge')?.textContent.trim().toLowerCase() || '';
                            break;
                        case 'heat':
                            valA = parseFloat(a.dataset.heat) || 0;
                            valB = parseFloat(b.dataset.heat) || 0;
                            break;
                        case 'value':
                            valA = parseFloat(a.dataset.value) || 0;
                            valB = parseFloat(b.dataset.value) || 0;
                            break;
                        case 'activity':
                            valA = parseInt(a.dataset.days) || 999;
                            valB = parseInt(b.dataset.days) || 999;
                            break;
                        case 'trend':
                            const trendOrder = { 'warming': 3, 'stable': 2, 'cooling': 1, 'none': 0 };
                            valA = trendOrder[a.querySelector('.trend-indicator')?.classList[1]] || 0;
                            valB = trendOrder[b.querySelector('.trend-indicator')?.classList[1]] || 0;
                            break;
                        default:
                            valA = a.children[colIndex]?.textContent?.trim() || '';
                            valB = b.children[colIndex]?.textContent?.trim() || '';
                            if (isNumeric) {
                                valA = parseFloat(valA.replace(/[$,]/g, '')) || 0;
                                valB = parseFloat(valB.replace(/[$,]/g, '')) || 0;
                            }
                    }

                    if (typeof valA === 'string') {
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }

            rowsArray.forEach((row, index) => {
                row.querySelector('.row-num').textContent = index + 1;
                tbody.appendChild(row);
            });
        }
    </script>
    </div>
</body>
</html>
