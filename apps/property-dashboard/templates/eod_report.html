<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Day Report | DREAMS</title>
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <style>
        /* ========== RESET & BASE ========== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page, #f8fafc);
            color: var(--text-primary, #1a1a1a);
            min-height: 100vh;
        }

        /* ========== TOP BAR ========== */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 32px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        .topbar-date {
            font-size: 13px;
            color: var(--text-secondary, #64748b);
        }

        /* ========== LAYOUT ========== */
        .eod-content {
            padding: 28px 32px;
            max-width: 960px;
        }

        /* ========== SECTION ========== */
        .eod-section {
            margin-bottom: 28px;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: white;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover { background: #f8fafc; }
        .section-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; flex-shrink: 0;
        }
        .section-title {
            font-size: 16px; font-weight: 700;
            flex: 1;
        }
        .section-subtitle {
            font-size: 12px; color: var(--text-secondary, #64748b);
            margin-top: 2px;
        }
        .collapse-chevron {
            font-size: 12px;
            color: #94a3b8;
            transition: transform 0.2s;
        }
        .section-header.collapsed .collapse-chevron {
            transform: rotate(-90deg);
        }
        .collapsible-body {
            background: white;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            max-height: 2000px;
            opacity: 1;
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }
        .collapsible-body.collapsed {
            max-height: 0;
            opacity: 0;
        }
        .section-inner {
            padding: 20px;
        }

        /* ========== STAT GRID ========== */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.1;
        }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary, #64748b);
            margin-top: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========== DISPOSITION BAR ========== */
        .disposition-bar {
            display: flex;
            height: 28px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .disposition-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            min-width: 40px;
            transition: flex-grow 0.3s;
        }
        .disposition-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary, #64748b);
        }
        .legend-dot {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 3px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .disp-called { background: #22c55e; }
        .disp-left_vm { background: #f59e0b; }
        .disp-texted { background: #3b82f6; }
        .disp-appointment { background: #8b5cf6; }
        .disp-skipped { background: #94a3b8; }
        .disp-no_answer { background: #ef4444; }

        /* ========== CONTACT CARDS ========== */
        .contact-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .contact-row:last-child { border-bottom: none; }
        .contact-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            text-decoration: none;
        }
        .contact-name:hover { color: #2563eb; text-decoration: underline; }
        .contact-meta {
            font-size: 12px;
            color: var(--text-secondary, #64748b);
            margin-left: auto;
        }

        /* ========== BADGES ========== */
        .delta-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }
        .delta-up { background: #dcfce7; color: #16a34a; }
        .delta-down { background: #fee2e2; color: #dc2626; }
        .priority-badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            background: #fef3c7;
            color: #92400e;
        }
        .heat-badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            background: #fee2e2;
            color: #dc2626;
        }

        /* ========== ACCOUNTABILITY (RED TINT) ========== */
        .gap-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #fef2f2;
            border-radius: 10px;
            border-left: 3px solid #ef4444;
            margin-bottom: 8px;
        }
        .gap-card:last-child { margin-bottom: 0; }

        /* ========== INTENT CARD ========== */
        .intent-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: #fffbeb;
            border-radius: 10px;
            border-left: 3px solid #f59e0b;
            margin-bottom: 8px;
        }
        .intent-card:last-child { margin-bottom: 0; }
        .intent-type {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #92400e;
        }
        .intent-property {
            font-size: 13px;
            color: var(--text-secondary, #64748b);
        }

        /* ========== TOMORROW CARD ========== */
        .tomorrow-card {
            padding: 14px 16px;
            background: #f0f9ff;
            border-radius: 10px;
            border-left: 3px solid #2563eb;
            margin-bottom: 8px;
        }
        .tomorrow-card:last-child { margin-bottom: 0; }
        .tomorrow-briefing {
            font-size: 13px;
            color: var(--text-secondary, #64748b);
            margin-top: 4px;
        }

        /* ========== WEEK TREND ========== */
        .week-trend {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 10px;
            margin-top: 16px;
        }
        .trend-arrow {
            font-size: 24px;
            font-weight: 800;
        }
        .trend-up { color: #16a34a; }
        .trend-down { color: #dc2626; }
        .trend-flat { color: #64748b; }
        .trend-text {
            font-size: 14px;
            color: var(--text-primary);
        }
        .trend-text strong {
            font-size: 18px;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            padding: 24px;
            text-align: center;
            color: var(--text-secondary, #64748b);
            font-size: 14px;
            font-style: italic;
        }

        /* ========== PIPELINE ITEMS ========== */
        .pipeline-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .pipeline-item:last-child { border-bottom: none; }

        /* ========== SECTION COLORS ========== */
        .icon-work { background: #dbeafe; color: #2563eb; }
        .icon-movers { background: #fef3c7; color: #d97706; }
        .icon-leads { background: #e0e7ff; color: #4f46e5; }
        .icon-gaps { background: #fee2e2; color: #dc2626; }
        .icon-tomorrow { background: #dcfce7; color: #16a34a; }
    </style>
{% set active_nav = 'eod' %}
</head>
<body>
{% include 'partials/sidebar.html' %}
<div class="main-content">

    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
        <div>
            <div class="topbar-title">End of Day Report</div>
            <div class="topbar-date">{{ refresh_time }}</div>
        </div>
    </div>

    <div class="eod-content">

        <!-- ===== SECTION 1: DID I DO THE WORK? ===== -->
        <div class="eod-section">
            <div class="section-header" onclick="toggleCollapse(this)">
                <div class="section-icon icon-work">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.11 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                </div>
                <div>
                    <div class="section-title">Did I Do the Work?</div>
                    <div class="section-subtitle">Today's calling and outreach activity</div>
                </div>
                <span class="collapse-chevron">&#9660;</span>
            </div>
            <div class="collapsible-body">
                <div class="section-inner">
                    {% if narrative.empty_states and narrative.empty_states.call_stats %}
                        <div class="empty-state">{{ narrative.empty_states.call_stats }}</div>
                    {% else %}
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.calls_attempted }}</div>
                                <div class="stat-label">Calls</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.calls_reached }}</div>
                                <div class="stat-label">Reached</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.voicemails }}</div>
                                <div class="stat-label">VMs</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.texts_sent }}</div>
                                <div class="stat-label">Texts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.appointments }}</div>
                                <div class="stat-label">Appts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ eod.call_stats.selling_time_minutes }}m</div>
                                <div class="stat-label">Selling Time</div>
                            </div>
                        </div>

                        <!-- Disposition breakdown bar -->
                        {% if eod.disposition_breakdown %}
                            {% set total_disps = eod.disposition_breakdown | sum(attribute='count') %}
                            {% if total_disps > 0 %}
                                <div class="disposition-bar">
                                    {% for d in eod.disposition_breakdown %}
                                        <div class="disposition-segment disp-{{ d.disposition }}"
                                             style="flex-grow: {{ d.count }};"
                                             title="{{ narrative.disposition_labels.get(d.disposition, d.disposition) | default(d.disposition) }}: {{ d.count }}">
                                            {{ d.count }}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="disposition-legend">
                                    {% for d in eod.disposition_breakdown %}
                                        <span><span class="legend-dot disp-{{ d.disposition }}"></span>{{ narrative.disposition_labels.get(d.disposition, d.disposition) | default(d.disposition) }} ({{ d.count }})</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% elif narrative.empty_states and narrative.empty_states.disposition_breakdown %}
                            <div class="empty-state">{{ narrative.empty_states.disposition_breakdown }}</div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== SECTION 2: WHAT MOVED TODAY? ===== -->
        <div class="eod-section">
            <div class="section-header" onclick="toggleCollapse(this)">
                <div class="section-icon icon-movers">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                </div>
                <div>
                    <div class="section-title">What Moved Today?</div>
                    <div class="section-subtitle">Score changes and pipeline status</div>
                </div>
                <span class="collapse-chevron">&#9660;</span>
            </div>
            <div class="collapsible-body">
                <div class="section-inner">
                    {% if narrative.empty_states and narrative.empty_states.score_movers %}
                        <div class="empty-state">{{ narrative.empty_states.score_movers }}</div>
                    {% else %}
                        {% if narrative.warming %}
                            <h4 style="font-size:13px; color:#16a34a; font-weight:700; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Warming Up</h4>
                            {% for m in narrative.warming %}
                                <div class="contact-row">
                                    <a href="/contacts/{{ m.id }}" class="contact-name">{{ m.name }}</a>
                                    <span class="delta-badge delta-up">+{{ m.delta }} ↑</span>
                                    <span class="contact-meta">Heat: {{ m.heat_score }}</span>
                                </div>
                            {% endfor %}
                        {% endif %}
                        {% if narrative.cooling %}
                            <h4 style="font-size:13px; color:#dc2626; font-weight:700; margin: 16px 0 8px; text-transform:uppercase; letter-spacing:0.5px;">Cooling Down</h4>
                            {% for m in narrative.cooling %}
                                <div class="contact-row">
                                    <a href="/contacts/{{ m.id }}" class="contact-name">{{ m.name }}</a>
                                    <span class="delta-badge delta-down">-{{ m.delta }} ↓</span>
                                    <span class="contact-meta">Heat: {{ m.heat_score }}</span>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}

                    <!-- Pipeline snapshot -->
                    {% if eod.pipeline %}
                        <h4 style="font-size:13px; color:#64748b; font-weight:700; margin: 20px 0 8px; text-transform:uppercase; letter-spacing:0.5px;">Pipeline Snapshot</h4>
                        {% if eod.pipeline.pending_offers %}
                            {% for offer in eod.pipeline.pending_offers %}
                                <div class="pipeline-item">
                                    <span style="font-weight:600;">{{ offer.first_name }} {{ offer.last_name }}</span>
                                    <span style="color:#64748b; font-size:13px;">{{ offer.stage }}</span>
                                    {% if offer.max_price %}
                                        <span style="margin-left:auto; font-weight:700; color:#16a34a;">${{ '{:,.0f}'.format(offer.max_price) }}</span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="font-size:13px; color:#64748b; padding:8px 0;">No pending offers</div>
                        {% endif %}
                        <div style="display:flex; gap:20px; margin-top:12px; font-size:13px; color:#64748b;">
                            <span>Pipeline Value: <strong style="color:var(--text-primary);">${{ '{:,.0f}'.format(eod.pipeline.total_pipeline_value) }}</strong></span>
                            <span>Active Pursuits: <strong style="color:var(--text-primary);">{{ eod.pipeline.active_pursuits }}</strong></span>
                            <span>Need Properties: <strong style="color:var(--text-primary);">{{ eod.pipeline.buyers_needing_properties }}</strong></span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== SECTION 3: WHAT ARE MY LEADS DOING? ===== -->
        <div class="eod-section">
            <div class="section-header" onclick="toggleCollapse(this)">
                <div class="section-icon icon-leads">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </div>
                <div>
                    <div class="section-title">What Are My Leads Doing?</div>
                    <div class="section-subtitle">Property views, favorites, and shares</div>
                </div>
                <span class="collapse-chevron">&#9660;</span>
            </div>
            <div class="collapsible-body">
                <div class="section-inner">
                    <!-- Property views -->
                    {% if eod.property_activity %}
                        <h4 style="font-size:13px; color:#4f46e5; font-weight:700; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Property Views</h4>
                        {% for p in eod.property_activity %}
                            <div class="contact-row">
                                <a href="/contacts/{{ p.id }}" class="contact-name">{{ p.name }}</a>
                                <span class="contact-meta">{{ p.view_count }} view{{ 's' if p.view_count != 1 }}</span>
                            </div>
                        {% endfor %}
                    {% elif narrative.empty_states and narrative.empty_states.property_activity %}
                        <div class="empty-state">{{ narrative.empty_states.property_activity }}</div>
                    {% endif %}

                    <!-- High-intent signals -->
                    {% if eod.high_intent %}
                        <h4 style="font-size:13px; color:#d97706; font-weight:700; margin: 16px 0 8px; text-transform:uppercase; letter-spacing:0.5px;">High-Intent Signals</h4>
                        {% for h in eod.high_intent %}
                            <div class="intent-card">
                                <div>
                                    <a href="/contacts/{{ h.id }}" class="contact-name">{{ h.name }}</a>
                                    <span class="intent-type" style="margin-left:8px;">{{ 'Favorited' if h.event_type == 'property_favorite' else 'Shared' }}</span>
                                    <div class="intent-property">
                                        {{ h.property_address or 'Unknown property' }}
                                        {% if h.property_price %} &mdash; ${{ '{:,.0f}'.format(h.property_price) }}{% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% elif narrative.empty_states and narrative.empty_states.high_intent %}
                        <div class="empty-state">{{ narrative.empty_states.high_intent }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== SECTION 4: WHAT FELL THROUGH THE CRACKS? ===== -->
        <div class="eod-section">
            <div class="section-header" onclick="toggleCollapse(this)">
                <div class="section-icon icon-gaps">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                </div>
                <div>
                    <div class="section-title">What Fell Through the Cracks?</div>
                    <div class="section-subtitle">High-priority contacts not reached today</div>
                </div>
                <span class="collapse-chevron">&#9660;</span>
            </div>
            <div class="collapsible-body">
                <div class="section-inner">
                    {% if eod.accountability_gaps %}
                        {% for g in eod.accountability_gaps %}
                            <div class="gap-card">
                                <a href="/contacts/{{ g.id }}" class="contact-name">{{ g.first_name }} {{ g.last_name }}</a>
                                <span class="priority-badge">Priority: {{ g.priority_score }}</span>
                                <span class="heat-badge">Heat: {{ g.heat_score }}</span>
                            </div>
                        {% endfor %}
                    {% elif narrative.empty_states and narrative.empty_states.accountability_gaps %}
                        <div class="empty-state">{{ narrative.empty_states.accountability_gaps }}</div>
                    {% else %}
                        <div class="empty-state">All high-priority contacts reached — nice work!</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== SECTION 5: TOMORROW'S SETUP ===== -->
        <div class="eod-section">
            <div class="section-header" onclick="toggleCollapse(this)">
                <div class="section-icon icon-tomorrow">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div>
                    <div class="section-title">Tomorrow's Setup</div>
                    <div class="section-subtitle">Top priorities and weekly momentum</div>
                </div>
                <span class="collapse-chevron">&#9660;</span>
            </div>
            <div class="collapsible-body">
                <div class="section-inner">
                    {% if narrative.tomorrow_briefings %}
                        <h4 style="font-size:13px; color:#16a34a; font-weight:700; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Top 5 for Tomorrow</h4>
                        {% for c in narrative.tomorrow_briefings %}
                            <div class="tomorrow-card">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <a href="/contacts/{{ c.id }}" class="contact-name">{{ c.first_name }} {{ c.last_name }}</a>
                                    <span class="priority-badge">P{{ c.priority_score }}</span>
                                    {% if c.heat_score %}<span class="heat-badge">H{{ c.heat_score }}</span>{% endif %}
                                </div>
                                {% if c.briefing and c.briefing.text %}
                                    <div class="tomorrow-briefing">{{ c.briefing.text }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">No priority contacts queued — check your call list</div>
                    {% endif %}

                    <!-- Week-over-week trend -->
                    {% if eod.week_trend %}
                        <div class="week-trend">
                            <span class="trend-arrow trend-{{ narrative.week_trend_direction or 'flat' }}">{{ narrative.week_trend_arrow or '→' }}</span>
                            <div class="trend-text">
                                <strong>{{ eod.week_trend.this_week }}</strong> contacts this week
                                vs <strong>{{ eod.week_trend.last_week }}</strong> last week
                                {% if narrative.week_trend_pct and narrative.week_trend_pct != 0 %}
                                    <span style="font-weight:700; color:{{ '#16a34a' if narrative.week_trend_pct > 0 else '#dc2626' }};">
                                        ({{ '+' if narrative.week_trend_pct > 0 }}{{ narrative.week_trend_pct }}%)
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div><!-- /eod-content -->
</div><!-- /main-content -->

<script>
    function toggleCollapse(header) {
        header.classList.toggle('collapsed');
        const body = header.nextElementSibling;
        if (body && body.classList.contains('collapsible-body')) {
            body.classList.toggle('collapsed');
        }
    }
</script>
</body>
</html>
