<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLS Listings - DREAMS</title>
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <style>
        :root {
            --card-radius: 10px;
            --photo-width: 280px;
        }

        /* Compact Stats Bar */
        .stats-bar {
            display: flex;
            gap: 24px;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stat-item.success .stat-value { color: #10b981; }
        .stat-item.warning .stat-value { color: #f59e0b; }

        /* Filters Row */
        .filters-row {
            display: flex;
            gap: 12px;
            align-items: center;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }

        .filters-row select,
        .filters-row input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            min-width: 120px;
        }

        .filters-row .filter-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        .filters-row .filter-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .view-tab {
            padding: 8px 14px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            background: #f3f4f6;
            transition: all 0.2s;
        }

        .view-tab:hover { background: #e5e7eb; }
        .view-tab.active {
            background: var(--primary-dark);
            color: white;
        }

        .view-tab .count {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 4px;
        }

        /* MLS Property Cards */
        .listings-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .property-card {
            display: flex;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .property-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        /* Photo Section */
        .property-photo {
            width: var(--photo-width);
            min-width: var(--photo-width);
            height: 200px;
            position: relative;
            background: #f3f4f6;
        }

        .property-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-photo .photo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(0,0,0,0.7);
            color: white;
        }

        .property-photo .mls-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            background: var(--primary-dark);
            color: white;
        }

        /* Property Details */
        .property-details {
            flex: 1;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .property-price {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .property-dom {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .property-address {
            font-size: 15px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .property-location {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        /* Property Specs Grid */
        .property-specs {
            display: flex;
            gap: 20px;
            padding: 10px 0;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }

        .spec-item {
            text-align: center;
        }

        .spec-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .spec-label {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
        }

        /* Geospatial Section */
        .geo-section {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .geo-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4b5563;
        }

        .geo-item .geo-icon {
            font-size: 14px;
        }

        .geo-item .geo-value {
            font-weight: 600;
        }

        .geo-item.good .geo-value { color: #10b981; }
        .geo-item.warning .geo-value { color: #f59e0b; }
        .geo-item.danger .geo-value { color: #ef4444; }

        /* Agent Info */
        .agent-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .agent-info {
            font-size: 12px;
            color: #6b7280;
        }

        .agent-info strong {
            color: #374151;
        }

        .property-actions {
            display: flex;
            gap: 8px;
        }

        .property-actions a {
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .property-actions a:hover { opacity: 0.85; }

        .btn-primary-sm {
            background: var(--primary-dark);
            color: white;
        }

        .btn-secondary-sm {
            background: #e5e7eb;
            color: #374151;
        }

        /* Review Actions */
        .review-actions {
            display: flex;
            gap: 6px;
        }

        .review-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-approve { background: #10b981; color: white; }
        .btn-reject { background: #ef4444; color: white; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 24px;
        }

        .pagination a, .pagination span {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            text-decoration: none;
        }

        .pagination a {
            background: white;
            color: var(--primary-dark);
            border: 1px solid #d1d5db;
        }

        .pagination a:hover { background: #f3f4f6; }
        .pagination .current {
            background: var(--primary-dark);
            color: white;
        }

        /* Results count */
        .results-info {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .results-info strong {
            color: var(--primary-dark);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: var(--card-radius);
        }

        .empty-state h3 { color: var(--primary-dark); margin-bottom: 8px; }

        /* Responsive */
        @media (max-width: 768px) {
            .property-card {
                flex-direction: column;
            }
            .property-photo {
                width: 100%;
                height: 200px;
            }
            .stats-bar { gap: 16px; }
            .filters-row { flex-direction: column; align-items: stretch; }
            .view-tabs { margin-left: 0; width: 100%; }
        }
    </style>
{% set active_nav = 'properties' %}
</head>
<body>
    {% include 'partials/sidebar.html' %}
    <div class="main-content">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>MLS Listings</h1>
                <span class="env-badge {{ dreams_env }}">{{ dreams_env }}</span>
            </div>
        </header>

        <!-- Compact Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value">{{ stats.total_active }}</span>
                <span class="stat-label">Active</span>
            </div>
            <div class="stat-item success">
                <span class="stat-value">{{ stats.with_photos }}</span>
                <span class="stat-label">With Photos</span>
            </div>
            <div class="stat-item success">
                <span class="stat-value">{{ stats.verified }}</span>
                <span class="stat-label">Verified</span>
            </div>
            {% if stats.pending_review > 0 %}
            <div class="stat-item warning">
                <span class="stat-value">{{ stats.pending_review }}</span>
                <span class="stat-label">Pending</span>
            </div>
            {% endif %}
            <div style="margin-left: auto; font-size: 12px; color: #6b7280;">
                Sources: {% for src, cnt in stats.source_breakdown.items() %}{{ src }}({{ cnt }}){% if not loop.last %}, {% endif %}{% endfor %}
            </div>
        </div>

        <!-- Filters Row -->
        <form class="filters-row" method="get">
            <input type="hidden" name="view" value="{{ view }}">

            <div class="filter-group">
                <span class="filter-label">County</span>
                <select name="county" onchange="this.form.submit()">
                    <option value="">All Counties</option>
                    {% for c in counties %}
                    <option value="{{ c }}" {% if c == selected_county %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <span class="filter-label">Min Price</span>
                <input type="number" name="min_price" value="{{ min_price }}" placeholder="$0" step="10000">
            </div>

            <div class="filter-group">
                <span class="filter-label">Max Price</span>
                <input type="number" name="max_price" value="{{ max_price }}" placeholder="No max" step="10000">
            </div>

            <div class="filter-group">
                <span class="filter-label">Sort By</span>
                <select name="sort" onchange="this.form.submit()">
                    <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                    <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                    <option value="beds" {% if sort_by == 'beds' %}selected{% endif %}>Bedrooms</option>
                    <option value="acreage" {% if sort_by == 'acreage' %}selected{% endif %}>Acreage</option>
                    <option value="elevation" {% if sort_by == 'elevation' %}selected{% endif %}>Elevation</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">Apply</button>
            <a href="/photos?view={{ view }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">Reset</a>

            <div class="view-tabs">
                <a href="/photos?view=verified&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}"
                   class="view-tab {% if view == 'verified' %}active{% endif %}">Verified<span class="count">{{ stats.verified }}</span></a>
                <a href="/photos?view=pending&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}"
                   class="view-tab {% if view == 'pending' %}active{% endif %}">Pending<span class="count">{{ stats.pending_review }}</span></a>
                <a href="/photos?view=all&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}"
                   class="view-tab {% if view == 'all' %}active{% endif %}">All<span class="count">{{ stats.with_photos }}</span></a>
            </div>
        </form>

        <!-- Results Info -->
        <div class="results-info">
            Showing <strong>{{ listings|length }}</strong> of <strong>{{ total_count }}</strong> listings
            {% if selected_county %} in <strong>{{ selected_county }} County</strong>{% endif %}
        </div>

        <!-- Listings -->
        {% if listings %}
        <div class="listings-container">
            {% for listing in listings %}
            <div class="property-card" id="card-{{ listing.id }}">
                <!-- Photo -->
                <div class="property-photo">
                    <img src="{{ listing.primary_photo }}" alt="{{ listing.address }}" loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22280%22 height=%22200%22><rect fill=%22%23f3f4f6%22 width=%22100%%22 height=%22100%%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2214%22>No Photo</text></svg>'">
                    {% if listing.photo_source %}
                    <span class="photo-badge">{{ listing.photo_source }}</span>
                    {% endif %}
                    {% if listing.mls_number %}
                    <span class="mls-badge">MLS# {{ listing.mls_number }}</span>
                    {% endif %}
                </div>

                <!-- Details -->
                <div class="property-details">
                    <div class="property-header">
                        <span class="property-price">${{ "{:,.0f}".format(listing.list_price or 0) }}</span>
                        {% if listing.days_on_market %}
                        <span class="property-dom">{{ listing.days_on_market }} days</span>
                        {% endif %}
                    </div>

                    <div class="property-address">{{ listing.address }}</div>
                    <div class="property-location">
                        {{ listing.city }}{% if listing.county %}, {{ listing.county }} County{% endif %}{% if listing.zip %} {{ listing.zip }}{% endif %}
                    </div>

                    <!-- Specs -->
                    <div class="property-specs">
                        {% if listing.beds %}
                        <div class="spec-item">
                            <div class="spec-value">{{ listing.beds }}</div>
                            <div class="spec-label">Beds</div>
                        </div>
                        {% endif %}
                        {% if listing.baths %}
                        <div class="spec-item">
                            <div class="spec-value">{{ listing.baths }}</div>
                            <div class="spec-label">Baths</div>
                        </div>
                        {% endif %}
                        {% if listing.sqft %}
                        <div class="spec-item">
                            <div class="spec-value">{{ "{:,.0f}".format(listing.sqft) }}</div>
                            <div class="spec-label">Sq Ft</div>
                        </div>
                        {% endif %}
                        {% if listing.acreage %}
                        <div class="spec-item">
                            <div class="spec-value">{{ "%.2f"|format(listing.acreage) }}</div>
                            <div class="spec-label">Acres</div>
                        </div>
                        {% endif %}
                        {% if listing.year_built %}
                        <div class="spec-item">
                            <div class="spec-value">{{ listing.year_built }}</div>
                            <div class="spec-label">Built</div>
                        </div>
                        {% endif %}
                        {% if listing.hoa_fee %}
                        <div class="spec-item">
                            <div class="spec-value">${{ listing.hoa_fee }}</div>
                            <div class="spec-label">HOA</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Geospatial Data -->
                    <div class="geo-section">
                        {% if listing.elevation_feet %}
                        <div class="geo-item">
                            <span class="geo-icon">&#9968;</span>
                            <span>Elevation: <span class="geo-value">{{ "{:,}".format(listing.elevation_feet) }} ft</span></span>
                        </div>
                        {% endif %}
                        {% if listing.flood_zone %}
                        <div class="geo-item {% if listing.flood_zone == 'X' %}good{% elif listing.flood_zone in ['A', 'AE', 'VE'] %}danger{% else %}warning{% endif %}">
                            <span class="geo-icon">&#127754;</span>
                            <span>Flood: <span class="geo-value">{{ listing.flood_zone }}{% if listing.flood_factor %} ({{ listing.flood_factor }}/10){% endif %}</span></span>
                        </div>
                        {% endif %}
                        {% if listing.view_potential %}
                        <div class="geo-item {% if listing.view_potential >= 7 %}good{% elif listing.view_potential >= 4 %}warning{% endif %}">
                            <span class="geo-icon">&#127956;</span>
                            <span>View: <span class="geo-value">{{ listing.view_potential }}/10</span></span>
                        </div>
                        {% endif %}
                        {% if listing.slope_percent %}
                        <div class="geo-item {% if listing.slope_percent < 15 %}good{% elif listing.slope_percent < 30 %}warning{% else %}danger{% endif %}">
                            <span class="geo-icon">&#9650;</span>
                            <span>Slope: <span class="geo-value">{{ "%.0f"|format(listing.slope_percent) }}%</span></span>
                        </div>
                        {% endif %}
                        {% if listing.aspect %}
                        <div class="geo-item">
                            <span class="geo-icon">&#9678;</span>
                            <span>Aspect: <span class="geo-value">{{ listing.aspect }}</span></span>
                        </div>
                        {% endif %}
                        {% if listing.wildfire_risk %}
                        <div class="geo-item {% if listing.wildfire_risk == 'Low' %}good{% elif listing.wildfire_risk == 'Moderate' %}warning{% else %}danger{% endif %}">
                            <span class="geo-icon">&#128293;</span>
                            <span>Fire: <span class="geo-value">{{ listing.wildfire_risk }}</span></span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Agent & Actions -->
                    <div class="agent-section">
                        <div class="agent-info">
                            {% if listing.listing_agent_name %}
                            <strong>{{ listing.listing_agent_name }}</strong>
                            {% if listing.listing_agent_phone %} &bull; {{ listing.listing_agent_phone }}{% endif %}
                            {% if listing.listing_office_name %}<br>{{ listing.listing_office_name }}{% endif %}
                            {% endif %}
                        </div>

                        {% if view == 'pending' %}
                        <div class="review-actions">
                            <button class="btn-approve" onclick="approvePhoto('{{ listing.id }}')">Approve</button>
                            <button class="btn-reject" onclick="rejectPhoto('{{ listing.id }}')">Reject</button>
                        </div>
                        {% else %}
                        <div class="property-actions">
                            {% if listing.redfin_url %}
                            <a href="{{ listing.redfin_url }}" target="_blank" class="btn-secondary-sm">Redfin</a>
                            {% endif %}
                            {% if listing.idx_url %}
                            <a href="{{ listing.idx_url }}" target="_blank" class="btn-secondary-sm">Realtor</a>
                            {% endif %}
                            {% if listing.latitude and listing.longitude %}
                            <a href="https://www.google.com/maps?q={{ listing.latitude }},{{ listing.longitude }}" target="_blank" class="btn-secondary-sm">Map</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No listings found</h3>
            <p>
                {% if view == 'pending' %}No photos pending review.
                {% elif selected_county %}Try a different county or <a href="/photos?view={{ view }}">reset filters</a>.
                {% else %}No listings with photos match your criteria.{% endif %}
            </p>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="?view={{ view }}&page={{ page - 1 }}&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}">Prev</a>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <span class="current">{{ p }}</span>
                {% elif p <= 2 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                <a href="?view={{ view }}&page={{ p }}&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}">{{ p }}</a>
                {% elif p == 3 or p == total_pages - 2 %}
                <span>...</span>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?view={{ view }}&page={{ page + 1 }}&county={{ selected_county }}&min_price={{ min_price }}&max_price={{ max_price }}&sort={{ sort_by }}">Next</a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        function approvePhoto(listingId) {
            fetch(`/api/photos/${listingId}/approve`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`card-${listingId}`).remove();
                    }
                });
        }

        function rejectPhoto(listingId) {
            if (!confirm('Reject this photo?')) return;
            fetch(`/api/photos/${listingId}/reject`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`card-${listingId}`).remove();
                    }
                });
        }
    </script>
    </div>
</body>
</html>
