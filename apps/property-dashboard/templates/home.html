<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMS Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <!-- Shared Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <!-- Page-specific styles -->
    <style>
        /* ========== VARIABLES ========== */
        :root {
            --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
            --card-radius: 12px;
        }

        /* ========== METRICS DROPDOWN ========== */
        .metrics-dropdown {
            position: relative;
            display: inline-block;
        }

        .metrics-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .metrics-btn:hover {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transform: translateY(-1px);
        }

        .metrics-btn .arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .metrics-dropdown:hover .arrow {
            transform: rotate(180deg);
        }

        .metrics-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            padding-top: 8px;
            z-index: 100;
        }

        .metrics-menu-inner {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 200px;
            overflow: hidden;
        }

        .metrics-dropdown:hover .metrics-menu {
            display: block;
        }

        .metrics-menu-inner a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background 0.2s;
        }

        .metrics-menu-inner a:hover {
            background: var(--bg-secondary);
        }

        .metrics-menu-inner .menu-icon {
            font-size: 18px;
        }

        .metrics-menu-inner .menu-text {
            flex: 1;
        }

        .metrics-menu-inner .menu-label {
            font-weight: 500;
        }

        .metrics-menu-inner .menu-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .metrics-menu-inner .metrics-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* ========== SECTION 2: PRIORITY ACTIONS ========== */
        .priority-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px;
        }

        .action-column {
            background: white;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .action-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-secondary);
        }

        .action-column-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-column-count {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .action-icon.call { background: #dbeafe; }
        .action-icon.follow-up { background: #fef3c7; }
        .action-icon.send { background: #dcfce7; }

        .action-content {
            flex: 1;
            min-width: 0;
        }

        .action-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-name a {
            color: inherit;
            text-decoration: none;
        }

        .action-name a:hover {
            color: var(--primary);
        }

        .action-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .action-contact-links {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .action-contact-links a {
            font-size: 11px;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .action-contact-links a:hover {
            color: var(--primary);
        }

        .action-score {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: #fef2f2;
            color: #dc2626;
        }

        .action-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ========== SECTION 1: PIPELINE SNAPSHOT (TOP) ========== */
        .pipeline-section {
            margin: 20px 20px 20px 20px;
            background: white;
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
        }

        .pipeline-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Dual-input funnel layout */
        .pipeline-dual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Left side: Two parallel tracks (People + Properties) */
        .pipeline-inputs {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* People track: Leads -> Buyers */
        .pipeline-people {
            display: flex;
            align-items: center;
        }

        /* Properties track */
        .pipeline-properties {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        /* Convergence zone - the merge arrows */
        .pipeline-converge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            position: relative;
            min-width: 50px;
        }

        .converge-arrows {
            position: relative;
            width: 50px;
            height: 100px;
        }

        .converge-arrow-top,
        .converge-arrow-bottom {
            position: absolute;
            width: 45px;
            height: 2px;
            background: #9ca3af;
            right: 0;
        }

        .converge-arrow-top {
            top: 25px;
            transform: rotate(25deg);
            transform-origin: right center;
        }

        .converge-arrow-bottom {
            bottom: 25px;
            transform: rotate(-25deg);
            transform-origin: right center;
        }

        .converge-arrow-top::after,
        .converge-arrow-bottom::after {
            content: '';
            position: absolute;
            right: -2px;
            top: -4px;
            border: 5px solid transparent;
            border-left-color: #9ca3af;
        }

        /* Right side: Pursuits -> Contracts */
        .pipeline-outputs {
            display: flex;
            align-items: center;
        }

        /* Arrow to contracts */
        .pipeline-to-contracts {
            font-size: 24px;
            color: #9ca3af;
            padding: 0 12px;
        }

        /* Stage card styling - standardized boxes */
        .pipeline-stage {
            text-align: center;
            padding: 12px 32px;
            background: var(--bg-secondary);
            border-radius: 8px;
            min-width: 200px;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            text-decoration: none;
            color: inherit;
        }

        .pipeline-stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pipeline-stage.leads { background: #fee2e2; }       /* Red - new/cold */
        .pipeline-stage.buyers { background: #fef3c7; }      /* Yellow - qualifying */
        .pipeline-stage.properties { background: #f3e8ff; }  /* Purple - inventory */
        .pipeline-stage.pursuits { background: #dbeafe; }    /* Blue - active search */
        .pipeline-stage.contracts { background: #dcfce7; }   /* Green - closing */

        .pipeline-stage-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .pipeline-stage-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .pipeline-stage-delta {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .pipeline-stage-delta.positive { color: #16a34a; }
        .pipeline-stage-delta.negative { color: #dc2626; }

        .pipeline-arrow {
            font-size: 24px;
            color: #9ca3af;
            padding: 0 12px;
        }

        /* Track labels */
        .track-label {
            font-size: 10px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .pipeline-track {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pipeline-track-row {
            display: flex;
            align-items: center;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .pipeline-dual {
                flex-direction: column;
                gap: 16px;
            }
            .pipeline-inputs {
                flex-direction: column;
                gap: 16px;
            }
            .pipeline-properties {
                justify-content: center;
            }
            .converge-arrows {
                display: none;
            }
            .pipeline-converge {
                padding: 8px 0;
            }
            .pipeline-converge::before {
                content: '\\2193';
                font-size: 24px;
                color: #9ca3af;
            }
            .pipeline-outputs {
                flex-direction: column;
                gap: 8px;
            }
            .pipeline-to-contracts {
                transform: rotate(90deg);
            }
        }

        /* ========== SECTION 3: TWO COLUMN DETAIL ========== */
        .dashboard-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 0 20px 20px 20px;
        }

        .dashboard-section {
            background: white;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-link {
            font-size: 12px;
            color: var(--primary);
            text-decoration: none;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        /* Hottest Leads */
        .hot-lead-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .hot-lead-item:last-child {
            border-bottom: none;
        }

        .heat-indicator {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .heat-indicator.hot { background: #fef2f2; color: #dc2626; }
        .heat-indicator.warm { background: #fef3c7; color: #d97706; }
        .heat-indicator.cool { background: #dbeafe; color: #2563eb; }

        .hot-lead-info {
            flex: 1;
            min-width: 0;
        }

        .hot-lead-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .hot-lead-name a {
            color: inherit;
            text-decoration: none;
        }

        .hot-lead-name a:hover {
            color: var(--primary);
        }

        .hot-lead-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .hot-lead-activity {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Overnight Changes */
        .change-group {
            margin-bottom: 16px;
        }

        .change-group:last-child {
            margin-bottom: 0;
        }

        .change-group-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .change-group-count {
            background: var(--bg-secondary);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .change-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
        }

        .change-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .change-icon.new-lead { background: #dcfce7; }
        .change-icon.price-drop { background: #dbeafe; }
        .change-icon.status { background: #f3e8ff; }
        .change-icon.cold { background: #fef3c7; }

        .change-content {
            flex: 1;
            min-width: 0;
        }

        .change-text {
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .change-detail {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .change-value {
            font-weight: 600;
            font-size: 12px;
            color: #16a34a;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ========== SECTION 4: ACTIVE PURSUITS ========== */
        .pursuits-section {
            margin: 0 20px 20px 20px;
            background: white;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        /* ========== SECTION 5: BUYERS NEEDING PROPERTY WORK ========== */
        .property-work-section {
            margin: 0 20px 20px 20px;
            background: white;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .work-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border: 1px solid var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .work-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .work-item:last-child {
            margin-bottom: 0;
        }

        .work-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .work-content {
            flex: 1;
            min-width: 0;
        }

        .work-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .work-name a {
            color: inherit;
            text-decoration: none;
        }

        .work-name a:hover {
            color: var(--primary);
        }

        .work-criteria {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .work-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .work-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
        }

        .work-badge.never {
            background: #fee2e2;
            color: #991b1b;
        }

        .work-actions {
            display: flex;
            gap: 8px;
        }

        .work-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .work-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .work-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .work-btn.primary:hover {
            background: var(--primary-dark);
        }

        .pursuit-item {
            padding: 16px;
            border: 1px solid var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .pursuit-item:last-child {
            margin-bottom: 0;
        }

        .pursuit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .pursuit-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .pursuit-actions {
            display: flex;
            gap: 8px;
        }

        .pursuit-btn {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            background: white;
            cursor: pointer;
        }

        .pursuit-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .pursuit-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pursuit-btn.primary:hover {
            background: var(--primary-dark);
        }

        .pursuit-criteria {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .pursuit-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .pursuit-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
        }

        .pursuit-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .pursuit-stat.new .pursuit-stat-value {
            color: #16a34a;
        }

        .pursuit-stat.favorites .pursuit-stat-value {
            color: #f59e0b;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .priority-actions {
                grid-template-columns: 1fr;
            }
            .pipeline-flow {
                flex-wrap: wrap;
                gap: 12px;
            }
            .pipeline-arrow {
                display: none;
            }
        }

        @media (max-width: 1024px) {
            .dashboard-columns {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dreams-header">
        <div>
            <h1>DREAMS Dashboard</h1>
            <div class="dreams-header-subtitle">
                Desktop Real Estate Agent Management System
            </div>
        </div>
        <nav style="display: flex; gap: 16px; align-items: center;">
            <a href="/properties" class="dreams-btn dreams-btn-secondary">Properties</a>
            <a href="/contacts" class="dreams-btn dreams-btn-secondary">Contacts</a>
            <a href="/call-list" class="dreams-btn dreams-btn-secondary">Call List</a>
            <a href="/fub-list" class="dreams-btn dreams-btn-secondary">FUB List</a>
            <div class="metrics-dropdown">
                <button class="metrics-btn">
                    Metrics <span class="arrow">&#9662;</span>
                </button>
                <div class="metrics-menu">
                    <div class="metrics-menu-inner">
                        <a href="/my-leads">
                            <span class="menu-icon">&#128101;</span>
                            <span class="menu-text">
                                <span class="menu-label">My Leads</span>
                                <span class="menu-desc">Leads assigned to me</span>
                            </span>
                        </a>
                        <div class="metrics-menu-divider"></div>
                        <a href="/actions">
                            <span class="menu-icon">&#9745;</span>
                            <span class="menu-text">
                                <span class="menu-label">My Actions</span>
                                <span class="menu-desc">Tasks & follow-ups</span>
                            </span>
                        </a>
                        <div class="metrics-menu-divider"></div>
                        <a href="/system/scoring-runs">
                            <span class="menu-icon">&#128202;</span>
                            <span class="menu-text">
                                <span class="menu-label">Scoring History</span>
                                <span class="menu-desc">FUB sync audit trail</span>
                            </span>
                        </a>
                        <div class="metrics-menu-divider"></div>
                        <a href="/data-quality">
                            <span class="menu-icon">&#128200;</span>
                            <span class="menu-text">
                                <span class="menu-label">Data Quality</span>
                                <span class="menu-desc">Database health metrics</span>
                            </span>
                        </a>
                        <div class="metrics-menu-divider"></div>
                        <a href="/admin/settings">
                            <span class="menu-icon">&#9881;</span>
                            <span class="menu-text">
                                <span class="menu-label">Admin Settings</span>
                                <span class="menu-desc">Alert thresholds & toggles</span>
                            </span>
                        </a>
                        <a href="/admin/automation">
                            <span class="menu-icon">&#9889;</span>
                            <span class="menu-text">
                                <span class="menu-label">Automation Rules</span>
                                <span class="menu-desc">Rule triggers & actions</span>
                            </span>
                        </a>
                    </div>
                </div>
            </div>
            <span style="font-size: 13px; opacity: 0.8;">{{ refresh_time }}</span>
        </nav>
    </header>

    <!-- Section 1: Pipeline Snapshot (Top of page) -->
    <div class="pipeline-section">
        <div class="pipeline-header">Pipeline Snapshot</div>
        <div class="pipeline-dual">
            <!-- LEFT: Two parallel input tracks -->
            <div class="pipeline-inputs">
                <!-- PEOPLE TRACK: Leads -> Buyers -->
                <div class="pipeline-people">
                    <div class="pipeline-track">
                        <div class="track-label">People</div>
                        <div class="pipeline-track-row">
                            <a href="/contacts" class="pipeline-stage leads">
                                <div class="pipeline-stage-value">{{ pipeline.leads.count }}</div>
                                <div class="pipeline-stage-label">Leads</div>
                                {% if pipeline.leads.delta != 0 %}
                                <div class="pipeline-stage-delta {{ 'positive' if pipeline.leads.delta > 0 else 'negative' }}">
                                    {{ '+' if pipeline.leads.delta > 0 else '' }}{{ pipeline.leads.delta }} this week
                                </div>
                                {% endif %}
                            </a>
                            <div class="pipeline-arrow">&#8594;</div>
                            <a href="/contacts?stage=Active+Client" class="pipeline-stage buyers">
                                <div class="pipeline-stage-value">{{ pipeline.buyers.count }}</div>
                                <div class="pipeline-stage-label">Buyers</div>
                                {% if pipeline.buyers.need_intake > 0 %}
                                <div class="pipeline-stage-delta">{{ pipeline.buyers.need_intake }} need intake</div>
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- PROPERTIES TRACK -->
                <div class="pipeline-properties">
                    <div class="pipeline-track">
                        <div class="track-label">Properties</div>
                        <a href="/properties" class="pipeline-stage properties">
                            <div class="pipeline-stage-value">{{ pipeline.properties.active }}</div>
                            <div class="pipeline-stage-label">Active</div>
                            <div class="pipeline-stage-delta">
                                {{ pipeline.properties.new_today }} new &middot; {{ pipeline.properties.price_drops }} drops
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- CONVERGENCE ZONE -->
            <div class="pipeline-converge">
                <div class="converge-arrows">
                    <div class="converge-arrow-top"></div>
                    <div class="converge-arrow-bottom"></div>
                </div>
            </div>

            <!-- RIGHT: Output stages -->
            <div class="pipeline-outputs">
                <!-- PURSUITS -->
                <a href="/pursuits" class="pipeline-stage pursuits">
                    <div class="pipeline-stage-value">{{ pipeline.pursuits.count }}</div>
                    <div class="pipeline-stage-label">Pursuits</div>
                    {% if pipeline.pursuits.properties_count > 0 %}
                    <div class="pipeline-stage-delta">{{ pipeline.pursuits.properties_count }} properties</div>
                    {% endif %}
                </a>

                <div class="pipeline-to-contracts">&#8594;</div>

                <!-- CONTRACTS -->
                <a href="/contacts?stage=Under+Contract" class="pipeline-stage contracts">
                    <div class="pipeline-stage-value">{{ pipeline.contracts.count }}</div>
                    <div class="pipeline-stage-label">Contracts</div>
                    {% if pipeline.contracts.value > 0 %}
                    <div class="pipeline-stage-delta">${{ "{:,.0f}".format(pipeline.contracts.value) }}</div>
                    {% endif %}
                </a>
            </div>
        </div>
    </div>

    <!-- Section 2: Today's Priority Actions -->
    <div class="priority-actions">
        <!-- Calls Column -->
        <div class="action-column">
            <div class="action-column-header">
                <span class="action-column-title">Calls</span>
                <span class="action-column-count">{{ todays_actions.calls|length }}</span>
            </div>
            {% if todays_actions.calls %}
                {% for action in todays_actions.calls[:5] %}
                <div class="action-item">
                    <div class="action-icon call">&#128222;</div>
                    <div class="action-content">
                        <div class="action-name">
                            <a href="/contacts/{{ action.contact_id }}">{{ action.name }}</a>
                        </div>
                        <div class="action-meta">{{ action.stage or 'Lead' }} {% if action.description %}&middot; {{ action.description|truncate(30) }}{% endif %}</div>
                        <div class="action-contact-links">
                            {% if action.phone %}
                            <a href="tel:{{ action.phone }}">{{ action.phone|phone }}</a>
                            {% endif %}
                            {% if action.fub_id %}
                            <a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ action.fub_id }}" target="_blank">FUB</a>
                            {% endif %}
                        </div>
                    </div>
                    {% if action.priority_score %}
                    <span class="action-score">P{{ "%.0f"|format(action.priority_score) }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="action-empty">No calls scheduled for today</div>
            {% endif %}
        </div>

        <!-- Todos Column (Todoist Tasks by Project) -->
        <div class="action-column" style="max-height: 500px; overflow-y: auto;">
            <div class="action-column-header">
                <span class="action-column-title">Todos</span>
                <span class="action-column-count">{{ todoist_tasks.total_count }}</span>
                {% if todoist_tasks.overdue_count > 0 %}
                <span style="background: #fef2f2; color: #dc2626; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px;">{{ todoist_tasks.overdue_count }} overdue</span>
                {% endif %}
                <a href="https://todoist.com/app" target="_blank" style="font-size: 11px; color: var(--text-secondary); margin-left: auto;">Open Todoist</a>
            </div>

            {% if todoist_tasks.projects %}
                {% for project in todoist_tasks.projects[:4] %}
                {# Project Header #}
                <div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin: {{ '4px' if loop.first else '12px' }} 0 8px 0; display: flex; align-items: center; gap: 6px;">
                    <span style="width: 8px; height: 8px; border-radius: 2px; background: {% if project.color == 'red' %}#dc2626{% elif project.color == 'orange' %}#f97316{% elif project.color == 'yellow' %}#eab308{% elif project.color == 'green' %}#22c55e{% elif project.color == 'blue' %}#3b82f6{% elif project.color == 'purple' %}#a855f7{% else %}#6b7280{% endif %};"></span>
                    {{ project.name|truncate(25) }}
                    <span style="background: var(--bg-secondary); padding: 1px 6px; border-radius: 10px; font-size: 9px;">{{ project.tasks|length }}</span>
                </div>

                {# Tasks in this project #}
                {% for task in project.tasks[:3] %}
                <div class="action-item" {% if task.is_overdue %}style="border-left: 3px solid #dc2626; padding-left: 12px;"{% endif %}>
                    <div class="action-icon follow-up" style="background: {% if task.is_overdue %}#fef2f2{% else %}#f3f4f6{% endif %};">
                        {% if task.is_overdue %}&#9888;{% else %}&#9744;{% endif %}
                    </div>
                    <div class="action-content">
                        <div class="action-name">
                            <a href="https://todoist.com/app/task/{{ task.todoist_id }}" target="_blank">{{ task.content|truncate(30) }}</a>
                        </div>
                        <div class="action-meta">
                            {% if task.person_name %}{{ task.person_name }}{% endif %}
                            {% if task.deal_stage %} &middot; <span style="color: #2563eb;">{{ task.deal_stage }}</span>{% endif %}
                            {% if task.deal_value %} &middot; ${{ "{:,.0f}".format(task.deal_value) }}{% endif %}
                            {% if task.due_date %} &middot; {{ task.due_date[:10] }}{% endif %}
                        </div>
                        {% if task.property_address %}
                        <div class="action-meta" style="font-size: 10px; color: var(--text-secondary);">
                            üìç {{ task.property_address }}{% if task.property_city %}, {{ task.property_city }}{% endif %}
                        </div>
                        {% endif %}
                        <div class="action-contact-links">
                            {% if task.fub_person_id %}
                            <a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ task.fub_person_id }}" target="_blank">FUB</a>
                            {% endif %}
                            {% if task.fub_deal_id %}
                            <a href="https://JonTharpTeam.followupboss.com/2/deals/view/{{ task.fub_deal_id }}" target="_blank">Deal</a>
                            {% endif %}
                        </div>
                    </div>
                    {% if task.priority > 1 %}
                    <span class="action-score" style="background: {% if task.priority == 4 %}#fef2f2{% elif task.priority == 3 %}#fef3c7{% else %}#dbeafe{% endif %}; color: {% if task.priority == 4 %}#dc2626{% elif task.priority == 3 %}#d97706{% else %}#2563eb{% endif %};">P{{ task.priority }}</span>
                    {% endif %}
                </div>
                {% endfor %}

                {# Show more indicator #}
                {% if project.tasks|length > 3 %}
                <div style="font-size: 11px; color: var(--text-secondary); padding: 4px 0; text-align: center;">
                    +{{ project.tasks|length - 3 }} more in this project
                </div>
                {% endif %}
                {% endfor %}

                {# More projects indicator #}
                {% if todoist_tasks.projects|length > 4 %}
                <div style="font-size: 11px; color: var(--text-secondary); padding: 8px 0; text-align: center; border-top: 1px solid var(--bg-secondary); margin-top: 8px;">
                    +{{ todoist_tasks.projects|length - 4 }} more projects
                </div>
                {% endif %}
            {% else %}
                <div class="action-empty">No tasks - you're all caught up!</div>
            {% endif %}
        </div>

        <!-- Send Properties Column -->
        <div class="action-column">
            <div class="action-column-header">
                <span class="action-column-title">Send Properties</span>
                <span class="action-column-count">{{ todays_actions.send_properties|length }}</span>
            </div>
            {% if todays_actions.send_properties %}
                {% for buyer in todays_actions.send_properties[:5] %}
                <div class="action-item">
                    <div class="action-icon send">&#127968;</div>
                    <div class="action-content">
                        <div class="action-name">
                            <a href="/contacts/{{ buyer.contact_id }}">{{ buyer.name }}</a>
                        </div>
                        <div class="action-meta">
                            <strong style="color: #16a34a;">{{ buyer.match_count }} matches</strong>
                            {% if buyer.preferred_cities and buyer.preferred_cities != '[]' %} &middot; {{ buyer.preferred_cities|truncate(15) }}{% endif %}
                        </div>
                        <div class="action-contact-links">
                            {% if buyer.email %}
                            <a href="mailto:{{ buyer.email }}">Send email</a>
                            {% endif %}
                            {% if buyer.fub_id %}
                            <a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ buyer.fub_id }}" target="_blank">FUB</a>
                            {% endif %}
                        </div>
                    </div>
                    <span class="action-score" style="background: #dcfce7; color: #16a34a;">{{ buyer.match_count }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="action-empty">No buyers with matching properties</div>
            {% endif %}
        </div>
    </div>

    <!-- Section 3: Active Deals -->
    {% if active_deals %}
    <div class="dashboard-section" style="margin-bottom: 20px;">
        <div class="section-header">
            <h3 class="section-title">Active Deals</h3>
            <span class="section-count">{{ active_deals|length }}</span>
            <a href="https://JonTharpTeam.followupboss.com/2/deals" target="_blank" class="section-link" style="margin-left: auto;">Open FUB Deals</a>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
            {% for deal in active_deals %}
            <div class="card" style="padding: 12px; border-left: 4px solid {% if 'pending' in (deal.stage_name or '')|lower %}#3b82f6{% elif 'offer' in (deal.stage_name or '')|lower %}#f97316{% elif 'contract' in (deal.stage_name or '')|lower %}#eab308{% elif 'new' in (deal.stage_name or '')|lower %}#22c55e{% else %}#6b7280{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">
                            <a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ deal.person_id }}" target="_blank">{{ deal.person_name }}</a>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            {{ deal.stage_name }}
                        </div>
                    </div>
                    {% if deal.deal_value %}
                    <div style="font-weight: 600; color: #16a34a;">${{ "{:,.0f}".format(deal.deal_value) }}</div>
                    {% endif %}
                </div>
                {% if deal.property_address %}
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                    üìç {{ deal.property_address }}{% if deal.property_city %}, {{ deal.property_city }}{% endif %}
                </div>
                {% endif %}
                <div style="display: flex; gap: 8px; font-size: 11px;">
                    <a href="https://JonTharpTeam.followupboss.com/2/deals/view/{{ deal.id }}" target="_blank" style="color: var(--accent-blue);">View Deal</a>
                    {% if deal.person_phone %}
                    <a href="tel:{{ deal.person_phone }}" style="color: var(--text-secondary);">üìû Call</a>
                    {% endif %}
                    {% if deal.person_email %}
                    <a href="mailto:{{ deal.person_email }}" style="color: var(--text-secondary);">‚úâÔ∏è Email</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Section 4: Hottest Leads + Overnight Changes -->
    <div class="dashboard-columns">
        <!-- Left: Hottest Leads -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">Hottest Leads</h3>
                <a href="/contacts?sort=heat" class="section-link">View All</a>
            </div>
            {% if hottest_leads %}
                {% for lead in hottest_leads %}
                <div class="hot-lead-item">
                    <div class="heat-indicator {{ 'hot' if lead.heat_score >= 70 else 'warm' if lead.heat_score >= 40 else 'cool' }}">
                        {{ "%.0f"|format(lead.heat_score or 0) }}
                    </div>
                    <div class="hot-lead-info">
                        <div class="hot-lead-name">
                            <a href="/contacts/{{ lead.id }}">{{ lead.first_name or '' }} {{ lead.last_name or '' }}</a>
                        </div>
                        <div class="hot-lead-meta">
                            {{ lead.stage or 'Lead' }}
                            {% if lead.preferred_cities %} &middot; {{ lead.preferred_cities|truncate(25) }}{% endif %}
                        </div>
                        <div class="hot-lead-activity">
                            {% if lead.properties_viewed %}{{ lead.properties_viewed }} viewed{% endif %}
                            {% if lead.properties_favorited %} &middot; {{ lead.properties_favorited }} saved{% endif %}
                            {% if lead.last_activity_at %} &middot; Last: {{ lead.last_activity_at[:10] }}{% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">No hot leads detected yet</div>
            {% endif %}
        </div>

        <!-- Right: Overnight Changes -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">Overnight Changes</h3>
                <span style="font-size: 11px; color: var(--text-secondary);">Last 24 hours</span>
            </div>

            <!-- New Leads -->
            {% if overnight.new_leads %}
            <div class="change-group">
                <div class="change-group-title">
                    New Leads <span class="change-group-count">{{ overnight.new_leads|length }}</span>
                </div>
                {% for lead in overnight.new_leads[:3] %}
                <div class="change-item">
                    <div class="change-icon new-lead">&#128100;</div>
                    <div class="change-content">
                        <div class="change-text">{{ lead.first_name or '' }} {{ lead.last_name or '' }}</div>
                        <div class="change-detail">{{ lead.source or 'Unknown source' }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Price Drops -->
            {% if overnight.price_drops %}
            <div class="change-group">
                <div class="change-group-title">
                    Price Drops <span class="change-group-count">{{ overnight.price_drops|length }}</span>
                </div>
                {% for drop in overnight.price_drops[:3] %}
                <div class="change-item">
                    <div class="change-icon price-drop">&#128181;</div>
                    <div class="change-content">
                        <div class="change-text">{{ drop.property_address|truncate(35) }}</div>
                        <div class="change-detail">{{ drop.city }} &middot; ${{ "{:,.0f}".format(drop.new_value|float) }}</div>
                    </div>
                    <div class="change-value">-${{ "{:,.0f}".format(drop.change_amount|abs) }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Status Changes -->
            {% if overnight.status_changes %}
            <div class="change-group">
                <div class="change-group-title">
                    Status Changes <span class="change-group-count">{{ overnight.status_changes|length }}</span>
                </div>
                {% for change in overnight.status_changes[:3] %}
                <div class="change-item">
                    <div class="change-icon status">&#127991;</div>
                    <div class="change-content">
                        <div class="change-text">{{ change.property_address|truncate(35) }}</div>
                        <div class="change-detail">{{ change.old_value }} &#8594; {{ change.new_value }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Going Cold -->
            {% if overnight.going_cold %}
            <div class="change-group">
                <div class="change-group-title">
                    Going Cold <span class="change-group-count">{{ overnight.going_cold|length }}</span>
                </div>
                {% for lead in overnight.going_cold[:3] %}
                <div class="change-item">
                    <div class="change-icon cold">&#10052;</div>
                    <div class="change-content">
                        <div class="change-text">{{ lead.first_name or '' }} {{ lead.last_name or '' }}</div>
                        <div class="change-detail">{{ lead.days_since_activity or '7+' }} days inactive</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if not overnight.new_leads and not overnight.price_drops and not overnight.status_changes and not overnight.going_cold %}
                <div class="empty-state">No significant changes overnight</div>
            {% endif %}
        </div>
    </div>

    <!-- Section 4: Active Pursuits -->
    <div class="pursuits-section">
        <div class="section-header">
            <h3 class="section-title">Active Pursuits</h3>
            <a href="/pursuits" class="section-link">See All</a>
        </div>

        {% if active_pursuits %}
            {% for pursuit in active_pursuits %}
            <div class="pursuit-item">
                <div class="pursuit-header">
                    <div class="pursuit-name">{{ pursuit.name or pursuit.buyer_name }}</div>
                    <div class="pursuit-actions">
                        <a href="/contacts/{{ pursuit.buyer_id }}" class="pursuit-btn">View Buyer</a>
                        <button class="pursuit-btn primary" onclick="alert('Send Update feature coming soon')">Send Update</button>
                    </div>
                </div>
                <div class="pursuit-criteria">
                    {{ pursuit.criteria_summary or 'No criteria specified' }}
                </div>
                <div class="pursuit-stats">
                    <div class="pursuit-stat">
                        &#128230; <span class="pursuit-stat-value">{{ pursuit.property_count or 0 }}</span> properties
                    </div>
                    {% if pursuit.new_count > 0 %}
                    <div class="pursuit-stat new">
                        &#127381; <span class="pursuit-stat-value">{{ pursuit.new_count }}</span> new matches
                    </div>
                    {% endif %}
                    {% if pursuit.favorited_count > 0 %}
                    <div class="pursuit-stat favorites">
                        &#11088; <span class="pursuit-stat-value">{{ pursuit.favorited_count }}</span> favorites
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p style="margin-bottom: 8px;">No active pursuits yet</p>
                <p style="font-size: 12px; color: var(--text-secondary);">Pursuits are created when you connect a qualified buyer with properties they're interested in.</p>
            </div>
        {% endif %}
    </div>

    <!-- Section 5: Buyers Needing Property Work -->
    <div class="property-work-section">
        <div class="section-header">
            <h3 class="section-title">Buyers Needing Property Work</h3>
            <a href="/contacts?view=my_leads&stage=Active+Buyer" class="section-link">See All Active Buyers</a>
        </div>

        {% if buyers_needing_work %}
            {% for buyer in buyers_needing_work %}
            <div class="work-item">
                <div class="work-icon">&#128269;</div>
                <div class="work-content">
                    <div class="work-name">
                        <a href="/contacts/{{ buyer.id }}">{{ buyer.name }}</a>
                    </div>
                    <div class="work-criteria">
                        {% if buyer.min_price and buyer.max_price %}
                            ${{ "{:,.0f}".format(buyer.min_price) }} - ${{ "{:,.0f}".format(buyer.max_price) }}
                        {% elif buyer.max_price %}
                            Up to ${{ "{:,.0f}".format(buyer.max_price) }}
                        {% endif %}
                        {% if buyer.preferred_cities %}
                            | {{ buyer.preferred_cities[:50] }}{% if buyer.preferred_cities|length > 50 %}...{% endif %}
                        {% elif buyer.preferred_counties %}
                            | {{ buyer.preferred_counties[:50] }}{% if buyer.preferred_counties|length > 50 %}...{% endif %}
                        {% endif %}
                    </div>
                    <div class="work-meta">
                        <span>{{ buyer.form_name or buyer.need_type or 'Requirements' }}</span>
                        {% if buyer.days_since_package is none %}
                            <span class="work-badge never">No packages yet</span>
                        {% else %}
                            <span class="work-badge">{{ buyer.days_since_package }}d since last package</span>
                        {% endif %}
                    </div>
                </div>
                <div class="work-actions">
                    <a href="/contacts/{{ buyer.id }}/search" class="work-btn primary">Search Properties</a>
                    <a href="/contacts/{{ buyer.id }}/workspace" class="work-btn">Workspace</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p style="margin-bottom: 8px;">All buyers are up to date!</p>
                <p style="font-size: 12px; color: var(--text-secondary);">No active buyers need property packages right now.</p>
            </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="dreams-footer">
        DREAMS - Desktop Real Estate Agent Management System | Joseph "Eugy" Williams
    </footer>
</body>
</html>
