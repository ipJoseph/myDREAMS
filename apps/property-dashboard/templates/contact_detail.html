<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ contact.first_name }} {{ contact.last_name }} | DREAMS</title>
    <!-- Shared Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <!-- Page-specific overrides (minimal) -->
    <style>
        /* Contact header card */
        .contact-header-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
        }

        .contact-name-large {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 8px 0;
        }

        .contact-meta {
            display: flex;
            gap: 24px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .contact-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .contact-meta-item strong {
            color: var(--text-primary);
        }

        /* Score cards grid */
        .score-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin: 0 20px 20px 20px;
        }

        .score-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .score-card-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .score-card-value {
            font-size: 36px;
            font-weight: 700;
        }

        .score-card-value.priority { color: var(--primary); }
        .score-card-value.heat { color: #ef4444; }
        .score-card-value.value { color: #10b981; }
        .score-card-value.relationship { color: #3b82f6; }

        /* Activity stats */
        .activity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .activity-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .activity-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }

        .activity-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Intent signals section */
        .intent-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .intent-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .intent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 6px;
            background: var(--bg-secondary);
        }

        .intent-item.active {
            background: #dcfce7;
        }

        .intent-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: #e5e7eb;
            color: #9ca3af;
        }

        .intent-item.active .intent-indicator {
            background: #10b981;
            color: white;
        }

        /* Properties section */
        .properties-section {
            margin: 0 20px 20px 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        /* Back link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            margin: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Trend indicator */
        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }
        .trend-badge.warming { background: #dcfce7; color: #166534; }
        .trend-badge.cooling { background: #fee2e2; color: #991b1b; }
        .trend-badge.stable { background: #f3f4f6; color: #374151; }

        .trend-arrow { font-size: 14px; }

        /* Activity timeline */
        .activity-timeline {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .timeline-icon.call { background: #dbeafe; color: #1d4ed8; }
        .timeline-icon.text { background: #dcfce7; color: #166534; }
        .timeline-icon.website_visit { background: #fef3c7; color: #92400e; }
        .timeline-icon.property_view { background: #ede9fe; color: #6d28d9; }
        .timeline-icon.property_favorite { background: #fce7f3; color: #be185d; }
        .timeline-icon.property_share { background: #e0e7ff; color: #4338ca; }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .timeline-time {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .timeline-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Mini trend chart */
        .trend-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .trend-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 60px;
            padding: 10px 0;
        }

        .trend-bar {
            flex: 1;
            min-width: 20px;
            border-radius: 4px 4px 0 0;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            transition: height 0.3s ease;
        }

        .trend-bar:hover {
            opacity: 0.8;
        }

        .trend-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--bg-tertiary);
        }

        .trend-summary-item {
            text-align: center;
        }

        .trend-summary-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .trend-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        /* Properties Viewed section */
        .properties-viewed-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Use dreams-table from design system - override for this context */
        .properties-viewed-section .dreams-table {
            border-radius: 0;
            box-shadow: none;
        }

        .properties-viewed-section .dreams-table th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-address-cell {
            max-width: 250px;
        }

        .property-address-main {
            font-weight: 600;
            color: var(--text-primary);
        }

        .property-address-mls {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .view-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
        }

        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 14px;
        }

        .status-icon.active {
            background: #dcfce7;
        }

        .status-icon.inactive {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .others-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .others-badge:hover {
            background: #fde68a;
        }

        .others-tooltip {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 200px;
            max-width: 300px;
        }

        .others-badge:hover + .others-tooltip,
        .others-tooltip:hover {
            display: block;
        }

        .others-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .others-list li {
            padding: 6px 0;
            border-bottom: 1px solid var(--bg-tertiary);
            font-size: 13px;
        }

        .others-list li:last-child {
            border-bottom: none;
        }

        .date-cell {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .properties-viewed-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dreams-header">
        <div>
            <h1>Contact Details</h1>
            <div class="dreams-header-subtitle">
                {{ contact.first_name }} {{ contact.last_name }}
            </div>
        </div>
        <nav style="display: flex; gap: 16px; align-items: center;">
            <a href="/" class="dreams-btn dreams-btn-secondary">Main</a>
            <a href="/contacts" class="dreams-btn dreams-btn-secondary">Contacts</a>
        </nav>
    </header>

    <a href="/contacts" class="back-link">&larr; Back to Contacts</a>

    <!-- Contact Header Card -->
    <div class="contact-header-card">
        <div>
            <h1 class="contact-name-large">
                {{ contact.first_name or '' }} {{ contact.last_name or '' }}
                {% if trend_summary and trend_summary.trend_direction %}
                <span class="trend-badge {{ trend_summary.trend_direction }}">
                    {% if trend_summary.trend_direction == 'warming' %}
                    <span class="trend-arrow">&#8593;</span> Warming
                    {% elif trend_summary.trend_direction == 'cooling' %}
                    <span class="trend-arrow">&#8595;</span> Cooling
                    {% else %}
                    <span class="trend-arrow">&#8596;</span> Stable
                    {% endif %}
                </span>
                {% endif %}
            </h1>
            <span class="dreams-badge dreams-badge-{{ (contact.stage or 'unknown')|lower|replace(' ', '-') }}">
                {{ contact.stage or 'Unknown' }}
            </span>

            <div class="contact-meta">
                {% if contact.email %}
                <div class="contact-meta-item">
                    <span>Email:</span>
                    <strong><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></strong>
                </div>
                {% endif %}
                {% if contact.phone %}
                <div class="contact-meta-item">
                    <span>Phone:</span>
                    <strong>
                        <a href="tel:{{ contact.phone }}" title="Call on device">{{ contact.phone }}</a>
                        {% if contact.fub_id %}
                        <a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ contact.fub_id }}" target="_blank" title="Open in FUB" style="margin-left: 8px; color: #6366f1;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            FUB
                        </a>
                        {% endif %}
                    </strong>
                </div>
                {% endif %}
                {% if contact.fub_id %}
                <div class="contact-meta-item">
                    <span>FUB:</span>
                    <strong><a href="https://JonTharpTeam.followupboss.com/2/people/view/{{ contact.fub_id }}" target="_blank" style="color: #6366f1;">Open in Follow Up Boss →</a></strong>
                </div>
                {% endif %}
                {% if contact.source %}
                <div class="contact-meta-item">
                    <span>Source:</span>
                    <strong>{{ contact.source }}</strong>
                </div>
                {% endif %}
                {% if contact.lead_type_tags %}
                <div class="contact-meta-item">
                    <span>Tags:</span>
                    <strong>{{ contact.lead_type_tags }}</strong>
                </div>
                {% endif %}
            </div>
        </div>

        <div style="text-align: right;">
            {% if contact.next_action %}
            <div style="background: #fef3c7; padding: 12px 16px; border-radius: 6px; text-align: left;">
                <div style="font-size: 11px; text-transform: uppercase; color: #92400e; margin-bottom: 4px;">Next Action</div>
                <div style="font-weight: 600; color: #78350f;">{{ contact.next_action }}</div>
                {% if contact.next_action_date %}
                <div style="font-size: 12px; color: #92400e; margin-top: 4px;">{{ contact.next_action_date }}</div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Score Cards -->
    <div class="score-cards">
        <div class="score-card">
            <div class="score-card-label">Priority Score</div>
            <div class="score-card-value priority">{{ "%.0f"|format(contact.priority_score or 0) }}</div>
        </div>
        <div class="score-card">
            <div class="score-card-label">Heat Score</div>
            <div class="score-card-value heat">{{ "%.0f"|format(contact.heat_score or 0) }}</div>
        </div>
        <div class="score-card">
            <div class="score-card-label">Value Score</div>
            <div class="score-card-value value">{{ "%.0f"|format(contact.value_score or 0) }}</div>
        </div>
        <div class="score-card">
            <div class="score-card-label">Relationship</div>
            <div class="score-card-value relationship">{{ "%.0f"|format(contact.relationship_score or 0) }}</div>
        </div>
    </div>

    <!-- Activity Stats -->
    <div class="activity-stats">
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.website_visits or 0 }}</div>
            <div class="activity-stat-label">Website Visits</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.properties_viewed or 0 }}</div>
            <div class="activity-stat-label">Property Views</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.properties_favorited or 0 }}</div>
            <div class="activity-stat-label">Favorited</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.calls_inbound or 0 }}</div>
            <div class="activity-stat-label">Calls In</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.calls_outbound or 0 }}</div>
            <div class="activity-stat-label">Calls Out</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.emails_received or 0 }}</div>
            <div class="activity-stat-label">Emails In</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.emails_sent or 0 }}</div>
            <div class="activity-stat-label">Emails Out</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{{ contact.texts_total or 0 }}</div>
            <div class="activity-stat-label">Texts</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{% if contact.avg_price_viewed %}${{ "{:,.0f}".format(contact.avg_price_viewed) }}{% else %}--{% endif %}</div>
            <div class="activity-stat-label">Avg Price Viewed</div>
        </div>
        <div class="activity-stat">
            <div class="activity-stat-value">{% if contact.days_since_activity is not none and contact.days_since_activity < 999 %}{{ contact.days_since_activity }}d{% else %}--{% endif %}</div>
            <div class="activity-stat-label">Since Last Activity</div>
        </div>
    </div>

    <!-- Intent Signals -->
    <div class="intent-section">
        <h3 class="section-title">Intent Signals ({{ contact.intent_signal_count or 0 }} of 4 active)</h3>
        <div class="intent-grid">
            <div class="intent-item {% if contact.intent_repeat_views %}active{% endif %}">
                <span class="intent-indicator">R</span>
                <span>Repeat Property Views</span>
            </div>
            <div class="intent-item {% if contact.intent_high_favorites %}active{% endif %}">
                <span class="intent-indicator">F</span>
                <span>High Favorites</span>
            </div>
            <div class="intent-item {% if contact.intent_activity_burst %}active{% endif %}">
                <span class="intent-indicator">B</span>
                <span>Activity Burst</span>
            </div>
            <div class="intent-item {% if contact.intent_sharing %}active{% endif %}">
                <span class="intent-indicator">S</span>
                <span>Property Sharing</span>
            </div>
        </div>
    </div>

    <!-- Properties Viewed Section -->
    <div class="properties-viewed-section">
        <h3 class="section-title">Unique Properties ({{ property_summary|length if property_summary else 0 }})</h3>
        {% if property_summary and property_summary|length > 0 %}
        <table class="dreams-table" id="properties-viewed-table">
            <thead>
                <tr>
                    <th data-sort="address" onclick="sortPropertiesTable(0, 'string')">Address</th>
                    <th data-sort="price" onclick="sortPropertiesTable(1, 'number')">Price</th>
                    <th data-sort="activity" onclick="sortPropertiesTable(2, 'number')">Activity</th>
                    <th style="text-align: center;">Fav</th>
                    <th style="text-align: center;">Shared</th>
                    <th>Others</th>
                    <th data-sort="date" onclick="sortPropertiesTable(6, 'date')">Last Viewed</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in property_summary %}
                <tr>
                    <td class="property-address-cell">
                        {% if prop.property_address and prop.property_address != '[Not found on IDX]' %}
                        <div class="property-address-main">
                            <a href="https://www.smokymountainhomes4sale.com/property/{{ prop.property_mls }}"
                               target="_blank" class="dreams-link" title="View on IDX">
                                {{ prop.property_address }}
                            </a>
                        </div>
                        <div class="property-address-mls">MLS# {{ prop.property_mls }}</div>
                        {% else %}
                        <div class="property-address-main">
                            <a href="https://www.smokymountainhomes4sale.com/property/{{ prop.property_mls }}"
                               target="_blank" class="dreams-link" style="font-family: monospace;" title="View on IDX">
                                MLS# {{ prop.property_mls }} ↗
                            </a>
                        </div>
                        <div class="property-address-mls" style="color: var(--text-tertiary); font-style: italic;">Click to view on IDX</div>
                        {% endif %}
                    </td>
                    <td class="dreams-price">
                        {% if prop.property_price %}
                        ${{ "{:,.0f}".format(prop.property_price) }}
                        {% else %}
                        --
                        {% endif %}
                    </td>
                    <td>
                        <span class="view-count-badge">{{ prop.view_count }}x</span>
                    </td>
                    <td style="text-align: center;">
                        {% if prop.is_favorited %}
                        <span class="status-icon active" title="Favorited">&#10084;</span>
                        {% else %}
                        <span class="status-icon inactive">&#9825;</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if prop.is_shared %}
                        <span class="status-icon active" title="Shared">&#128228;</span>
                        {% else %}
                        <span class="status-icon inactive">&#8211;</span>
                        {% endif %}
                    </td>
                    <td style="position: relative;">
                        {% if prop.other_count > 0 %}
                        <span class="others-badge">+{{ prop.other_count }} lead{{ 's' if prop.other_count > 1 else '' }}</span>
                        <div class="others-tooltip">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; color: var(--text-secondary);">Also Viewing</div>
                            <ul class="others-list">
                                {% for other in prop.other_contacts[:5] %}
                                <li>
                                    <a href="/contacts/{{ other.contact_id }}" class="dreams-link">
                                        {{ other.first_name }} {{ other.last_name }}
                                    </a>
                                    {% if other.has_favorited %}
                                    <span style="color: #ef4444;" title="Also favorited">&#10084;</span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                                {% if prop.other_count > 5 %}
                                <li style="color: var(--text-tertiary); font-style: italic;">
                                    +{{ prop.other_count - 5 }} more
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        {% else %}
                        <span style="color: var(--text-tertiary);">--</span>
                        {% endif %}
                    </td>
                    <td class="date-cell">
                        {{ prop.last_viewed[:10] if prop.last_viewed else '--' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="properties-viewed-empty">
            <p>No property views recorded yet.</p>
            <p style="font-size: 13px; margin-top: 8px;">Property views will appear after the next FUB sync.</p>
        </div>
        {% endif %}
    </div>

    <!-- Score Trend Chart -->
    {% if trend_summary and trend_summary.scoring_history %}
    <div class="trend-chart-container">
        <h3 class="section-title">Heat Score Trend (7 Days)</h3>
        <div class="trend-chart">
            {% for record in trend_summary.scoring_history|reverse %}
            <div class="trend-bar"
                 style="height: {{ record.heat_score }}%;"
                 title="{{ record.recorded_at[:10] }}: {{ record.heat_score }}">
            </div>
            {% endfor %}
        </div>
        <div class="trend-summary">
            <div class="trend-summary-item">
                <div class="trend-summary-value">{{ trend_summary.heat_score_7d_avg or '--' }}</div>
                <div class="trend-summary-label">7-Day Avg</div>
            </div>
            <div class="trend-summary-item">
                <div class="trend-summary-value">
                    {% if trend_summary.heat_delta %}
                    {{ '%+.1f'|format(trend_summary.heat_delta) }}
                    {% else %}--{% endif %}
                </div>
                <div class="trend-summary-label">Change</div>
            </div>
            <div class="trend-summary-item">
                <div class="trend-summary-value">{{ trend_summary.communications_this_week or 0 }}</div>
                <div class="trend-summary-label">Comms This Week</div>
            </div>
            <div class="trend-summary-item">
                <div class="trend-summary-value">{{ trend_summary.events_this_week or 0 }}</div>
                <div class="trend-summary-label">Events This Week</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Activity Timeline -->
    <div class="activity-timeline">
        <h3 class="section-title">Activity Timeline (Last 30 Days)</h3>
        {% if timeline and timeline|length > 0 %}
        <ul class="timeline-list">
            {% for item in timeline %}
            <li class="timeline-item">
                <div class="timeline-icon {{ item.activity_type }}">
                    {% if item.activity_type == 'call' %}
                    &#128222;
                    {% elif item.activity_type == 'text' %}
                    &#128172;
                    {% elif item.activity_type == 'website_visit' %}
                    &#127760;
                    {% elif item.activity_type == 'property_view' %}
                    &#128065;
                    {% elif item.activity_type == 'property_favorite' %}
                    &#10084;
                    {% elif item.activity_type == 'property_share' %}
                    &#128228;
                    {% else %}
                    &#128196;
                    {% endif %}
                </div>
                <div class="timeline-content">
                    <div class="timeline-title">
                        {% if item.activity_type == 'call' %}
                        {{ item.direction|capitalize }} Call
                        {% if item.duration_seconds %}({{ (item.duration_seconds / 60)|int }} min){% endif %}
                        {% elif item.activity_type == 'text' %}
                        {{ item.direction|capitalize }} Text
                        {% elif item.activity_type == 'website_visit' %}
                        Website Visit
                        {% elif item.activity_type == 'property_view' %}
                        Viewed Property
                        {% elif item.activity_type == 'property_favorite' %}
                        Favorited Property
                        {% elif item.activity_type == 'property_share' %}
                        Shared Property
                        {% else %}
                        {{ item.activity_type|replace('_', ' ')|title }}
                        {% endif %}
                    </div>
                    <div class="timeline-subtitle">
                        {% if item.property_address %}
                        {{ item.property_address }}
                        {% if item.property_price %}(${{ "{:,.0f}".format(item.property_price) }}){% endif %}
                        {% elif item.fub_user_name %}
                        Agent: {{ item.fub_user_name }}
                        {% endif %}
                    </div>
                </div>
                <div class="timeline-time">
                    {{ item.occurred_at[:10] if item.occurred_at else '' }}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="timeline-empty">
            <p>No activity recorded in the last 30 days.</p>
            <p style="font-size: 13px; margin-top: 8px;">Activity data will appear after the next FUB sync.</p>
        </div>
        {% endif %}
    </div>

    <!-- Linked Properties -->
    {% if properties %}
    <div class="properties-section">
        <h3 class="section-title">Linked Properties ({{ properties|length }})</h3>
        <div class="dreams-table-container">
            <table class="dreams-table">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>City</th>
                        <th>Price</th>
                        <th>Beds</th>
                        <th>Baths</th>
                        <th>Status</th>
                        <th>Relationship</th>
                        <th>Match Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prop in properties %}
                    <tr>
                        <td><a href="/property/{{ prop.property_id }}" class="dreams-link">{{ prop.address or 'Unknown' }}</a></td>
                        <td>{{ prop.city or '-' }}</td>
                        <td class="dreams-price">{{ "${:,.0f}".format(prop.price) if prop.price else '-' }}</td>
                        <td>{{ prop.beds or '-' }}</td>
                        <td>{{ prop.baths or '-' }}</td>
                        <td>
                            <span class="dreams-badge dreams-badge-{{ (prop.status or 'unknown')|lower|replace(' ', '-') }}">
                                {{ prop.status or 'Unknown' }}
                            </span>
                        </td>
                        <td>{{ prop.relationship or '-' }}</td>
                        <td>{{ "%.0f"|format(prop.match_score) if prop.match_score else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Footer -->
    <footer class="dreams-footer">
        DREAMS - Desktop Real Estate Agent Management System
    </footer>

    <!-- Sorting JavaScript for Properties Viewed table -->
    <script>
        let sortDirection = {};

        function sortPropertiesTable(columnIndex, dataType) {
            const table = document.getElementById('properties-viewed-table');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('th')[columnIndex];

            // Toggle sort direction
            const currentDir = sortDirection[columnIndex] || 'none';
            let newDir;
            if (currentDir === 'none') newDir = 'asc';
            else if (currentDir === 'asc') newDir = 'desc';
            else newDir = 'none';

            sortDirection[columnIndex] = newDir;

            // Clear all header sort indicators
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            // If returning to unsorted, restore original order
            if (newDir === 'none') {
                rows.sort((a, b) => {
                    return parseInt(a.dataset.originalIndex || 0) - parseInt(b.dataset.originalIndex || 0);
                });
            } else {
                // Add sort indicator to current header
                header.classList.add(newDir === 'asc' ? 'sorted-asc' : 'sorted-desc');

                rows.sort((a, b) => {
                    let aVal = a.cells[columnIndex].textContent.trim();
                    let bVal = b.cells[columnIndex].textContent.trim();

                    // Handle different data types
                    if (dataType === 'number') {
                        aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                    } else if (dataType === 'date') {
                        aVal = new Date(aVal) || new Date(0);
                        bVal = new Date(bVal) || new Date(0);
                    } else {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (aVal < bVal) return newDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return newDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Reattach sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Store original order on page load
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('properties-viewed-table');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    row.dataset.originalIndex = index;
                });
            }
        });
    </script>
</body>
</html>
