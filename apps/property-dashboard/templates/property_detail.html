<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ property.address }} | DREAMS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% if google_maps_key %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places" async defer></script>
    {% endif %}
    <style>
        /* ── Design tokens (matching dashboard.html) ── */
        :root {
            --dash-primary: #082d40;
            --dash-primary-light: #0a3d56;
            --dash-accent: #ddab4a;
            --dash-accent-hover: #c9982e;
            --dash-eggshell: #f5f2ed;
            --dash-text: #4e4e4e;
            --dash-text-light: #6b6b6b;
            --dash-border: #e5e1db;
        }

        .main-content {
            background: var(--dash-eggshell);
            font-family: 'Open Sans', system-ui, sans-serif;
            color: var(--dash-text);
            min-height: 100vh;
        }

        /* ── Action Bar ── */
        .detail-action-bar {
            background: var(--dash-primary);
            color: #fff;
            padding: 12px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .detail-action-bar a,
        .detail-action-bar button {
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            font-family: inherit;
        }
        .action-back {
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.8;
        }
        .action-back:hover { opacity: 1; }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.25);
            background: transparent;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: inherit;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); }
        .action-btn.accent {
            background: var(--dash-accent);
            color: var(--dash-primary);
            border-color: var(--dash-accent);
        }
        .action-btn.accent:hover { background: var(--dash-accent-hover); }

        /* ── Photo Browser ── */
        .photo-browser {
            max-width: 100%;
            margin: 0 0 24px 0;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            max-height: 480px;
            overflow: hidden;
            background: #1a1a1a;
        }
        .photo-grid-main {
            grid-row: span 2;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .photo-grid-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s;
        }
        .photo-grid-main:hover img { filter: brightness(0.9); }
        .photo-grid-secondary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
        }
        .photo-grid-thumb {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            aspect-ratio: 4/3;
        }
        .photo-grid-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s;
        }
        .photo-grid-thumb:hover img { filter: brightness(0.9); }
        .photo-count-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .photo-count-overlay:hover { background: rgba(0,0,0,0.6); }
        .photo-count-label {
            background: rgba(255,255,255,0.85);
            color: var(--dash-primary);
            font-size: 13px;
            font-weight: 600;
            padding: 8px 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .photo-placeholder {
            aspect-ratio: 16/9;
            max-height: 300px;
            background: #e5e1db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dash-text-light);
            font-size: 14px;
        }
        .photo-placeholder svg { width: 48px; height: 48px; margin-bottom: 8px; }
        .photo-mobile-all {
            display: none;
            width: 100%;
            padding: 10px;
            background: var(--dash-primary);
            color: #fff;
            border: none;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        /* ── Lightbox ── */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.95);
            flex-direction: column;
        }
        .lightbox.open { display: flex; }
        .lightbox-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            color: #fff;
        }
        .lightbox-counter { font-size: 14px; color: rgba(255,255,255,0.6); }
        .lightbox-address { font-size: 13px; color: rgba(255,255,255,0.4); }
        .lightbox-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 24px;
        }
        .lightbox-close:hover { color: #fff; }
        .lightbox-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 0;
            padding: 0 16px;
        }
        .lightbox-body img {
            max-width: 90%;
            max-height: 100%;
            object-fit: contain;
        }
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
        }
        .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
        .lightbox-nav.prev { left: 16px; }
        .lightbox-nav.next { right: 16px; }
        .lightbox-thumbs {
            padding: 16px 24px;
            overflow-x: auto;
        }
        .lightbox-thumb-strip {
            display: flex;
            gap: 6px;
            justify-content: center;
        }
        .lightbox-thumb {
            width: 64px;
            height: 48px;
            flex-shrink: 0;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s;
            border: 2px solid transparent;
        }
        .lightbox-thumb:hover { opacity: 0.7; }
        .lightbox-thumb.active {
            opacity: 1;
            border-color: var(--dash-accent);
        }
        .lightbox-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ── Property Header ── */
        .prop-header {
            padding: 24px 28px;
            background: #fff;
            border-bottom: 1px solid var(--dash-border);
        }
        .prop-price {
            font-family: Georgia, serif;
            font-size: 28px;
            color: var(--dash-primary);
            margin: 0 0 4px 0;
        }
        .prop-price .original-price {
            font-size: 16px;
            color: var(--dash-text-light);
            text-decoration: line-through;
            margin-left: 12px;
            font-weight: normal;
        }
        .prop-address {
            font-size: 18px;
            font-weight: 600;
            color: var(--dash-text);
            margin: 0 0 2px 0;
        }
        .prop-location {
            font-size: 14px;
            color: var(--dash-text-light);
            margin-bottom: 14px;
        }
        .prop-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .prop-stat {
            text-align: center;
        }
        .prop-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--dash-primary);
        }
        .prop-stat-label {
            font-size: 11px;
            color: var(--dash-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .prop-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .prop-badge {
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge-active { background: var(--dash-accent); color: var(--dash-primary); }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-sold { background: #dcfce7; color: #166534; }
        .badge-type { background: #e0e7ff; color: #3730a3; }
        .badge-dom { background: #f3f4f6; color: #4b5563; }
        .badge-flood { background: #fef3c7; color: #92400e; }
        .badge-flood.high { background: #fee2e2; color: #991b1b; }
        .badge-elevation { background: #e0f2fe; color: #0369a1; }
        .badge-view { background: #dcfce7; color: #166534; }
        .badge-wildfire { background: #fef3c7; color: #92400e; }
        .badge-wildfire.high { background: #fee2e2; color: #991b1b; }

        /* ── Content Grid ── */
        .detail-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            padding: 24px 28px;
            align-items: start;
        }

        /* ── Section Toggle System ── */
        .detail-section {
            background: #fff;
            border: 1px solid var(--dash-border);
            margin-bottom: 16px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover { background: #faf9f7; }
        .section-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--dash-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .section-toggle-icon {
            font-size: 12px;
            color: var(--dash-text-light);
            transition: transform 0.2s;
        }
        .detail-section.collapsed .section-body { display: none; }
        .detail-section.collapsed .section-toggle-icon { transform: rotate(-90deg); }
        .section-body {
            padding: 0 20px 20px 20px;
            border-top: 1px solid var(--dash-border);
        }
        .section-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            font-size: 12px;
        }
        .section-controls a {
            color: var(--dash-accent);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }
        .section-controls a:hover { color: var(--dash-accent-hover); }

        /* ── Field Grids ── */
        .facts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
        }
        .fact-item {
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .fact-label {
            font-size: 11px;
            color: var(--dash-text-light);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 2px;
        }
        .fact-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--dash-text);
        }
        .fact-value.price {
            font-family: Georgia, serif;
            color: var(--dash-primary);
        }

        /* ── Tag Pills ── */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-top: 12px;
        }
        .tag-pill {
            padding: 5px 14px;
            border: 1px solid var(--dash-border);
            font-size: 13px;
            color: var(--dash-text);
            background: #faf9f7;
        }

        /* ── Description ── */
        .description-text {
            font-size: 14px;
            line-height: 1.7;
            color: var(--dash-text);
            padding-top: 12px;
        }
        .directions-text {
            margin-top: 16px;
            padding: 12px 16px;
            background: #faf9f7;
            border-left: 3px solid var(--dash-accent);
            font-size: 13px;
            color: var(--dash-text-light);
        }
        .directions-text strong { color: var(--dash-text); }

        /* ── Private Section ── */
        .section-private .section-body {
            background: #fdf8f0;
        }
        .private-badge {
            font-size: 10px;
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        /* ── Sidebar Cards ── */
        .sidebar-card {
            background: #fff;
            border: 1px solid var(--dash-border);
            margin-bottom: 16px;
        }
        .sidebar-card-header {
            padding: 14px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--dash-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--dash-border);
        }
        .sidebar-card-body { padding: 16px; }

        /* Agent Card */
        .agent-card {
            border-left: 3px solid var(--dash-accent);
        }
        .agent-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .agent-photo {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            background: #e5e1db;
            flex-shrink: 0;
        }
        .agent-photo-placeholder {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--dash-primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }
        .agent-details { flex: 1; }
        .agent-name { font-weight: 600; font-size: 14px; color: var(--dash-text); }
        .agent-office { font-size: 12px; color: var(--dash-text-light); margin-top: 2px; }
        .agent-contact {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .agent-contact a {
            font-size: 13px;
            color: var(--dash-primary);
            text-decoration: none;
        }
        .agent-contact a:hover { color: var(--dash-accent); }
        .agent-divider {
            border: 0;
            border-top: 1px solid var(--dash-border);
            margin: 14px 0;
        }
        .agent-section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--dash-text-light);
            margin-bottom: 6px;
        }

        /* Map Card */
        .map-card-wrapper { position: relative; }
        .map-container { height: 350px; background: #e5e1db; }
        .map-expand-btn {
            position: absolute;
            top: 46px;
            right: 8px;
            z-index: 5;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1px solid var(--dash-border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            cursor: pointer;
            color: var(--dash-text);
        }
        .map-expand-btn:hover { background: #f5f5f5; }
        .map-expand-btn svg { width: 16px; height: 16px; }

        /* Map Lightbox */
        .map-lightbox {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.92);
            flex-direction: column;
        }
        .map-lightbox.open { display: flex; }
        .map-lightbox-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--dash-primary);
            color: #fff;
            flex-shrink: 0;
        }
        .map-lightbox-title {
            font-size: 14px;
            font-weight: 600;
        }
        .map-lightbox-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 22px;
        }
        .map-lightbox-close:hover { color: #fff; }
        .map-lightbox-tabs {
            display: flex;
            flex-shrink: 0;
        }
        .map-lightbox-tabs .map-view-tab {
            padding: 12px 20px;
            font-size: 12px;
        }
        .map-lightbox-body {
            flex: 1;
            min-height: 0;
            position: relative;
        }
        .map-lightbox-body #mapBody {
            height: 100%;
        }
        .map-lightbox-body .map-container {
            height: 100% !important;
        }
        .map-lightbox-footer {
            flex-shrink: 0;
        }
        .map-lightbox-footer .poi-chips {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
        }
        .map-lightbox-footer .poi-chip {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
        }
        .map-lightbox-footer .poi-chip:hover {
            border-color: rgba(255,255,255,0.4);
            color: #fff;
        }
        .map-lightbox-footer .poi-chip.active {
            background: var(--dash-accent);
            border-color: var(--dash-accent);
            color: var(--dash-primary);
        }
        .map-lightbox-footer .map-directions {
            margin: 0 20px 12px 20px;
        }
        .map-view-tabs {
            display: flex;
            border-bottom: 1px solid var(--dash-border);
        }
        .map-view-tab {
            flex: 1;
            padding: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            background: #fff;
            color: var(--dash-text-light);
            cursor: pointer;
            font-family: inherit;
        }
        .map-view-tab:hover { background: #faf9f7; }
        .map-view-tab.active {
            background: var(--dash-accent);
            color: var(--dash-primary);
        }
        .poi-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 12px;
            border-top: 1px solid var(--dash-border);
        }
        .poi-chip {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 10px;
            border: 1px solid var(--dash-border);
            background: #fff;
            font-size: 11px;
            font-weight: 500;
            color: var(--dash-text-light);
            cursor: pointer;
            font-family: inherit;
        }
        .poi-chip:hover { border-color: #ccc; }
        .poi-chip.active {
            background: var(--dash-accent);
            border-color: var(--dash-accent);
            color: var(--dash-primary);
        }
        .poi-chip .poi-icon { font-size: 12px; }
        .map-directions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--dash-primary);
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .map-directions:hover { background: var(--dash-primary-light); }

        /* Spatial Analysis */
        .spatial-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .spatial-item {
            padding: 10px;
            background: #faf9f7;
        }
        .spatial-label {
            font-size: 11px;
            color: var(--dash-text-light);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .spatial-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--dash-text);
        }
        .spatial-value.good { color: #059669; }
        .spatial-value.warning { color: #dc2626; }
        .spatial-source {
            font-size: 11px;
            color: var(--dash-text-light);
            margin-top: 10px;
        }

        /* Changes Card */
        .change-item {
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .change-item:last-child { border-bottom: none; }
        .change-type {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--dash-text-light);
        }
        .change-values {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        .change-old { color: var(--dash-text-light); text-decoration: line-through; font-size: 13px; }
        .change-arrow { color: var(--dash-text-light); font-size: 12px; }
        .change-new { color: var(--dash-primary); font-weight: 600; font-size: 13px; }
        .change-amount {
            font-size: 11px;
            padding: 2px 6px;
            margin-left: auto;
        }
        .change-amount.decrease { background: #dcfce7; color: #166534; }
        .change-amount.increase { background: #fee2e2; color: #991b1b; }
        .change-date { font-size: 11px; color: var(--dash-text-light); margin-top: 2px; }

        /* Contacts Card */
        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .contact-item:last-child { border-bottom: none; }
        .contact-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--dash-primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            flex-shrink: 0;
        }
        .contact-name { font-weight: 500; font-size: 13px; }
        .contact-name a { color: var(--dash-text); text-decoration: none; }
        .contact-name a:hover { color: var(--dash-primary); }
        .contact-status { font-size: 12px; color: var(--dash-text-light); }

        /* External Links */
        .ext-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .ext-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            color: #fff;
        }
        .ext-link:hover { opacity: 0.9; }
        .ext-redfin { background: #a61d2e; }
        .ext-zillow { background: #006aff; }
        .ext-idx { background: var(--dash-primary); }
        .ext-mls { background: #059669; }

        /* Documents */
        .doc-list { padding-top: 12px; }
        .doc-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--dash-text);
        }
        .doc-icon { color: var(--dash-text-light); }
        .doc-note {
            margin-top: 12px;
            font-size: 12px;
            color: var(--dash-text-light);
            padding: 8px 12px;
            background: #faf9f7;
        }

        /* Chart */
        .chart-container { padding-top: 12px; }
        .chart-wrapper { height: 250px; }
        .no-chart-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: var(--dash-text-light);
            font-size: 13px;
        }

        /* Print Styles */
        @media print {
            .sidebar, .detail-action-bar, .action-buttons,
            .poi-chips, .map-directions, .lightbox,
            .photo-mobile-all, .section-controls { display: none !important; }
            .main-content { margin-left: 0 !important; }
            .detail-content { grid-template-columns: 1fr 300px; }
            .detail-section { break-inside: avoid; }
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .detail-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .photo-grid { grid-template-columns: 1fr; max-height: 300px; }
            .photo-grid-main { grid-row: span 1; }
            .photo-grid-secondary { display: none; }
            .photo-mobile-all { display: block; }
            .prop-header { padding: 16px; }
            .detail-content { padding: 16px; }
            .facts-grid { grid-template-columns: repeat(2, 1fr); }
            .detail-action-bar { padding: 10px 16px; }
            .action-buttons { gap: 4px; }
            .lightbox-address { display: none; }
        }

        /* Street View container */
        .streetview-container {
            width: 100%;
            height: 100%;
        }
        .streetview-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--dash-text-light);
            font-size: 13px;
            background: #faf9f7;
        }
    </style>
</head>
{% set active_nav = 'properties' %}
<body>
    {% include 'partials/sidebar.html' %}
    <div class="main-content">

        {# ── Action Bar ── #}
        <div class="detail-action-bar">
            <a href="/properties" class="action-back">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Properties
            </a>
            <div class="action-buttons">
                {% if property.mls_number %}
                <button class="action-btn" onclick="copyMLS()" title="Copy MLS #">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" stroke-width="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke-width="2"/></svg>
                    MLS# {{ property.mls_number }}
                </button>
                {% endif %}
                {% if property.mls_url %}
                <a href="{{ property.mls_url }}" target="_blank" class="action-btn">Open in MLS</a>
                {% endif %}
                {% if directions_url %}
                <a href="{{ directions_url }}" target="_blank" class="action-btn">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Directions
                </a>
                {% endif %}
                {% if property.virtual_tour_url %}
                <a href="{{ property.virtual_tour_url }}" target="_blank" class="action-btn accent">Virtual Tour</a>
                {% endif %}
                <button class="action-btn" onclick="window.print()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                    Print
                </button>
            </div>
        </div>

        {# ── Photo Browser ── #}
        <div class="photo-browser">
            {% if property.photos and property.photos|length > 0 %}
            <div class="photo-grid">
                <div class="photo-grid-main" onclick="openLightbox(0)">
                    <img src="{{ property.photos[0] }}" alt="{{ property.address }}">
                </div>
                {% if property.photos|length > 1 %}
                <div class="photo-grid-secondary">
                    {% for photo in property.photos[1:5] %}
                    <div class="photo-grid-thumb" onclick="openLightbox({{ loop.index }})">
                        <img src="{{ photo }}" alt="Photo {{ loop.index + 1 }}" loading="lazy">
                        {% if loop.index == 4 and property.photos|length > 5 %}
                        <div class="photo-count-overlay" onclick="openLightbox(4)">
                            <span class="photo-count-label">All {{ property.photos|length }} Photos</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if property.photos|length > 1 %}
            <button class="photo-mobile-all" onclick="openLightbox(0)">
                View All {{ property.photos|length }} Photos
            </button>
            {% endif %}
            {% else %}
            <div class="photo-placeholder">
                <div style="text-align: center;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>
                    <div>No Photos Available</div>
                </div>
            </div>
            {% endif %}
        </div>

        {# ── Property Header ── #}
        <div class="prop-header">
            <div class="prop-price">
                {% if property.price %}
                ${{ "{:,.0f}".format(property.price) }}
                {% endif %}
                {% if property.original_list_price and property.original_list_price != property.price %}
                <span class="original-price">${{ "{:,.0f}".format(property.original_list_price) }}</span>
                {% endif %}
            </div>
            <h1 class="prop-address">{{ property.address }}</h1>
            <div class="prop-location">
                {{ property.city }}{% if property.state %}, {{ property.state }}{% endif %}{% if property.zip %} {{ property.zip }}{% endif %}
                {% if property.county %} ({{ property.county }} County){% endif %}
            </div>

            <div class="prop-stats">
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ property.beds or '-' }}</div>
                    <div class="prop-stat-label">Beds</div>
                </div>
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ property.baths or '-' }}</div>
                    <div class="prop-stat-label">Baths</div>
                </div>
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ "{:,.0f}".format(property.sqft) if property.sqft else '-' }}</div>
                    <div class="prop-stat-label">Sq Ft</div>
                </div>
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ "{:,.2f}".format(property.acreage) if property.acreage else '-' }}</div>
                    <div class="prop-stat-label">Acres</div>
                </div>
                {% if property.year_built %}
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ property.year_built }}</div>
                    <div class="prop-stat-label">Year Built</div>
                </div>
                {% endif %}
                {% if property.stories %}
                <div class="prop-stat">
                    <div class="prop-stat-value">{{ property.stories }}</div>
                    <div class="prop-stat-label">Stories</div>
                </div>
                {% endif %}
            </div>

            <div class="prop-badges">
                {% set status_lower = (property.status or 'active')|lower %}
                <span class="prop-badge {% if status_lower == 'active' %}badge-active{% elif status_lower == 'pending' %}badge-pending{% elif status_lower in ['sold', 'closed'] %}badge-sold{% else %}badge-dom{% endif %}">
                    {{ property.status or 'Active' }}
                </span>
                {% if property.property_type %}
                <span class="prop-badge badge-type">{{ property.property_type }}</span>
                {% endif %}
                {% if property.property_subtype %}
                <span class="prop-badge badge-type">{{ property.property_subtype }}</span>
                {% endif %}
                {% if property.days_on_market %}
                <span class="prop-badge badge-dom">{{ property.days_on_market }} DOM</span>
                {% endif %}
                {% if property.flood_zone and property.flood_zone != 'X' %}
                <span class="prop-badge badge-flood {% if property.flood_factor and property.flood_factor >= 6 %}high{% endif %}">
                    Flood: {{ property.flood_zone }}
                </span>
                {% endif %}
                {% if property.elevation_feet %}
                <span class="prop-badge badge-elevation">{{ "{:,}".format(property.elevation_feet) }} ft</span>
                {% endif %}
                {% if property.view_potential and property.view_potential >= 7 %}
                <span class="prop-badge badge-view">Mountain Views</span>
                {% endif %}
                {% if property.wildfire_risk and property.wildfire_risk|lower in ['high', 'very high'] %}
                <span class="prop-badge badge-wildfire high">Fire Risk: {{ property.wildfire_risk }}</span>
                {% endif %}
            </div>
        </div>

        {# ── Section Controls ── #}
        <div class="section-controls" style="padding: 12px 28px 0 28px;">
            <a onclick="expandAll()">Expand All</a>
            <a onclick="collapseAll()">Collapse All</a>
        </div>

        {# ── Content Grid ── #}
        <div class="detail-content">
            {# ══ Main Column ══ #}
            <div class="main-column">

                {# ── Description ── #}
                {% if property.public_remarks or property.directions %}
                <div class="detail-section" data-section="description">
                    <div class="section-header" onclick="toggleSection('description')">
                        <h3>Description</h3>
                        <span class="section-toggle-icon" id="toggle-description">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-description">
                        {% if property.public_remarks %}
                        <div class="description-text">{{ property.public_remarks }}</div>
                        {% endif %}
                        {% if property.directions %}
                        <div class="directions-text">
                            <strong>Directions:</strong> {{ property.directions }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ── Property Facts ── #}
                <div class="detail-section" data-section="facts">
                    <div class="section-header" onclick="toggleSection('facts')">
                        <h3>Property Facts</h3>
                        <span class="section-toggle-icon" id="toggle-facts">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-facts">
                        <div class="facts-grid">
                            <div class="fact-item">
                                <div class="fact-label">MLS Number</div>
                                <div class="fact-value">{{ property.mls_number or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">MLS Source</div>
                                <div class="fact-value">{{ property.mls_source or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Status</div>
                                <div class="fact-value">{{ property.status or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">List Date</div>
                                <div class="fact-value">{{ property.list_date or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Days on Market</div>
                                <div class="fact-value">{{ property.days_on_market or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Property Type</div>
                                <div class="fact-value">{{ property.property_type or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Subtype</div>
                                <div class="fact-value">{{ property.property_subtype or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Style</div>
                                <div class="fact-value">{{ property.style|join(', ') if property.style else '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Year Built</div>
                                <div class="fact-value">{{ property.year_built or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Bedrooms</div>
                                <div class="fact-value">{{ property.beds or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Bathrooms</div>
                                <div class="fact-value">{{ property.baths or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Square Feet</div>
                                <div class="fact-value">{{ "{:,.0f}".format(property.sqft) if property.sqft else '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Lot Sqft</div>
                                <div class="fact-value">{{ "{:,.0f}".format(property.lot_sqft) if property.lot_sqft else '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Acreage</div>
                                <div class="fact-value">{{ "{:,.2f}".format(property.acreage) if property.acreage else '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Stories</div>
                                <div class="fact-value">{{ property.stories or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Garage</div>
                                <div class="fact-value">{{ property.garage or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Garage Spaces</div>
                                <div class="fact-value">{{ property.garage_spaces or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Subdivision</div>
                                <div class="fact-value">{{ property.subdivision or '-' }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                {# ── Interior Features ── #}
                {% if property.interior_features %}
                <div class="detail-section" data-section="interior">
                    <div class="section-header" onclick="toggleSection('interior')">
                        <h3>Interior Features</h3>
                        <span class="section-toggle-icon" id="toggle-interior">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-interior">
                        <div class="tag-list">
                            {% for feat in property.interior_features %}
                            <span class="tag-pill">{{ feat }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Exterior Features ── #}
                {% if property.exterior_features %}
                <div class="detail-section" data-section="exterior">
                    <div class="section-header" onclick="toggleSection('exterior')">
                        <h3>Exterior Features</h3>
                        <span class="section-toggle-icon" id="toggle-exterior">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-exterior">
                        <div class="tag-list">
                            {% for feat in property.exterior_features %}
                            <span class="tag-pill">{{ feat }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Heating & Cooling ── #}
                {% if property.heating or property.cooling %}
                <div class="detail-section" data-section="hvac">
                    <div class="section-header" onclick="toggleSection('hvac')">
                        <h3>Heating &amp; Cooling</h3>
                        <span class="section-toggle-icon" id="toggle-hvac">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-hvac">
                        <div class="tag-list">
                            {% for item in property.heating %}
                            <span class="tag-pill">Heating: {{ item }}</span>
                            {% endfor %}
                            {% for item in property.cooling %}
                            <span class="tag-pill">Cooling: {{ item }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Appliances ── #}
                {% if property.appliances %}
                <div class="detail-section" data-section="appliances">
                    <div class="section-header" onclick="toggleSection('appliances')">
                        <h3>Appliances</h3>
                        <span class="section-toggle-icon" id="toggle-appliances">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-appliances">
                        <div class="tag-list">
                            {% for item in property.appliances %}
                            <span class="tag-pill">{{ item }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Construction & Structure ── #}
                {% if property.construction_materials or property.foundation or property.roof or property.flooring or property.fireplace_features or property.water_source or property.sewer or property.parking_features %}
                <div class="detail-section" data-section="construction">
                    <div class="section-header" onclick="toggleSection('construction')">
                        <h3>Construction &amp; Structure</h3>
                        <span class="section-toggle-icon" id="toggle-construction">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-construction">
                        <div class="facts-grid">
                            {% if property.construction_materials %}
                            <div class="fact-item">
                                <div class="fact-label">Construction</div>
                                <div class="fact-value">{{ property.construction_materials|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.foundation %}
                            <div class="fact-item">
                                <div class="fact-label">Foundation</div>
                                <div class="fact-value">{{ property.foundation|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.roof %}
                            <div class="fact-item">
                                <div class="fact-label">Roof</div>
                                <div class="fact-value">{{ property.roof|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.flooring %}
                            <div class="fact-item">
                                <div class="fact-label">Flooring</div>
                                <div class="fact-value">{{ property.flooring|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.fireplace_features %}
                            <div class="fact-item">
                                <div class="fact-label">Fireplace</div>
                                <div class="fact-value">{{ property.fireplace_features|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.water_source %}
                            <div class="fact-item">
                                <div class="fact-label">Water Source</div>
                                <div class="fact-value">{{ property.water_source|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.sewer %}
                            <div class="fact-item">
                                <div class="fact-label">Sewer</div>
                                <div class="fact-value">{{ property.sewer|join(', ') }}</div>
                            </div>
                            {% endif %}
                            {% if property.parking_features %}
                            <div class="fact-item">
                                <div class="fact-label">Parking</div>
                                <div class="fact-value">{{ property.parking_features|join(', ') }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Financial ── #}
                <div class="detail-section" data-section="financial">
                    <div class="section-header" onclick="toggleSection('financial')">
                        <h3>Financial</h3>
                        <span class="section-toggle-icon" id="toggle-financial">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-financial">
                        <div class="facts-grid">
                            <div class="fact-item">
                                <div class="fact-label">List Price</div>
                                <div class="fact-value price">${{ "{:,.0f}".format(property.price) if property.price else '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Original List Price</div>
                                <div class="fact-value price">${{ "{:,.0f}".format(property.original_list_price) if property.original_list_price else '-' }}</div>
                            </div>
                            {% if property.sold_price %}
                            <div class="fact-item">
                                <div class="fact-label">Sold Price</div>
                                <div class="fact-value price">${{ "{:,.0f}".format(property.sold_price) }}</div>
                            </div>
                            {% endif %}
                            {% if property.sold_date %}
                            <div class="fact-item">
                                <div class="fact-label">Sold Date</div>
                                <div class="fact-value">{{ property.sold_date }}</div>
                            </div>
                            {% endif %}
                            <div class="fact-item">
                                <div class="fact-label">HOA Fee</div>
                                <div class="fact-value price">
                                    {% if property.hoa_fee %}
                                    ${{ "{:,.0f}".format(property.hoa_fee) }}
                                    {% if property.hoa_frequency %} / {{ property.hoa_frequency }}{% endif %}
                                    {% else %}-{% endif %}
                                </div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Tax Annual</div>
                                <div class="fact-value price">
                                    {% if property.tax_annual_amount %}
                                    ${{ "{:,.0f}".format(property.tax_annual_amount) }}
                                    {% if property.tax_year %} ({{ property.tax_year }}){% endif %}
                                    {% else %}-{% endif %}
                                </div>
                            </div>
                            {% if property.tax_assessed_value %}
                            <div class="fact-item">
                                <div class="fact-label">Assessed Value</div>
                                <div class="fact-value price">${{ "{:,.0f}".format(property.tax_assessed_value) }}</div>
                            </div>
                            {% endif %}
                            {% if price_per_sqft %}
                            <div class="fact-item">
                                <div class="fact-label">Price / Sq Ft</div>
                                <div class="fact-value price">${{ "{:,.0f}".format(price_per_sqft) }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# ── Location & Access ── #}
                <div class="detail-section" data-section="location">
                    <div class="section-header" onclick="toggleSection('location')">
                        <h3>Location &amp; Access</h3>
                        <span class="section-toggle-icon" id="toggle-location">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-location">
                        <div class="facts-grid">
                            <div class="fact-item">
                                <div class="fact-label">Parcel Number</div>
                                <div class="fact-value">
                                    {% if property.parcel_number %}
                                        {% if gis_url %}
                                        <a href="{{ gis_url }}" target="_blank" style="color: var(--dash-primary); text-decoration: none; border-bottom: 1px dashed var(--dash-accent);">{{ property.parcel_number }}</a>
                                        {% else %}
                                        {{ property.parcel_number }}
                                        {% endif %}
                                    {% else %}-{% endif %}
                                </div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">County</div>
                                <div class="fact-value">{{ property.county or '-' }}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Subdivision</div>
                                <div class="fact-value">{{ property.subdivision or '-' }}</div>
                            </div>
                            {% if property.latitude and property.longitude %}
                            <div class="fact-item">
                                <div class="fact-label">Coordinates</div>
                                <div class="fact-value">{{ "%.5f"|format(property.latitude) }}, {{ "%.5f"|format(property.longitude) }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# ── Documents ── #}
                {% if property.documents_available or property.documents_count %}
                <div class="detail-section" data-section="documents">
                    <div class="section-header" onclick="toggleSection('documents')">
                        <h3>Documents</h3>
                        <span class="section-toggle-icon" id="toggle-documents">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-documents">
                        {% if property.documents_available %}
                        <div class="doc-list">
                            {% for doc in property.documents_available %}
                            <div class="doc-item">
                                <span class="doc-icon">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                </span>
                                {{ doc }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if property.documents_count %}
                        <div class="doc-note">
                            {{ property.documents_count }} document{{ 's' if property.documents_count != 1 else '' }} available in MLS
                            {% if property.mls_url %}
                            &middot; <a href="{{ property.mls_url }}" target="_blank" style="color: var(--dash-primary);">View in MLS Portal</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ── MLS Details (Private) ── #}
                {% if property.private_remarks or property.showing_instructions or property.expiration_date or property.modification_timestamp %}
                <div class="detail-section section-private" data-section="mls-private">
                    <div class="section-header" onclick="toggleSection('mls-private')">
                        <h3>MLS Details <span class="private-badge">Private</span></h3>
                        <span class="section-toggle-icon" id="toggle-mls-private">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-mls-private">
                        {% if property.private_remarks %}
                        <div style="margin-bottom: 16px;">
                            <div class="fact-label">Private Remarks</div>
                            <div class="description-text" style="padding-top: 4px;">{{ property.private_remarks }}</div>
                        </div>
                        {% endif %}
                        {% if property.showing_instructions %}
                        <div style="margin-bottom: 16px;">
                            <div class="fact-label">Showing Instructions</div>
                            <div class="description-text" style="padding-top: 4px;">{{ property.showing_instructions }}</div>
                        </div>
                        {% endif %}
                        <div class="facts-grid" style="grid-template-columns: 1fr 1fr;">
                            {% if property.expiration_date %}
                            <div class="fact-item">
                                <div class="fact-label">Expiration Date</div>
                                <div class="fact-value">{{ property.expiration_date }}</div>
                            </div>
                            {% endif %}
                            {% if property.modification_timestamp %}
                            <div class="fact-item">
                                <div class="fact-label">Last Modified</div>
                                <div class="fact-value">{{ property.modification_timestamp[:16] if property.modification_timestamp|length > 16 else property.modification_timestamp }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ── Price History ── #}
                <div class="detail-section" data-section="price-history">
                    <div class="section-header" onclick="toggleSection('price-history')">
                        <h3>Price History</h3>
                        <span class="section-toggle-icon" id="toggle-price-history">&#9660;</span>
                    </div>
                    <div class="section-body" id="body-price-history">
                        {% if price_history and price_history|length > 1 %}
                        <div class="chart-container">
                            <div class="chart-wrapper">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                        {% else %}
                        <div class="no-chart-data">
                            No price changes recorded for this property
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>

            {# ══ Sidebar Column ══ #}
            <div class="sidebar-column">

                {# ── Agent Info ── #}
                {% if agent_info and agent_info.name %}
                <div class="sidebar-card agent-card">
                    <div class="sidebar-card-header">Listing Agent</div>
                    <div class="sidebar-card-body">
                        <div class="agent-section-label">Listing Agent</div>
                        <div class="agent-row">
                            {% if agent_info.photo_url %}
                            <img src="{{ agent_info.photo_url }}" alt="{{ agent_info.name }}" class="agent-photo">
                            {% else %}
                            <div class="agent-photo-placeholder">{{ agent_info.name[0] if agent_info.name else '?' }}</div>
                            {% endif %}
                            <div class="agent-details">
                                <div class="agent-name">{{ agent_info.name }}</div>
                                {% if agent_info.office %}
                                <div class="agent-office">{{ agent_info.office }}</div>
                                {% endif %}
                                <div class="agent-contact">
                                    {% if agent_info.phone %}
                                    <a href="tel:{{ agent_info.phone }}">{{ agent_info.phone|phone }}</a>
                                    {% endif %}
                                    {% if agent_info.email %}
                                    <a href="mailto:{{ agent_info.email }}">{{ agent_info.email }}</a>
                                    {% endif %}
                                    {% if agent_info.website %}
                                    <a href="{{ agent_info.website }}" target="_blank">Website</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if buyer_agent_info %}
                        <hr class="agent-divider">
                        <div class="agent-section-label">Buyer's Agent</div>
                        <div class="agent-row">
                            <div class="agent-photo-placeholder">{{ buyer_agent_info.name[0] if buyer_agent_info.name else '?' }}</div>
                            <div class="agent-details">
                                <div class="agent-name">{{ buyer_agent_info.name }}</div>
                                {% if buyer_agent_info.office %}
                                <div class="agent-office">{{ buyer_agent_info.office }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ── Google Map ── #}
                {% if property.latitude and property.longitude %}
                <div class="sidebar-card map-card-wrapper" id="mapCard">
                    <button class="map-expand-btn" onclick="expandMap()" title="Expand map">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
                    </button>
                    <div id="mapTabsInline" class="map-view-tabs">
                        <button class="map-view-tab active" data-view="map" onclick="setMapView('map', this)">Map</button>
                        <button class="map-view-tab" data-view="satellite" onclick="setMapView('satellite', this)">Satellite</button>
                        <button class="map-view-tab" data-view="streetview" onclick="setMapView('streetview', this)">Street View</button>
                    </div>
                    <div id="mapBody">
                        <div id="propertyMap" class="map-container"></div>
                        <div id="streetViewContainer" class="map-container" style="display: none;"></div>
                    </div>
                    <div id="mapFooter">
                        <div class="poi-chips" id="poiChips">
                            <button class="poi-chip" data-type="bakery" onclick="togglePOI(this)"><span class="poi-icon">&#x1F950;</span> Bakery</button>
                            <button class="poi-chip" data-type="bank" onclick="togglePOI(this)"><span class="poi-icon">&#x1F3E6;</span> Bank</button>
                            <button class="poi-chip" data-type="cafe" onclick="togglePOI(this)"><span class="poi-icon">&#9749;</span> Cafe</button>
                            <button class="poi-chip" data-type="church" onclick="togglePOI(this)"><span class="poi-icon">&#9962;</span> Church</button>
                            <button class="poi-chip" data-type="golf_course" onclick="togglePOI(this)"><span class="poi-icon">&#9971;</span> Golf</button>
                            <button class="poi-chip" data-type="supermarket" onclick="togglePOI(this)"><span class="poi-icon">&#x1F6D2;</span> Grocery</button>
                            <button class="poi-chip" data-type="hospital" onclick="togglePOI(this)"><span class="poi-icon">&#x1F3E5;</span> Hospital</button>
                            <button class="poi-chip" data-type="library" onclick="togglePOI(this)"><span class="poi-icon">&#x1F4DA;</span> Library</button>
                            <button class="poi-chip" data-type="park" onclick="togglePOI(this)"><span class="poi-icon">&#x1F333;</span> Park</button>
                            <button class="poi-chip" data-type="restaurant" onclick="togglePOI(this)"><span class="poi-icon">&#x1F37D;&#xFE0F;</span> Restaurant</button>
                            <button class="poi-chip" data-type="beauty_salon" onclick="togglePOI(this)"><span class="poi-icon">&#x1F487;</span> Salon</button>
                        </div>
                        {% if directions_url %}
                        <a href="{{ directions_url }}" target="_blank" class="map-directions">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            Get Directions
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ── Spatial Analysis ── #}
                {% if property.flood_zone or property.elevation_feet or property.wildfire_risk or property.view_potential %}
                <div class="sidebar-card">
                    <div class="sidebar-card-header">Spatial Analysis</div>
                    <div class="sidebar-card-body">
                        <div class="spatial-grid">
                            {% if property.elevation_feet %}
                            <div class="spatial-item">
                                <div class="spatial-label">Elevation</div>
                                <div class="spatial-value">{{ "{:,}".format(property.elevation_feet) }} ft</div>
                            </div>
                            {% endif %}
                            {% if property.view_potential %}
                            <div class="spatial-item">
                                <div class="spatial-label">View Score</div>
                                <div class="spatial-value {% if property.view_potential >= 7 %}good{% endif %}">
                                    {{ property.view_potential }}/10
                                    <div style="background: #e5e1db; height: 4px; margin-top: 4px;">
                                        <div style="background: {% if property.view_potential >= 7 %}#059669{% elif property.view_potential >= 4 %}var(--dash-accent){% else %}var(--dash-text-light){% endif %}; height: 4px; width: {{ property.view_potential * 10 }}%;"></div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if property.flood_zone %}
                            <div class="spatial-item">
                                <div class="spatial-label">Flood Zone</div>
                                <div class="spatial-value {% if property.flood_factor and property.flood_factor >= 6 %}warning{% elif property.flood_zone == 'X' %}good{% endif %}">
                                    {{ property.flood_zone }}
                                    {% if property.flood_factor %} ({{ property.flood_factor }}/10){% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if property.wildfire_risk %}
                            <div class="spatial-item">
                                <div class="spatial-label">Wildfire Risk</div>
                                <div class="spatial-value {% if property.wildfire_risk|lower in ['high', 'very high'] %}warning{% elif property.wildfire_risk|lower == 'low' %}good{% endif %}">
                                    {{ property.wildfire_risk }}
                                </div>
                            </div>
                            {% endif %}
                            {% if property.slope_percent %}
                            <div class="spatial-item">
                                <div class="spatial-label">Slope</div>
                                <div class="spatial-value">{{ "%.1f"|format(property.slope_percent) }}%</div>
                            </div>
                            {% endif %}
                            {% if property.aspect %}
                            <div class="spatial-item">
                                <div class="spatial-label">Aspect</div>
                                <div class="spatial-value">{{ property.aspect }}-facing</div>
                            </div>
                            {% endif %}
                        </div>
                        {% if property.spatial_enriched_at %}
                        <div class="spatial-source">
                            Data from NC OneMap &middot; {{ property.spatial_enriched_at[:10] }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ── Recent Changes ── #}
                {% if changes %}
                <div class="sidebar-card">
                    <div class="sidebar-card-header">Recent Changes</div>
                    <div class="sidebar-card-body">
                        {% for change in changes %}
                        <div class="change-item">
                            <div class="change-type">{{ change.change_type }}</div>
                            <div class="change-values">
                                {% if change.change_type == 'price' %}
                                <span class="change-old">${{ "{:,.0f}".format(change.old_value|float) }}</span>
                                <span class="change-arrow">&rarr;</span>
                                <span class="change-new">${{ "{:,.0f}".format(change.new_value|float) }}</span>
                                {% if change.change_amount %}
                                <span class="change-amount {% if change.change_amount < 0 %}decrease{% else %}increase{% endif %}">
                                    {{ "{:+,.0f}".format(change.change_amount) }}
                                </span>
                                {% endif %}
                                {% else %}
                                <span class="change-old">{{ change.old_value }}</span>
                                <span class="change-arrow">&rarr;</span>
                                <span class="change-new">{{ change.new_value }}</span>
                                {% endif %}
                            </div>
                            <div class="change-date">{{ change.detected_at[:10] }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# ── Interested Contacts ── #}
                <div class="sidebar-card">
                    <div class="sidebar-card-header">Interested Contacts ({{ interested_contacts|length }})</div>
                    <div class="sidebar-card-body">
                        {% if interested_contacts %}
                        {% for contact in interested_contacts %}
                        <div class="contact-item">
                            <div class="contact-avatar">
                                {{ contact.first_name[0] if contact.first_name else '?' }}{{ contact.last_name[0] if contact.last_name else '' }}
                            </div>
                            <div>
                                <div class="contact-name">
                                    <a href="/contacts/{{ contact.id }}/workspace">{{ contact.first_name }} {{ contact.last_name }}</a>
                                </div>
                                <div class="contact-status">
                                    {{ contact.relationship|title or 'Viewed' }}
                                    {% if contact.relationship == 'favorited' %}<span style="color: #f59e0b;">&#9733;</span>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div style="color: var(--dash-text-light); font-size: 13px;">
                            No contacts have viewed this property yet
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# ── External Links ── #}
                {% if property.redfin_url or property.zillow_url or property.idx_url or property.mls_url %}
                <div class="sidebar-card">
                    <div class="sidebar-card-header">External Links</div>
                    <div class="sidebar-card-body">
                        <div class="ext-links">
                            {% if property.mls_url %}
                            <a href="{{ property.mls_url }}" target="_blank" class="ext-link ext-mls">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                MLS Portal
                            </a>
                            {% endif %}
                            {% if property.redfin_url %}
                            <a href="{{ property.redfin_url }}" target="_blank" class="ext-link ext-redfin">Redfin</a>
                            {% endif %}
                            {% if property.zillow_url %}
                            <a href="{{ property.zillow_url }}" target="_blank" class="ext-link ext-zillow">Zillow</a>
                            {% endif %}
                            {% if property.idx_url %}
                            <a href="{{ property.idx_url }}" target="_blank" class="ext-link ext-idx">IDX Website</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

    </div>

    {# ── Lightbox Overlay ── #}
    <div class="lightbox" id="lightbox">
        <div class="lightbox-top">
            <span class="lightbox-counter" id="lightboxCounter"></span>
            <span class="lightbox-address">{{ property.address }}, {{ property.city }}</span>
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        </div>
        <div class="lightbox-body" onclick="if(event.target===this)closeLightbox()">
            <button class="lightbox-nav prev" onclick="prevPhoto()">&#10094;</button>
            <img id="lightboxImg" src="" alt="">
            <button class="lightbox-nav next" onclick="nextPhoto()">&#10095;</button>
        </div>
        <div class="lightbox-thumbs" id="lightboxThumbs">
            <div class="lightbox-thumb-strip" id="lightboxThumbStrip"></div>
        </div>
    </div>

    {# ── Map Lightbox Overlay ── #}
    {% if property.latitude and property.longitude %}
    <div class="map-lightbox" id="mapLightbox">
        <div class="map-lightbox-top">
            <span class="map-lightbox-title">{{ property.address }}, {{ property.city }}</span>
            <button class="map-lightbox-close" onclick="collapseMap()">&times;</button>
        </div>
        <div id="mapLightboxTabs" class="map-lightbox-tabs"></div>
        <div id="mapLightboxBody" class="map-lightbox-body"></div>
        <div id="mapLightboxFooter" class="map-lightbox-footer"></div>
    </div>
    {% endif %}

    <script>
    /* ================================================================
       Photo Lightbox
       ================================================================ */
    const photos = {{ property.photos | tojson }};
    let currentPhoto = 0;

    function openLightbox(index) {
        currentPhoto = index;
        updateLightbox();
        document.getElementById('lightbox').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('open');
        document.body.style.overflow = '';
    }

    function nextPhoto() {
        currentPhoto = (currentPhoto + 1) % photos.length;
        updateLightbox();
    }

    function prevPhoto() {
        currentPhoto = (currentPhoto - 1 + photos.length) % photos.length;
        updateLightbox();
    }

    function updateLightbox() {
        document.getElementById('lightboxImg').src = photos[currentPhoto];
        document.getElementById('lightboxCounter').textContent =
            (currentPhoto + 1) + ' of ' + photos.length;

        // Update thumbnail active state
        const thumbs = document.querySelectorAll('.lightbox-thumb');
        thumbs.forEach(function(t, i) {
            t.classList.toggle('active', i === currentPhoto);
        });

        // Scroll active thumb into view
        var activeThumb = document.querySelector('.lightbox-thumb.active');
        if (activeThumb) activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    // Build thumbnail strip
    (function() {
        var strip = document.getElementById('lightboxThumbStrip');
        photos.forEach(function(url, i) {
            var div = document.createElement('div');
            div.className = 'lightbox-thumb' + (i === 0 ? ' active' : '');
            div.onclick = function() { currentPhoto = i; updateLightbox(); };
            var img = document.createElement('img');
            img.src = url;
            img.alt = 'Thumbnail ' + (i + 1);
            img.loading = 'lazy';
            div.appendChild(img);
            strip.appendChild(div);
        });
    })();

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        // Map lightbox: Escape to close
        if (typeof mapExpanded !== 'undefined' && mapExpanded && e.key === 'Escape') {
            e.preventDefault();
            collapseMap();
            return;
        }
        // Photo lightbox
        if (!document.getElementById('lightbox').classList.contains('open')) return;
        if (e.key === 'ArrowLeft') { e.preventDefault(); prevPhoto(); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); nextPhoto(); }
        else if (e.key === 'Escape') { e.preventDefault(); closeLightbox(); }
    });

    /* ================================================================
       Copy MLS Number
       ================================================================ */
    function copyMLS() {
        var mls = '{{ property.mls_number or "" }}';
        if (mls && navigator.clipboard) {
            navigator.clipboard.writeText(mls).then(function() {
                var btn = event.currentTarget;
                var orig = btn.innerHTML;
                btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
                setTimeout(function() { btn.innerHTML = orig; }, 1500);
            });
        }
    }

    /* ================================================================
       Collapsible Sections
       ================================================================ */
    var STORAGE_KEY = 'dreams_detail_toggles';

    function getToggleState() {
        try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        } catch (e) { return {}; }
    }

    function saveToggleState(state) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {}
    }

    function toggleSection(key) {
        var section = document.querySelector('[data-section="' + key + '"]');
        if (!section) return;
        section.classList.toggle('collapsed');
        var state = getToggleState();
        state[key] = section.classList.contains('collapsed');
        saveToggleState(state);
    }

    function expandAll() {
        document.querySelectorAll('.detail-section').forEach(function(s) {
            s.classList.remove('collapsed');
        });
        saveToggleState({});
    }

    function collapseAll() {
        var state = {};
        document.querySelectorAll('.detail-section').forEach(function(s) {
            s.classList.add('collapsed');
            var key = s.getAttribute('data-section');
            if (key) state[key] = true;
        });
        saveToggleState(state);
    }

    // Restore toggle states on load
    (function() {
        var state = getToggleState();
        Object.keys(state).forEach(function(key) {
            if (state[key]) {
                var section = document.querySelector('[data-section="' + key + '"]');
                if (section) section.classList.add('collapsed');
            }
        });
    })();

    /* ================================================================
       Google Maps
       ================================================================ */
    {% if property.latitude and property.longitude and google_maps_key %}
    var mapInstance = null;
    var propertyMarker = null;
    var poiMarkers = {};
    var poiCache = {};
    var infoWindow = null;
    var streetViewPanorama = null;
    var currentMapView = 'map';

    var PROP_LAT = {{ property.latitude }};
    var PROP_LNG = {{ property.longitude }};
    var SEARCH_RADIUS = 48280; // ~30 miles

    function initMap() {
        if (typeof google === 'undefined' || !google.maps) return;

        var pos = { lat: PROP_LAT, lng: PROP_LNG };

        mapInstance = new google.maps.Map(document.getElementById('propertyMap'), {
            center: pos,
            zoom: 14,
            gestureHandling: 'cooperative',
            zoomControl: true,
            fullscreenControl: false,
            streetViewControl: false,
            mapTypeControl: false,
            mapTypeId: 'roadmap'
        });

        // Custom teal/gold pin
        var pinSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36" width="36" height="54">' +
            '<path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 24 12 24s12-15 12-24C24 5.4 18.6 0 12 0z" fill="%23C5A572" stroke="%23082d40" stroke-width="1.5"/>' +
            '<circle cx="12" cy="12" r="5" fill="%23082d40"/>' +
            '</svg>';

        propertyMarker = new google.maps.Marker({
            map: mapInstance,
            position: pos,
            title: '{{ property.address|replace("'", "\\'") }}',
            icon: {
                url: 'data:image/svg+xml,' + pinSvg,
                scaledSize: new google.maps.Size(36, 54),
                anchor: new google.maps.Point(18, 54)
            },
            zIndex: 1000
        });

        infoWindow = new google.maps.InfoWindow();
    }

    function setMapView(mode, btn) {
        // Update tab UI
        document.querySelectorAll('.map-view-tab').forEach(function(t) {
            t.classList.toggle('active', t === btn);
        });

        var mapEl = document.getElementById('propertyMap');
        var svEl = document.getElementById('streetViewContainer');
        var poiEl = document.getElementById('poiChips');

        currentMapView = mode;

        if (mode === 'streetview') {
            mapEl.style.display = 'none';
            svEl.style.display = 'block';
            poiEl.style.display = 'none';
            initStreetView();
        } else {
            mapEl.style.display = 'block';
            svEl.style.display = 'none';
            poiEl.style.display = 'flex';
            if (mapInstance) {
                mapInstance.setMapTypeId(mode === 'satellite' ? 'satellite' : 'roadmap');
            }
        }
    }

    function initStreetView() {
        if (typeof google === 'undefined') return;
        var container = document.getElementById('streetViewContainer');

        if (streetViewPanorama) return; // Already initialized

        var svService = new google.maps.StreetViewService();
        svService.getPanorama(
            { location: { lat: PROP_LAT, lng: PROP_LNG }, radius: 100 },
            function(data, status) {
                if (status === google.maps.StreetViewStatus.OK) {
                    streetViewPanorama = new google.maps.StreetViewPanorama(container, {
                        position: { lat: PROP_LAT, lng: PROP_LNG },
                        pov: { heading: 0, pitch: 0 },
                        zoom: 1,
                        addressControl: false,
                        fullscreenControl: false
                    });
                } else {
                    container.innerHTML = '<div class="streetview-fallback">Street View is not available for this location</div>';
                }
            }
        );
    }

    function togglePOI(btn) {
        btn.classList.toggle('active');
        var type = btn.getAttribute('data-type');

        if (!btn.classList.contains('active')) {
            // Remove markers
            if (poiMarkers[type]) {
                poiMarkers[type].forEach(function(m) { m.setMap(null); });
                delete poiMarkers[type];
            }
            return;
        }

        // Use cached results if available
        if (poiCache[type]) {
            poiMarkers[type] = buildPOIMarkers(poiCache[type], btn.querySelector('.poi-icon').textContent);
            return;
        }

        // Search using Places API (New)
        if (typeof google === 'undefined' || !google.maps || !google.maps.places) return;

        var PlaceClass = google.maps.places.Place;
        if (PlaceClass && PlaceClass.searchNearby) {
            PlaceClass.searchNearby({
                fields: ['displayName', 'location', 'formattedAddress', 'rating'],
                locationRestriction: {
                    center: { lat: PROP_LAT, lng: PROP_LNG },
                    radius: SEARCH_RADIUS
                },
                includedTypes: [type],
                maxResultCount: 20,
                rankPreference: google.maps.places.SearchNearbyRankPreference.DISTANCE
            }).then(function(result) {
                var places = (result.places || []).filter(function(p) { return p.location; }).map(function(p) {
                    return {
                        name: p.displayName || type,
                        lat: p.location.lat(),
                        lng: p.location.lng(),
                        address: p.formattedAddress || '',
                        rating: p.rating || null
                    };
                });
                poiCache[type] = places;
                if (btn.classList.contains('active')) {
                    poiMarkers[type] = buildPOIMarkers(places, btn.querySelector('.poi-icon').textContent);
                }
            }).catch(function(err) {
                console.error('[POI] ' + type + ' search failed:', err);
            });
        }
    }

    function buildPOIMarkers(places, iconText) {
        return places.map(function(place) {
            var marker = new google.maps.Marker({
                map: mapInstance,
                position: { lat: place.lat, lng: place.lng },
                title: place.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14,
                    fillColor: '#ffffff',
                    fillOpacity: 0.95,
                    strokeColor: '#C5A572',
                    strokeWeight: 2
                },
                label: { text: iconText, fontSize: '14px' }
            });

            var name = escapeHtml(place.name);
            var addr = place.address ? escapeHtml(place.address) : '';
            var content = '<div style="font-family:system-ui,sans-serif;max-width:220px">' +
                '<strong style="color:#082d40">' + name + '</strong>' +
                (addr ? '<br><span style="color:#666;font-size:12px">' + addr + '</span>' : '') +
                (place.rating ? '<br><span style="font-size:12px;color:#666">Rating: ' + place.rating + '/5</span>' : '') +
                '</div>';

            marker.addListener('click', function() {
                infoWindow.setContent(content);
                infoWindow.open(mapInstance, marker);
            });

            return marker;
        });
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    function showMapFallback() {
        var mapEl = document.getElementById('propertyMap');
        if (mapEl) {
            mapEl.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#faf9f7;color:var(--dash-text-light);font-size:13px;text-align:center;padding:20px;">' +
                '<svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-bottom:8px;opacity:0.4;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' +
                '<div>Map unavailable</div>' +
                '<a href="https://www.google.com/maps?q=' + PROP_LAT + ',' + PROP_LNG + '" target="_blank" style="color:var(--dash-primary);margin-top:6px;font-size:12px;">Open in Google Maps</a>' +
                '</div>';
        }
        // Hide POI chips since map didn't load
        var poiEl = document.getElementById('poiChips');
        if (poiEl) poiEl.style.display = 'none';
    }

    // Initialize map when Google Maps API loads
    function tryInitMap() {
        if (typeof google !== 'undefined' && google.maps) {
            try {
                initMap();
            } catch (e) {
                console.error('[Map] Init failed:', e);
                showMapFallback();
            }
        } else {
            showMapFallback();
        }
    }

    if (typeof google !== 'undefined' && google.maps) {
        tryInitMap();
    } else {
        window.addEventListener('load', function() {
            setTimeout(tryInitMap, 800);
        });
    }

    /* ── Map Expand / Collapse (lightbox-style) ── */
    var mapExpanded = false;

    function expandMap() {
        var overlay = document.getElementById('mapLightbox');
        var tabs = document.getElementById('mapTabsInline');
        var body = document.getElementById('mapBody');
        var footer = document.getElementById('mapFooter');

        // Move elements into the lightbox
        document.getElementById('mapLightboxTabs').appendChild(tabs);
        document.getElementById('mapLightboxBody').appendChild(body);
        document.getElementById('mapLightboxFooter').appendChild(footer);

        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
        mapExpanded = true;

        // Tell Google Maps to recalculate size
        setTimeout(function() {
            if (mapInstance) google.maps.event.trigger(mapInstance, 'resize');
            if (mapInstance) mapInstance.setCenter({ lat: PROP_LAT, lng: PROP_LNG });
        }, 100);
    }

    function collapseMap() {
        var overlay = document.getElementById('mapLightbox');
        var card = document.getElementById('mapCard');
        var tabs = document.getElementById('mapTabsInline');
        var body = document.getElementById('mapBody');
        var footer = document.getElementById('mapFooter');
        var expandBtn = card.querySelector('.map-expand-btn');

        // Move elements back to the sidebar card (tabs before expand button)
        card.insertBefore(tabs, expandBtn.nextSibling);
        card.appendChild(body);
        card.appendChild(footer);

        overlay.classList.remove('open');
        document.body.style.overflow = '';
        mapExpanded = false;

        // Resize map back to sidebar dimensions
        setTimeout(function() {
            if (mapInstance) google.maps.event.trigger(mapInstance, 'resize');
            if (mapInstance) mapInstance.setCenter({ lat: PROP_LAT, lng: PROP_LNG });
        }, 100);
    }

    // Catch Google Maps auth failures (wrong API key, missing referrer, etc.)
    window.gm_authFailure = function() {
        console.warn('[Map] Google Maps auth failure. Check API key referrer restrictions.');
        showMapFallback();
    };
    {% endif %}

    /* ================================================================
       Price History Chart
       ================================================================ */
    {% if price_history and price_history|length > 1 %}
    (function() {
        var priceHistory = {{ price_history | tojson }};
        var ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: priceHistory.map(function(p) { return p.date; }),
                datasets: [{
                    label: 'Price',
                    data: priceHistory.map(function(p) { return p.price; }),
                    borderColor: '#082d40',
                    backgroundColor: 'rgba(8, 45, 64, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 6,
                    pointBackgroundColor: '#082d40',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var point = priceHistory[context.dataIndex];
                                return [
                                    '$' + context.raw.toLocaleString(),
                                    point.event || ''
                                ].filter(Boolean);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'k';
                            }
                        }
                    },
                    x: { ticks: { maxTicksLimit: 6 } }
                }
            }
        });
    })();
    {% endif %}
    </script>
</body>
</html>
