<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ property.address }} | DREAMS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .property-header {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .property-photo {
            width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            background: #f3f4f6;
        }

        .property-info {
            flex: 1;
        }

        .property-info h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            color: var(--primary-dark);
        }

        .property-location {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 16px;
        }

        .property-price {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .property-price .original-price {
            font-size: 18px;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-left: 12px;
            font-weight: 400;
        }

        .property-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .property-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-status {
            background: var(--idx-validated-bg);
            color: var(--idx-validated-text);
        }

        .badge-type {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-dom {
            background: #fef3c7;
            color: #92400e;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 65% 33%;
            gap: 2%;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 300px;
        }

        .no-chart-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
        }

        .detail-panel h3 {
            margin: 0 0 16px 0;
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .change-item {
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .change-type {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .change-values {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .change-old {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .change-arrow {
            color: var(--text-secondary);
        }

        .change-new {
            color: var(--primary);
            font-weight: 600;
        }

        .change-amount {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        .change-amount.decrease {
            background: #dcfce7;
            color: #166534;
        }

        .change-amount.increase {
            background: #fee2e2;
            color: #991b1b;
        }

        .change-date {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .contact-item:last-child {
            border-bottom: none;
        }

        .contact-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .contact-name a {
            color: inherit;
            text-decoration: none;
        }

        .contact-name a:hover {
            color: var(--primary);
        }

        .contact-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .contact-favorite {
            color: #f59e0b;
        }

        .property-links {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .property-links a {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            text-decoration: none;
            font-weight: 500;
        }

        .link-redfin {
            background: #a61d2e;
            color: white;
        }

        .link-zillow {
            background: #006aff;
            color: white;
        }

        .link-idx {
            background: var(--primary);
            color: white;
        }

        .breadcrumb {
            margin-bottom: 16px;
        }

        .breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: var(--primary);
        }

        .breadcrumb span {
            color: var(--text-secondary);
            margin: 0 8px;
        }

        /* Spatial Data Badges */
        .badge-spatial {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-flood {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-flood.high-risk {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-elevation {
            background: #e0f2fe;
            color: #0369a1;
        }

        .badge-view {
            background: #dcfce7;
            color: #166534;
        }

        .badge-wildfire {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-wildfire.high-risk {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Mini Map */
        .property-map {
            height: 200px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        /* Spatial Details Grid */
        .spatial-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .spatial-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .spatial-item .label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .spatial-item .value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .spatial-item .value.warning {
            color: #dc2626;
        }

        .spatial-item .value.good {
            color: #059669;
        }

        .photo-gallery {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .photo-thumb {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .photo-thumb:hover,
        .photo-thumb.active {
            opacity: 1;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .detail-value {
            font-weight: 500;
            font-size: 13px;
        }
    </style>
</head>
{% set active_nav = 'properties' %}
<body>
    {% include 'partials/sidebar.html' %}
    <div class="main-content">
    <div class="dreams-container">
        <!-- Header -->
        <header class="dreams-header">
            <div class="header-left">
                <h1 class="header-title">DREAMS</h1>
                <span class="header-subtitle">Property Details</span>
            </div>
        </header>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/properties">Properties</a>
            <span>&rarr;</span>
            {{ property.address }}
        </div>

        <!-- Property Header -->
        <div class="property-header">
            {% if property.photos %}
            <img src="{{ property.photos[0] }}" alt="{{ property.address }}" class="property-photo" id="mainPhoto">
            {% else %}
            <div class="property-photo" style="display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                No Photo Available
            </div>
            {% endif %}

            <div class="property-info">
                <h1>{{ property.address }}</h1>
                <div class="property-location">
                    {{ property.city }}, {{ property.state }} {{ property.zip }}
                    {% if property.county %} &bull; {{ property.county }} County{% endif %}
                </div>

                <div class="property-price">
                    ${{ "{:,.0f}".format(property.price) }}
                    {% if property.initial_price and property.initial_price != property.price %}
                    <span class="original-price">${{ "{:,.0f}".format(property.initial_price) }}</span>
                    {% endif %}
                </div>

                <div class="property-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ property.beds or '-' }}</div>
                        <div class="stat-label">Beds</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ property.baths or '-' }}</div>
                        <div class="stat-label">Baths</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ "{:,.0f}".format(property.sqft) if property.sqft else '-' }}</div>
                        <div class="stat-label">Sq Ft</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ "{:,.2f}".format(property.acreage) if property.acreage else '-' }}</div>
                        <div class="stat-label">Acres</div>
                    </div>
                </div>

                <div class="property-badges">
                    <span class="badge badge-status">{{ property.status or 'Active' }}</span>
                    {% if property.property_type %}
                    <span class="badge badge-type">{{ property.property_type }}</span>
                    {% endif %}
                    {% if property.days_on_market %}
                    <span class="badge badge-dom">{{ property.days_on_market }} DOM</span>
                    {% endif %}
                    {# Spatial data badges #}
                    {% if property.flood_zone and property.flood_zone != 'X' %}
                    <span class="badge badge-flood {% if property.flood_factor and property.flood_factor >= 6 %}high-risk{% endif %}">
                        Flood: {{ property.flood_zone }}
                    </span>
                    {% endif %}
                    {% if property.elevation_feet %}
                    <span class="badge badge-elevation">{{ "{:,}".format(property.elevation_feet) }} ft</span>
                    {% endif %}
                    {% if property.view_potential and property.view_potential >= 7 %}
                    <span class="badge badge-view">Mountain Views</span>
                    {% endif %}
                    {% if property.wildfire_risk and property.wildfire_risk.lower() in ['high', 'very high'] %}
                    <span class="badge badge-wildfire high-risk">Fire Risk: {{ property.wildfire_risk }}</span>
                    {% endif %}
                </div>

                <div class="property-links">
                    {% if property.redfin_url %}
                    <a href="{{ property.redfin_url }}" target="_blank" class="link-redfin">View on Redfin</a>
                    {% endif %}
                    {% if property.zillow_url %}
                    <a href="{{ property.zillow_url }}" target="_blank" class="link-zillow">View on Zillow</a>
                    {% endif %}
                    {% if property.idx_url %}
                    <a href="{{ property.idx_url }}" target="_blank" class="link-idx">View on IDX</a>
                    {% endif %}
                </div>

                {% if property.photos and property.photos|length > 1 %}
                <div class="photo-gallery">
                    {% for photo in property.photos[:8] %}
                    <img src="{{ photo }}" alt="Photo {{ loop.index }}" class="photo-thumb {% if loop.first %}active{% endif %}"
                         onclick="document.getElementById('mainPhoto').src='{{ photo }}'; document.querySelectorAll('.photo-thumb').forEach(t => t.classList.remove('active')); this.classList.add('active');">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <div class="left-column">
                <!-- Property Details (above price history) -->
                <div class="chart-container">
                    <h3>Property Details</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">MLS Number</span>
                            <span class="detail-value">{{ property.mls_number or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Year Built</span>
                            <span class="detail-value">{{ property.year_built or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Property Type</span>
                            <span class="detail-value">{{ property.property_type or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Style</span>
                            <span class="detail-value">{{ property.style or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Heating</span>
                            <span class="detail-value">{{ property.heating or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Cooling</span>
                            <span class="detail-value">{{ property.cooling or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Garage</span>
                            <span class="detail-value">{{ property.garage or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Views</span>
                            <span class="detail-value">{{ property.views or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Water Features</span>
                            <span class="detail-value">{{ property.water_features or '-' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">List Date</span>
                            <span class="detail-value">{{ property.list_date or '-' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Price History Chart -->
                <div class="chart-container" style="margin-top: 24px;">
                    <h3>Price History</h3>
                    {% if price_history and price_history|length > 1 %}
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                    {% else %}
                    <div class="no-chart-data">
                        No price changes recorded for this property
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="right-column">
                <!-- Location Map -->
                {% if property.latitude and property.longitude %}
                <div class="detail-panel">
                    <h3>Location</h3>
                    <div id="propertyMap" class="property-map"></div>
                </div>
                {% endif %}

                <!-- Spatial Data Section -->
                {% if property.flood_zone or property.elevation_feet or property.wildfire_risk %}
                <div class="detail-panel">
                    <h3>Property Analysis</h3>
                    <div class="spatial-grid">
                        {% if property.flood_zone %}
                        <div class="spatial-item">
                            <div class="label">Flood Zone</div>
                            <div class="value {% if property.flood_factor and property.flood_factor >= 6 %}warning{% elif property.flood_zone == 'X' %}good{% endif %}">
                                {{ property.flood_zone }}
                                {% if property.flood_factor %}({{ property.flood_factor }}/10){% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% if property.elevation_feet %}
                        <div class="spatial-item">
                            <div class="label">Elevation</div>
                            <div class="value">{{ "{:,}".format(property.elevation_feet) }} ft</div>
                        </div>
                        {% endif %}
                        {% if property.slope_percent %}
                        <div class="spatial-item">
                            <div class="label">Slope</div>
                            <div class="value">{{ "%.1f"|format(property.slope_percent) }}%</div>
                        </div>
                        {% endif %}
                        {% if property.aspect %}
                        <div class="spatial-item">
                            <div class="label">Aspect</div>
                            <div class="value">{{ property.aspect }}-facing</div>
                        </div>
                        {% endif %}
                        {% if property.view_potential %}
                        <div class="spatial-item">
                            <div class="label">View Potential</div>
                            <div class="value {% if property.view_potential >= 7 %}good{% endif %}">
                                {{ property.view_potential }}/10
                            </div>
                        </div>
                        {% endif %}
                        {% if property.wildfire_risk %}
                        <div class="spatial-item">
                            <div class="label">Wildfire Risk</div>
                            <div class="value {% if property.wildfire_risk|lower in ['high', 'very high'] %}warning{% elif property.wildfire_risk|lower == 'low' %}good{% endif %}">
                                {{ property.wildfire_risk }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% if property.spatial_enriched_at %}
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 12px;">
                        Data from NC OneMap &bull; Updated {{ property.spatial_enriched_at[:10] }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Price Changes -->
                {% if changes %}
                <div class="detail-panel">
                    <h3>Recent Changes</h3>
                    {% for change in changes %}
                    <div class="change-item">
                        <div class="change-type">{{ change.change_type }}</div>
                        <div class="change-values">
                            {% if change.change_type == 'price' %}
                            <span class="change-old">${{ "{:,.0f}".format(change.old_value|float) }}</span>
                            <span class="change-arrow">&rarr;</span>
                            <span class="change-new">${{ "{:,.0f}".format(change.new_value|float) }}</span>
                            {% if change.change_amount %}
                            <span class="change-amount {% if change.change_amount < 0 %}decrease{% else %}increase{% endif %}">
                                {{ "{:+,.0f}".format(change.change_amount) }}
                            </span>
                            {% endif %}
                            {% else %}
                            <span class="change-old">{{ change.old_value }}</span>
                            <span class="change-arrow">&rarr;</span>
                            <span class="change-new">{{ change.new_value }}</span>
                            {% endif %}
                        </div>
                        <div class="change-date">{{ change.detected_at[:10] }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Interested Contacts -->
                <div class="detail-panel">
                    <h3>Interested Contacts ({{ interested_contacts|length }})</h3>
                    {% if interested_contacts %}
                    {% for contact in interested_contacts %}
                    <div class="contact-item">
                        <div class="contact-avatar">
                            {{ contact.first_name[0] if contact.first_name else '?' }}{{ contact.last_name[0] if contact.last_name else '' }}
                        </div>
                        <div class="contact-info">
                            <div class="contact-name">
                                <a href="/contacts/{{ contact.id }}/workspace">{{ contact.first_name }} {{ contact.last_name }}</a>
                            </div>
                            <div class="contact-status">
                                {{ contact.relationship|title or 'Viewed' }}
                                {% if contact.relationship == 'favorited' %}<span class="contact-favorite">&#9733;</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div style="color: var(--text-secondary); font-size: 13px; padding: 12px 0;">
                        No contacts have viewed this property yet
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if price_history and price_history|length > 1 %}
    <script>
        const priceHistory = {{ price_history | tojson }};

        const ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: priceHistory.map(p => p.date),
                datasets: [{
                    label: 'Price',
                    data: priceHistory.map(p => p.price),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 6,
                    pointBackgroundColor: '#2563eb',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = priceHistory[context.dataIndex];
                                return [
                                    '$' + context.raw.toLocaleString(),
                                    point.event || ''
                                ].filter(Boolean);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'k';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxTicksLimit: 6
                        }
                    }
                }
            }
        });
    </script>
    {% endif %}

    <!-- Mini Map -->
    {% if property.latitude and property.longitude %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const lat = {{ property.latitude }};
        const lng = {{ property.longitude }};

        const map = L.map('propertyMap', {
            zoomControl: false,
            scrollWheelZoom: false
        }).setView([lat, lng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Property marker
        const marker = L.marker([lat, lng]).addTo(map);

        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Click to open in Google Maps
        map.on('click', function() {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        });
    </script>
    {% endif %}
    </div>
</body>
</html>
