<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Lists | DREAMS</title>
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <style>
        .smart-lists-page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 28px;
        }

        .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .page-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .refresh-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .refresh-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .refresh-btn.loading { opacity: 0.6; pointer-events: none; }

        .freshness { font-size: 12px; color: var(--text-tertiary, #9ca3af); }
        .freshness.stale { color: #d97706; }

        /* List row: one per smart list */
        .list-row {
            margin-bottom: 20px;
            border: 1px solid var(--border, #e2e8f0);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .list-row-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        .list-row-header:hover { background: #f8fafc; }

        /* FUB side (left) */
        .fub-side {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .side-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .side-label.fub { background: #dbeafe; color: #2563eb; }
        .side-label.dreams { background: #fce7f3; color: #db2777; }

        .list-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .list-count {
            font-size: 20px;
            font-weight: 800;
            min-width: 32px;
            text-align: center;
        }
        .list-count.fub { color: #2563eb; }
        .list-count.dreams { color: #db2777; }
        .list-count.zero { color: var(--text-tertiary, #9ca3af); }

        .cadence-label {
            font-size: 11px;
            color: var(--text-tertiary, #9ca3af);
            margin-left: 8px;
        }

        /* Comparison strip (center) */
        .comparison-strip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 16px;
        }

        .comp-stat {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            white-space: nowrap;
        }
        .comp-stat.both { background: #dcfce7; color: #16a34a; }
        .comp-stat.fub-only { background: #dbeafe; color: #2563eb; }
        .comp-stat.dreams-only { background: #fce7f3; color: #db2777; }
        .comp-stat.loading { background: #f1f5f9; color: #94a3b8; }

        .expand-icon {
            margin-left: auto;
            color: var(--text-tertiary, #9ca3af);
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .list-row.expanded .expand-icon { transform: rotate(180deg); }

        /* DREAMS side (right) */
        .dreams-side {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Expanded body */
        .list-row-body {
            display: none;
            border-top: 1px solid var(--border, #e2e8f0);
        }
        .list-row.expanded .list-row-body { display: block; }

        .body-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 60px;
        }

        .panel {
            padding: 12px 16px;
        }
        .panel + .panel {
            border-left: 1px solid var(--border, #e2e8f0);
        }

        .panel-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .panel-header.fub { color: #2563eb; }
        .panel-header.dreams { color: #db2777; }

        /* Contact rows inside panels */
        .contact-row {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 5px;
            transition: background 0.12s;
            gap: 8px;
            font-size: 14px;
        }
        .contact-row:hover { background: #f8fafc; }

        .contact-name {
            flex: 1;
            min-width: 0;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .contact-name a {
            color: var(--text-primary);
            text-decoration: none;
        }
        .contact-name a:hover { color: var(--primary, #2563eb); }

        .contact-stage {
            font-size: 11px;
            color: var(--text-tertiary, #9ca3af);
        }

        .contact-phone a {
            color: var(--primary, #2563eb);
            text-decoration: none;
            font-size: 13px;
            white-space: nowrap;
        }
        .contact-phone a:hover { text-decoration: underline; }
        .contact-phone .no-phone { color: var(--text-tertiary, #9ca3af); font-size: 12px; }

        .score-badges {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .score-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 8px;
        }
        .score-badge.heat { background: #fee2e2; color: #dc2626; }
        .score-badge.priority { background: #fef3c7; color: #d97706; }

        .action-btns {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .action-btn {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border, #e2e8f0);
            background: white;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.12s;
            white-space: nowrap;
        }
        .action-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

        /* Outlier (only on one side) */
        .outlier-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .outlier-dot.fub-only { background: #3b82f6; }
        .outlier-dot.dreams-only { background: #ec4899; }

        .outlier-reason {
            display: none;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 8px 8px 24px;
            line-height: 1.4;
        }
        .contact-row.show-reason + .outlier-reason { display: block; }

        .empty-panel {
            color: var(--text-tertiary, #9ca3af);
            font-size: 13px;
            font-style: italic;
            padding: 8px 0;
        }

        /* Loading states */
        .skeleton-bar {
            height: 14px;
            background: #f1f5f9;
            border-radius: 4px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .fub-loading .list-count.fub {
            opacity: 0.3;
        }

        /* Color coding per list */
        .list-row[data-key="new_leads"] .list-name { color: #3b82f6; }
        .list-row[data-key="priority"] .list-name { color: #8b5cf6; }
        .list-row[data-key="hot"] .list-name { color: #ef4444; }
        .list-row[data-key="warm"] .list-name { color: #f59e0b; }
        .list-row[data-key="cool"] .list-name { color: #6366f1; }
        .list-row[data-key="unresponsive"] .list-name { color: #6b7280; }
        .list-row[data-key="timeframe_empty"] .list-name { color: #8b5cf6; }

        @media (max-width: 900px) {
            .smart-lists-page { padding: 16px; }
            .list-row-header { grid-template-columns: 1fr; gap: 8px; }
            .comparison-strip { justify-content: flex-start; padding: 0; }
            .dreams-side { justify-content: flex-start; }
            .body-panels { grid-template-columns: 1fr; }
            .panel + .panel { border-left: none; border-top: 1px solid var(--border, #e2e8f0); }
        }
    </style>
</head>
<body>
    {% include 'partials/sidebar.html' %}
    <div class="main-content">
    <div class="smart-lists-page">

        <div class="page-header">
            <div>
                <h1 class="page-title">Smart Lists</h1>
                <p class="page-subtitle">FUB live lists vs DREAMS scoring &mdash; side by side</p>
            </div>
            <div class="header-actions">
                <span class="freshness" id="freshness"></span>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshFub()">Refresh FUB</button>
            </div>
        </div>

        <div id="lists-container">
            {% for fub_name in smart_list_order %}
            {% set info = smart_list_map[fub_name] %}
            {% set dk = info.dreams_key %}
            {% set dc = dreams_lists.get(dk, []) %}
            <div class="list-row" data-key="{{ dk }}" data-fub-name="{{ fub_name }}">
                <div class="list-row-header" onclick="toggleRow(this)">
                    <!-- FUB side -->
                    <div class="fub-side">
                        <span class="side-label fub">FUB</span>
                        <span class="list-name">{{ fub_name }}</span>
                        <span class="list-count fub fub-loading" data-fub-count>--</span>
                        <span class="cadence-label">{{ info.cadence }}</span>
                    </div>

                    <!-- Comparison strip -->
                    <div class="comparison-strip" data-comp>
                        <span class="comp-stat loading" data-comp-label>Click Refresh FUB</span>
                    </div>

                    <!-- DREAMS side -->
                    <div class="dreams-side">
                        <span class="list-count dreams {{ 'zero' if dc|length == 0 else '' }}">{{ dc|length }}</span>
                        <span class="side-label dreams">DREAMS</span>
                        <svg class="expand-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>

                <div class="list-row-body">
                    <div class="body-panels">
                        <!-- FUB contacts panel -->
                        <div class="panel" data-fub-panel>
                            <div class="panel-header fub">FUB Contacts</div>
                            <div class="empty-panel">Click "Refresh FUB" to load</div>
                        </div>

                        <!-- DREAMS contacts panel -->
                        <div class="panel" data-dreams-panel>
                            <div class="panel-header dreams">DREAMS Contacts</div>
                            {% if dc %}
                                {% for c in dc %}
                                <div class="contact-row">
                                    <span class="contact-name">
                                        <a href="/contacts/{{ c.id }}">{{ c.first_name }} {{ c.last_name or '' }}</a>
                                    </span>
                                    <span class="contact-stage">{{ c.stage or '' }}</span>
                                    <span class="score-badges">
                                        {% if c.heat_score %}<span class="score-badge heat">H{{ c.heat_score }}</span>{% endif %}
                                        {% if c.priority_score %}<span class="score-badge priority">P{{ c.priority_score }}</span>{% endif %}
                                    </span>
                                    <span class="contact-phone">
                                        {% if c.phone %}
                                            {% if c.fub_id %}
                                            <a href="https://jontharp.followupboss.com/2/people/view/{{ c.fub_id }}" target="_blank" title="Open in FUB">{{ c.phone|phone }}</a>
                                            {% else %}
                                            {{ c.phone|phone }}
                                            {% endif %}
                                        {% else %}
                                            <span class="no-phone">no phone</span>
                                        {% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-panel">No contacts on this DREAMS list</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
    </div>

    <script>
    // ─── State ──────────────────────────────────────────────────────────
    let fubLists = null;        // Array from /api/smart-lists/fub
    let fubPeopleCache = {};    // { fub_list_id: [contacts] }
    let comparisonCache = {};   // { dreams_key: comparison data }
    let lastUpdated = null;

    // DREAMS contacts pre-loaded from server
    const dreamsData = {{ dreams_lists | tojson }};

    // ─── Helpers ────────────────────────────────────────────────────────
    function formatPhone(value) {
        if (!value) return null;
        const digits = String(value).replace(/\D/g, '');
        if (digits.length === 10) return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
        if (digits.length === 11 && digits[0] === '1') return `(${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
        return value;
    }

    function fubLink(fubId) {
        return `https://jontharp.followupboss.com/2/people/view/${fubId}`;
    }

    // ─── Toggle expand ─────────────────────────────────────────────────
    function toggleRow(header) {
        const row = header.closest('.list-row');
        const wasExpanded = row.classList.contains('expanded');
        row.classList.toggle('expanded');

        // On first expand, load FUB people if we have list data
        if (!wasExpanded && fubLists) {
            const dk = row.dataset.key;
            const fubInfo = fubLists.find(l => l.dreams_key === dk);
            if (fubInfo && !fubPeopleCache[fubInfo.id]) {
                loadFubPeople(fubInfo.id, dk, row);
            }
            // Also load comparison if not cached
            if (fubInfo && !comparisonCache[dk]) {
                loadComparison(dk, fubInfo.id, row);
            }
        }
    }

    // ─── Refresh FUB smart lists ────────────────────────────────────────
    async function refreshFub() {
        const btn = document.getElementById('refreshBtn');
        btn.classList.add('loading');
        btn.textContent = 'Refreshing...';

        try {
            const resp = await fetch('/api/smart-lists/fub');
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || 'Unknown error');

            fubLists = data.lists;
            fubPeopleCache = {};
            comparisonCache = {};
            lastUpdated = new Date();
            updateFreshness();
            renderFubCounts();

        } catch (err) {
            console.error('Failed to refresh FUB lists:', err);
            alert('Failed to load FUB data: ' + err.message);
        } finally {
            btn.classList.remove('loading');
            btn.textContent = 'Refresh FUB';
        }
    }

    function renderFubCounts() {
        if (!fubLists) return;

        document.querySelectorAll('.list-row').forEach(row => {
            const dk = row.dataset.key;
            const fubInfo = fubLists.find(l => l.dreams_key === dk);
            const countEl = row.querySelector('[data-fub-count]');

            if (fubInfo) {
                countEl.textContent = fubInfo.count;
                countEl.classList.remove('fub-loading', 'zero');
                if (fubInfo.count === 0) countEl.classList.add('zero');
            } else {
                countEl.textContent = '?';
                countEl.classList.remove('fub-loading');
            }

            // Update comparison strip placeholder
            const comp = row.querySelector('[data-comp]');
            if (fubInfo) {
                const dc = dreamsData[dk] || [];
                comp.innerHTML = `
                    <span class="comp-stat both" title="Overlap not yet computed">FUB: ${fubInfo.count}</span>
                    <span class="comp-stat dreams-only">DREAMS: ${dc.length}</span>
                `;
            }
        });
    }

    // ─── Load FUB people for a list ─────────────────────────────────────
    async function loadFubPeople(fubListId, dreamsKey, row) {
        const panel = row.querySelector('[data-fub-panel]');
        panel.innerHTML = `<div class="panel-header fub">FUB Contacts</div><div style="padding:8px 0;"><div class="skeleton-bar" style="width:70%;margin-bottom:6px;"></div><div class="skeleton-bar" style="width:50%;"></div></div>`;

        try {
            const resp = await fetch(`/api/smart-lists/fub/${fubListId}/people`);
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);

            fubPeopleCache[fubListId] = data.contacts;
            renderFubPanel(panel, data.contacts);

        } catch (err) {
            panel.innerHTML = `<div class="panel-header fub">FUB Contacts</div><div class="empty-panel">Failed to load: ${err.message}</div>`;
        }
    }

    function renderFubPanel(panel, contacts) {
        let html = '<div class="panel-header fub">FUB Contacts</div>';
        if (!contacts.length) {
            html += '<div class="empty-panel">No contacts on this list</div>';
        } else {
            for (const c of contacts) {
                const phone = formatPhone(c.phone);
                html += `<div class="contact-row">`;
                html += `<span class="contact-name"><a href="${fubLink(c.id)}" target="_blank">${c.name || 'Unknown'}</a></span>`;
                html += `<span class="contact-stage">${c.stage || ''}</span>`;
                if (phone) {
                    html += `<span class="contact-phone"><a href="${fubLink(c.id)}" target="_blank">${phone}</a></span>`;
                } else {
                    html += `<span class="contact-phone"><span class="no-phone">no phone</span></span>`;
                }
                html += `<span class="action-btns">`;
                html += `<a class="action-btn" href="${fubLink(c.id)}" target="_blank">FUB</a>`;
                html += `</span>`;
                html += `</div>`;
            }
        }
        panel.innerHTML = html;
    }

    // ─── Load comparison data ───────────────────────────────────────────
    async function loadComparison(dreamsKey, fubListId, row) {
        const comp = row.querySelector('[data-comp]');

        try {
            const resp = await fetch(`/api/smart-lists/compare/${dreamsKey}?fub_list_id=${fubListId}`);
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);

            comparisonCache[dreamsKey] = data;
            renderComparison(row, data);

        } catch (err) {
            console.error('Comparison failed:', err);
        }
    }

    function renderComparison(row, data) {
        const comp = row.querySelector('[data-comp]');
        const c = data.counts;
        comp.innerHTML = `
            <span class="comp-stat both" title="On both lists">${c.both} both</span>
            <span class="comp-stat fub-only" title="FUB only">${c.fub_only} FUB-only</span>
            <span class="comp-stat dreams-only" title="DREAMS only">${c.dreams_only} DREAMS-only</span>
        `;

        // Update panels with outlier markers
        renderOutlierMarkers(row, data);
    }

    function renderOutlierMarkers(row, data) {
        // Re-render FUB panel with outlier dots for FUB-only contacts
        const fubPanel = row.querySelector('[data-fub-panel]');
        const dk = row.dataset.key;
        const fubInfo = fubLists.find(l => l.dreams_key === dk);

        if (fubInfo && fubPeopleCache[fubInfo.id]) {
            const contacts = fubPeopleCache[fubInfo.id];
            const fubOnlyIds = new Set(data.fub_only.map(f => f.fub_id));
            const reasonMap = {};
            data.fub_only.forEach(f => { reasonMap[f.fub_id] = f.reason; });

            let html = '<div class="panel-header fub">FUB Contacts</div>';
            if (!contacts.length) {
                html += '<div class="empty-panel">No contacts on this list</div>';
            } else {
                for (const c of contacts) {
                    const phone = formatPhone(c.phone);
                    const isOutlier = fubOnlyIds.has(c.id);
                    html += `<div class="contact-row${isOutlier ? ' outlier' : ''}" ${isOutlier ? 'onclick="this.classList.toggle(\'show-reason\')" style="cursor:pointer;"' : ''}>`;
                    if (isOutlier) html += `<span class="outlier-dot fub-only" title="FUB only"></span>`;
                    html += `<span class="contact-name"><a href="${fubLink(c.id)}" target="_blank">${c.name || 'Unknown'}</a></span>`;
                    html += `<span class="contact-stage">${c.stage || ''}</span>`;
                    if (phone) {
                        html += `<span class="contact-phone"><a href="${fubLink(c.id)}" target="_blank">${phone}</a></span>`;
                    }
                    html += `<span class="action-btns"><a class="action-btn" href="${fubLink(c.id)}" target="_blank">FUB</a></span>`;
                    html += `</div>`;
                    if (isOutlier) {
                        html += `<div class="outlier-reason">${reasonMap[c.id] || 'Criteria mismatch'}</div>`;
                    }
                }
            }
            fubPanel.innerHTML = html;
        }

        // Re-render DREAMS panel with outlier dots
        const dreamsPanel = row.querySelector('[data-dreams-panel]');
        const dreamsContacts = dreamsData[dk] || [];
        const dreamsOnlyIds = new Set(data.dreams_only.map(d => d.fub_id));
        const dreamsReasonMap = {};
        data.dreams_only.forEach(d => { dreamsReasonMap[d.fub_id] = d.reason; });

        let dhtml = '<div class="panel-header dreams">DREAMS Contacts</div>';
        if (!dreamsContacts.length) {
            dhtml += '<div class="empty-panel">No contacts on this DREAMS list</div>';
        } else {
            for (const c of dreamsContacts) {
                const phone = formatPhone(c.phone);
                const fubId = c.fub_id ? parseInt(c.fub_id) : null;
                const isOutlier = fubId && dreamsOnlyIds.has(fubId);
                dhtml += `<div class="contact-row${isOutlier ? ' outlier' : ''}" ${isOutlier ? 'onclick="this.classList.toggle(\'show-reason\')" style="cursor:pointer;"' : ''}>`;
                if (isOutlier) dhtml += `<span class="outlier-dot dreams-only" title="DREAMS only"></span>`;
                dhtml += `<span class="contact-name"><a href="/contacts/${c.id}">${c.first_name || ''} ${c.last_name || ''}</a></span>`;
                dhtml += `<span class="contact-stage">${c.stage || ''}</span>`;
                dhtml += `<span class="score-badges">`;
                if (c.heat_score) dhtml += `<span class="score-badge heat">H${c.heat_score}</span>`;
                if (c.priority_score) dhtml += `<span class="score-badge priority">P${c.priority_score}</span>`;
                dhtml += `</span>`;
                if (phone) {
                    if (fubId) {
                        dhtml += `<span class="contact-phone"><a href="${fubLink(fubId)}" target="_blank">${phone}</a></span>`;
                    } else {
                        dhtml += `<span class="contact-phone">${phone}</span>`;
                    }
                }
                dhtml += `</div>`;
                if (isOutlier) {
                    dhtml += `<div class="outlier-reason">${dreamsReasonMap[fubId] || 'Different methodology'}</div>`;
                }
            }
        }
        dreamsPanel.innerHTML = dhtml;
    }

    // ─── Freshness indicator ────────────────────────────────────────────
    function updateFreshness() {
        const el = document.getElementById('freshness');
        if (!lastUpdated) { el.textContent = ''; return; }

        const diff = Math.floor((Date.now() - lastUpdated.getTime()) / 1000);
        if (diff < 60) {
            el.textContent = 'FUB updated just now';
            el.className = 'freshness';
        } else if (diff < 3600) {
            const mins = Math.floor(diff / 60);
            el.textContent = `FUB updated ${mins}m ago`;
            el.className = 'freshness' + (mins > 30 ? ' stale' : '');
        } else {
            el.textContent = `FUB updated ${Math.floor(diff / 3600)}h ago`;
            el.className = 'freshness stale';
        }
    }
    setInterval(updateFreshness, 30000);

    // Refresh when tab becomes visible again (if stale)
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && lastUpdated) {
            if (Date.now() - lastUpdated.getTime() > 5 * 60 * 1000) {
                refreshFub();
            } else {
                updateFreshness();
            }
        }
    });
    </script>
</body>
</html>
