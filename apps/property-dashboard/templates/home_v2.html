<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | DREAMS</title>
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <style>
        /* ========== RESET & BASE ========== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page, #f8fafc);
            color: var(--text-primary, #1a1a1a);
            min-height: 100vh;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 220px;
            height: 100vh;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            z-index: 200;
            transition: width 0.2s;
        }
        .sidebar-brand {
            padding: 20px 20px 16px;
            border-bottom: 1px solid #f1f5f9;
        }
        .sidebar-brand a {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .sidebar-logo {
            width: 32px;
            height: 32px;
            background: var(--color-primary, #1a365d);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-logo svg { width: 18px; height: 18px; }
        .sidebar-brand-text {
            font-size: 18px;
            font-weight: 800;
            color: var(--color-primary, #1a365d);
            letter-spacing: -0.5px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 12px 10px;
            overflow-y: auto;
        }
        .sidebar-section {
            margin-bottom: 8px;
        }
        .sidebar-section-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted, #9ca3af);
            padding: 12px 12px 6px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-secondary, #64748b);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
            position: relative;
        }
        .nav-item:hover {
            background: #f1f5f9;
            color: var(--text-primary, #1a1a1a);
        }
        .nav-item.active {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px;
            bottom: 6px;
            width: 3px;
            background: #2563eb;
            border-radius: 0 3px 3px 0;
        }
        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.7;
        }
        .nav-item.active svg { opacity: 1; }
        .nav-item .nav-label { white-space: nowrap; }
        .nav-item .nav-badge {
            margin-left: auto;
            background: #fee2e2;
            color: #dc2626;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #f1f5f9;
        }
        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
        }
        .sidebar-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-primary, #1a365d);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .sidebar-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .sidebar-user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: 220px;
            min-height: 100vh;
        }

        /* ========== TOP BAR ========== */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 32px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-greeting h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .topbar-date {
            font-size: 13px;
            color: var(--text-secondary, #64748b);
            margin-top: 2px;
        }
        .topbar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .topbar-env {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .topbar-env.dev { background: #fef3c7; color: #92400e; }
        .topbar-env.prd { background: #dcfce7; color: #16a34a; }

        /* ========== PAGE CONTENT ========== */
        .page-content {
            padding: 24px 32px 40px;
            max-width: 1280px;
        }

        /* ========== SHARED: PANEL ========== */
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            overflow: hidden;
        }
        .panel-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        .panel-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .panel-link {
            font-size: 13px;
            color: var(--color-primary-light, #2b6cb0);
            text-decoration: none;
            font-weight: 500;
        }
        .panel-link:hover { text-decoration: underline; }
        .panel-body { padding: 16px 20px; }

        /* ========== ZONE A: OVERNIGHT CARDS ========== */
        .overnight-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .overnight-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border-left: 4px solid transparent;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .overnight-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .overnight-card.new-leads { border-left-color: #22c55e; background: linear-gradient(135deg, #f0fdf4, white); }
        .overnight-card.price-drops { border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff, white); }
        .overnight-card.status-changes { border-left-color: #a855f7; background: linear-gradient(135deg, #faf5ff, white); }
        .overnight-card.going-cold { border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb, white); }
        .overnight-card.quiet-night { border-left-color: #94a3b8; grid-column: 1 / -1; text-align: center; }
        .overnight-count {
            font-size: 32px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 6px;
        }
        .new-leads .overnight-count { color: #16a34a; }
        .price-drops .overnight-count { color: #2563eb; }
        .status-changes .overnight-count { color: #9333ea; }
        .going-cold .overnight-count { color: #d97706; }
        .overnight-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .overnight-detail {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ========== ZONE B+C: TWO-COLUMN ========== */
        .main-grid {
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 20px;
            margin-bottom: 24px;
        }
        .side-col { display: flex; flex-direction: column; gap: 20px; }

        /* ========== CALL LIST (ZONE B) ========== */
        .cl-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 20px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .cl-tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .cl-tab:hover { color: var(--text-primary); }
        .cl-tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .cl-tab .badge {
            display: inline-block;
            background: #e2e8f0;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .cl-tab.active .badge { background: var(--color-primary); color: white; }
        .cl-pane { display: none; }
        .cl-pane.active { display: block; }
        .cl-body { padding: 12px 20px 16px; max-height: 520px; overflow-y: auto; }

        /* Contact row (compact for embedded list) */
        .cl-row {
            display: grid;
            grid-template-columns: 40px 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .cl-row:hover { background: #f8fafc; }
        .cl-row.calling { background: #eff6ff; border-left: 3px solid var(--color-primary); }
        .cl-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--color-primary);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
            flex-shrink: 0;
        }
        .cl-info { min-width: 0; }
        .cl-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cl-name a { color: inherit; text-decoration: none; }
        .cl-name a:hover { color: var(--color-primary); }
        .cl-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
            margin-top: 2px;
        }
        .cl-scores { display: flex; gap: 6px; }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
        }
        .pill-p { background: #e0e7ff; color: #4338ca; }
        .pill-h { background: #fee2e2; color: #dc2626; }

        .cl-action .fub-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            background: #4f46e5;
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.15s;
        }
        .cl-action .fub-btn:hover { background: #4338ca; }

        .cl-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ========== HOTTEST LEADS (ZONE C top) ========== */
        .hot-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }
        .hot-row:last-child { border-bottom: none; }
        .hot-rank {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: #fee2e2;
            color: #dc2626;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 800;
            flex-shrink: 0;
        }
        .hot-info { flex: 1; min-width: 0; }
        .hot-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .hot-name a { color: inherit; text-decoration: none; }
        .hot-name a:hover { color: var(--color-primary); }
        .hot-activity {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 1px;
        }
        .hot-heat {
            background: #fee2e2;
            color: #dc2626;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* ========== SEND PROPERTIES (ZONE C bottom) ========== */
        .sp-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }
        .sp-row:last-child { border-bottom: none; }
        .sp-match-count {
            background: #dcfce7;
            color: #16a34a;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .sp-info { flex: 1; min-width: 0; }
        .sp-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sp-name a { color: inherit; text-decoration: none; }
        .sp-name a:hover { color: var(--color-primary); }
        .sp-detail { font-size: 12px; color: var(--text-secondary); }

        /* ========== ZONE D: PIPELINE BAR ========== */
        .pipeline-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            margin-bottom: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .pipe-cell {
            text-align: center;
            padding: 16px 12px;
            border-right: 1px solid #f1f5f9;
            position: relative;
        }
        .pipe-cell:last-child { border-right: none; }
        .pipe-cell::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        .pipe-cell.leads::after { background: #3b82f6; }
        .pipe-cell.buyers::after { background: #8b5cf6; }
        .pipe-cell.properties::after { background: #22c55e; }
        .pipe-cell.pursuits::after { background: #f59e0b; }
        .pipe-cell.contracts::after { background: #ef4444; }
        .pipe-count {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
        }
        .pipe-cell.leads .pipe-count { color: #2563eb; }
        .pipe-cell.buyers .pipe-count { color: #7c3aed; }
        .pipe-cell.properties .pipe-count { color: #16a34a; }
        .pipe-cell.pursuits .pipe-count { color: #d97706; }
        .pipe-cell.contracts .pipe-count { color: #dc2626; }
        .pipe-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .pipe-detail {
            font-size: 11px;
            color: var(--text-muted, #9ca3af);
            margin-top: 3px;
        }
        .pipe-delta {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }
        .pipe-delta.up { color: #16a34a; }
        .pipe-delta.down { color: #dc2626; }

        /* ========== ZONE E+F: BOTTOM TWO-COLUMN ========== */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Active Deals */
        .deal-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f8fafc;
        }
        .deal-row:last-child { border-bottom: none; }
        .deal-stage {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .deal-stage.new-deal { background: #dbeafe; color: #1e40af; }
        .deal-stage.offer { background: #fef3c7; color: #92400e; }
        .deal-stage.contract { background: #d1fae5; color: #065f46; }
        .deal-stage.listed { background: #f3e8ff; color: #7c3aed; }
        .deal-stage.pending { background: #fee2e2; color: #dc2626; }
        .deal-stage.default { background: #f3f4f6; color: #374151; }
        .deal-info { flex: 1; min-width: 0; }
        .deal-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .deal-detail { font-size: 12px; color: var(--text-secondary); }
        .deal-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-primary);
            flex-shrink: 0;
        }

        /* Buyers needing work */
        .buyer-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f8fafc;
        }
        .buyer-row:last-child { border-bottom: none; }
        .buyer-days {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            background: #fef3c7;
            color: #92400e;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .buyer-days.urgent { background: #fee2e2; color: #dc2626; }
        .buyer-info { flex: 1; min-width: 0; }
        .buyer-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .buyer-name a { color: inherit; text-decoration: none; }
        .buyer-name a:hover { color: var(--color-primary); }
        .buyer-criteria { font-size: 12px; color: var(--text-secondary); }

        /* ========== EMPTY STATE ========== */
        .empty-msg {
            text-align: center;
            padding: 30px 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .empty-icon { font-size: 32px; margin-bottom: 8px; }

        /* ========== KEYBOARD HINT ========== */
        .kb-hint {
            font-size: 11px;
            color: var(--text-muted);
            padding: 8px 20px 12px;
            border-top: 1px solid #f1f5f9;
        }
        kbd {
            display: inline-block;
            padding: 1px 5px;
            font-size: 11px;
            font-family: inherit;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
        }

        /* ========== MOBILE SIDEBAR TOGGLE ========== */
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 300;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--color-primary, #1a365d);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
        }
        .sidebar-toggle svg { width: 22px; height: 22px; }
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 150;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 900px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.open { display: block; }
            .sidebar-toggle { display: flex; }
            .main-content { margin-left: 0; }
            .topbar { padding: 16px 20px; }
            .page-content { padding: 20px 20px 32px; }
            .overnight-row { grid-template-columns: repeat(2, 1fr); }
            .pipeline-bar { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 600px) {
            .overnight-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
        <a href="/">
            <div class="sidebar-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
            </div>
            <span class="sidebar-brand-text">DREAMS</span>
        </a>
    </div>

    <nav class="sidebar-nav">
        <div class="sidebar-section">
            <div class="sidebar-section-label">Main</div>
            <a href="/" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="/contacts" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <span class="nav-label">Contacts</span>
            </a>
            <a href="/call-list" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/>
                </svg>
                <span class="nav-label">Call List</span>
                {% set total_calls = (call_list_counts.get('priority', 0) or 0) %}
                {% if total_calls > 0 %}
                <span class="nav-badge">{{ total_calls }}</span>
                {% endif %}
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-label">Pipeline</div>
            <a href="/properties" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span class="nav-label">Properties</span>
            </a>
            <a href="/pursuits" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="6"/>
                    <circle cx="12" cy="12" r="2"/>
                </svg>
                <span class="nav-label">Pursuits</span>
            </a>
            <a href="/fub-list" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/>
                </svg>
                <span class="nav-label">Deals</span>
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-label">System</div>
            <a href="/admin" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                </svg>
                <span class="nav-label">Settings</span>
            </a>
            <a href="/admin/automation" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <span class="nav-label">Automation</span>
            </a>
            <a href="/system/scoring-runs" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span class="nav-label">Scoring History</span>
            </a>
        </div>
    </nav>

    <div class="sidebar-footer">
        <div class="sidebar-user">
            <div class="sidebar-user-avatar">{{ current_user_name.split(' ')[0][0] }}{{ current_user_name.split(' ')[-1][0] }}</div>
            <div>
                <div class="sidebar-user-name">{{ current_user_name }}</div>
                <div class="sidebar-user-role">Agent</div>
            </div>
        </div>
    </div>
</aside>

<!-- Mobile overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Mobile toggle button -->
<button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle menu">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
</button>

<!-- ===== MAIN CONTENT ===== -->
<div class="main-content">

    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-greeting">
            {% set hour = refresh_time.split(' ')[-2].split(':')[0]|int %}
            <h1>
                {% if hour < 12 %}Good morning{% elif hour < 17 %}Good afternoon{% else %}Good evening{% endif %}, {{ current_user_name.split(' ')[0] }}
            </h1>
            <div class="topbar-date">{{ refresh_time }}</div>
        </div>
        <div class="topbar-actions">
            <span class="topbar-env {{ dreams_env }}">{{ dreams_env }}</span>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content">

        <!-- ===== ZONE A: OVERNIGHT SUMMARY ===== -->
        {% set new_count = overnight.new_leads|length %}
        {% set drops_count = overnight.price_drops|length %}
        {% set status_count = overnight.status_changes|length %}
        {% set cold_count = overnight.going_cold|length %}
        {% set total_overnight = new_count + drops_count + status_count + cold_count %}

        {% if total_overnight > 0 %}
        <div class="overnight-row">
            <div class="overnight-card new-leads">
                <div class="overnight-count">{{ new_count }}</div>
                <div class="overnight-label">New Leads</div>
                {% if new_count > 0 %}
                <div class="overnight-detail">
                    {{ overnight.new_leads[0].first_name }} {{ overnight.new_leads[0].last_name }}{% if new_count > 1 %} + {{ new_count - 1 }} more{% endif %}
                </div>
                {% else %}
                <div class="overnight-detail">No new leads overnight</div>
                {% endif %}
            </div>

            <div class="overnight-card price-drops">
                <div class="overnight-count">{{ drops_count }}</div>
                <div class="overnight-label">Price Drops</div>
                {% if drops_count > 0 %}
                <div class="overnight-detail">
                    {% set drop = overnight.price_drops[0] %}
                    {{ drop.property_address[:30] }}{% if drop.property_address|length > 30 %}...{% endif %}
                </div>
                {% else %}
                <div class="overnight-detail">No price drops detected</div>
                {% endif %}
            </div>

            <div class="overnight-card status-changes">
                <div class="overnight-count">{{ status_count }}</div>
                <div class="overnight-label">Status Changes</div>
                {% if status_count > 0 %}
                <div class="overnight-detail">
                    {% set sc = overnight.status_changes[0] %}
                    {{ sc.old_value }} &rarr; {{ sc.new_value }}
                </div>
                {% else %}
                <div class="overnight-detail">No status changes</div>
                {% endif %}
            </div>

            <div class="overnight-card going-cold">
                <div class="overnight-count">{{ cold_count }}</div>
                <div class="overnight-label">Going Cold</div>
                {% if cold_count > 0 %}
                <div class="overnight-detail">
                    {{ overnight.going_cold[0].first_name }} {{ overnight.going_cold[0].last_name }}{% if cold_count > 1 %} + {{ cold_count - 1 }} more{% endif %}
                </div>
                {% else %}
                <div class="overnight-detail">No one cooling off</div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="overnight-row">
            <div class="overnight-card quiet-night">
                <div class="overnight-count" style="color: #94a3b8;">0</div>
                <div class="overnight-label">Quiet Night</div>
                <div class="overnight-detail">No new leads, price drops, status changes, or cold leads in the last 24 hours.</div>
            </div>
        </div>
        {% endif %}

        <!-- ===== ZONE B + C: MAIN GRID ===== -->
        <div class="main-grid">

            <!-- ZONE B: EMBEDDED CALL LIST -->
            <div class="panel">
                <div class="panel-head">
                    <span class="panel-title">Call List</span>
                    <a href="/call-list" class="panel-link">Full View &rarr;</a>
                </div>

                <div class="cl-tabs">
                    <button class="cl-tab active" data-tab="priority" title="Press 1">
                        Priority <span class="badge">{{ call_list_counts.get('priority', 0) }}</span>
                    </button>
                    <button class="cl-tab" data-tab="new_leads" title="Press 2">
                        New <span class="badge">{{ call_list_counts.get('new_leads', 0) }}</span>
                    </button>
                    <button class="cl-tab" data-tab="hot" title="Press 3">
                        Hot <span class="badge">{{ call_list_counts.get('hot', 0) }}</span>
                    </button>
                    <button class="cl-tab" data-tab="follow_up" title="Press 4">
                        Follow-Up <span class="badge">{{ call_list_counts.get('follow_up', 0) }}</span>
                    </button>
                    <button class="cl-tab" data-tab="going_cold" title="Press 5">
                        Going Cold <span class="badge">{{ call_list_counts.get('going_cold', 0) }}</span>
                    </button>
                </div>

                {% for list_type in ['priority', 'new_leads', 'hot', 'follow_up', 'going_cold'] %}
                <div class="cl-pane {{ 'active' if list_type == 'priority' else '' }}" data-pane="{{ list_type }}">
                    <div class="cl-body">
                        {% set contacts = call_list_data.get(list_type, []) %}
                        {% if contacts %}
                            {% for c in contacts %}
                            <div class="cl-row" id="cl-{{ c.id }}">
                                <div class="cl-avatar">{{ (c.first_name or '?')[0] }}{{ (c.last_name or '')[0] }}</div>
                                <div class="cl-info">
                                    <div class="cl-name">
                                        <a href="/contacts/{{ c.id }}">{{ c.first_name }} {{ c.last_name }}</a>
                                    </div>
                                    <div class="cl-meta">
                                        {% if c.phone %}<span>{{ c.phone|phone }}</span>{% endif %}
                                        <span>{{ c.stage or 'Lead' }}</span>
                                        {% if c.source %}<span>{{ c.source[:18] }}</span>{% endif %}
                                    </div>
                                </div>
                                <div class="cl-scores">
                                    <span class="pill pill-p" title="Priority">P{{ "%.0f"|format(c.priority_score or 0) }}</span>
                                    <span class="pill pill-h" title="Heat">H{{ "%.0f"|format(c.heat_score or 0) }}</span>
                                </div>
                                <div class="cl-action">
                                    {% if c.fub_id %}
                                    <a href="https://jontharp.followupboss.com/2/people/view/{{ c.fub_id }}"
                                       target="_blank"
                                       class="fub-btn"
                                       onclick="markCalling('{{ c.id }}')">
                                        Call in FUB
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="cl-empty">
                                <div style="font-size: 24px; margin-bottom: 6px;">&#9745;</div>
                                No contacts in this list
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <div class="kb-hint">
                    <kbd>1</kbd>-<kbd>5</kbd> switch tabs
                </div>
            </div>

            <!-- ZONE C: SIDE COLUMN -->
            <div class="side-col">

                <!-- Hottest Leads -->
                <div class="panel">
                    <div class="panel-head">
                        <span class="panel-title">Hottest Leads</span>
                        <a href="/contacts?sort=heat_score&order=desc" class="panel-link">All &rarr;</a>
                    </div>
                    <div class="panel-body">
                        {% if hottest_leads %}
                            {% for lead in hottest_leads %}
                            <div class="hot-row">
                                <div class="hot-rank">{{ loop.index }}</div>
                                <div class="hot-info">
                                    <div class="hot-name">
                                        <a href="/contacts/{{ lead.id }}">{{ lead.first_name }} {{ lead.last_name }}</a>
                                    </div>
                                    <div class="hot-activity">
                                        {% if lead.website_visits %}{{ lead.website_visits }} visits{% endif %}
                                        {% if lead.properties_viewed %} &middot; {{ lead.properties_viewed }} viewed{% endif %}
                                        {% if lead.days_since_activity is not none and lead.days_since_activity >= 0 %} &middot; {{ lead.days_since_activity }}d ago{% endif %}
                                    </div>
                                </div>
                                <div class="hot-heat">{{ "%.0f"|format(lead.heat_score or 0) }}</div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-msg">
                                <div class="empty-icon">&#128293;</div>
                                No hot leads right now
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Send Properties -->
                <div class="panel">
                    <div class="panel-head">
                        <span class="panel-title">Send Properties</span>
                        <a href="/actions" class="panel-link">Actions &rarr;</a>
                    </div>
                    <div class="panel-body">
                        {% set send_props = todays_actions.get('send_properties', []) %}
                        {% if send_props %}
                            {% for buyer in send_props %}
                            <div class="sp-row">
                                <div class="sp-match-count">{{ buyer.match_count or 0 }} match{{ 'es' if (buyer.match_count or 0) != 1 else '' }}</div>
                                <div class="sp-info">
                                    <div class="sp-name">
                                        <a href="/contacts/{{ buyer.contact_id or buyer.id }}">{{ buyer.name or (buyer.first_name ~ ' ' ~ (buyer.last_name or '')) }}</a>
                                    </div>
                                    <div class="sp-detail">
                                        {% if buyer.preferred_cities %}{{ buyer.preferred_cities[:30] }}{% endif %}
                                        {% if buyer.max_price %} &middot; up to ${{ "{:,.0f}".format(buyer.max_price) }}{% endif %}
                                    </div>
                                </div>
                                {% if buyer.fub_id %}
                                <a href="https://jontharp.followupboss.com/2/people/view/{{ buyer.fub_id }}"
                                   target="_blank"
                                   class="fub-btn" style="font-size: 11px; padding: 4px 10px;">
                                    FUB
                                </a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-msg">
                                <div class="empty-icon">&#128230;</div>
                                No property matches to send
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>

        <!-- ===== ZONE D: PIPELINE BAR ===== -->
        <div class="pipeline-bar">
            <div class="pipe-cell leads">
                <div class="pipe-count">{{ pipeline.leads.count }}</div>
                <div class="pipe-label">Leads</div>
                {% if pipeline.leads.delta and pipeline.leads.delta != 0 %}
                <div class="pipe-delta {{ 'up' if pipeline.leads.delta > 0 else 'down' }}">
                    {{ '+' if pipeline.leads.delta > 0 else '' }}{{ pipeline.leads.delta }} / 7d
                </div>
                {% endif %}
            </div>
            <div class="pipe-cell buyers">
                <div class="pipe-count">{{ pipeline.buyers.count }}</div>
                <div class="pipe-label">Buyers</div>
                {% if pipeline.buyers.need_intake %}
                <div class="pipe-detail">{{ pipeline.buyers.need_intake }} need intake</div>
                {% endif %}
            </div>
            <div class="pipe-cell properties">
                <div class="pipe-count">{{ pipeline.properties.active }}</div>
                <div class="pipe-label">Properties</div>
                {% if pipeline.properties.new_today %}
                <div class="pipe-detail">{{ pipeline.properties.new_today }} new today</div>
                {% endif %}
                {% if pipeline.properties.price_drops %}
                <div class="pipe-detail">{{ pipeline.properties.price_drops }} price drop{{ 's' if pipeline.properties.price_drops != 1 else '' }}</div>
                {% endif %}
            </div>
            <div class="pipe-cell pursuits">
                <div class="pipe-count">{{ pipeline.pursuits.count }}</div>
                <div class="pipe-label">Pursuits</div>
                {% if pipeline.pursuits.properties_count %}
                <div class="pipe-detail">{{ pipeline.pursuits.properties_count }} properties</div>
                {% endif %}
            </div>
            <div class="pipe-cell contracts">
                <div class="pipe-count">{{ pipeline.contracts.count }}</div>
                <div class="pipe-label">Contracts</div>
                {% if pipeline.contracts.value %}
                <div class="pipe-detail">${{ "{:,.0f}".format(pipeline.contracts.value) }}</div>
                {% endif %}
            </div>
        </div>

        <!-- ===== ZONE E + F: BOTTOM GRID ===== -->
        <div class="bottom-grid">

            <!-- ZONE E: ACTIVE DEALS -->
            <div class="panel">
                <div class="panel-head">
                    <span class="panel-title">Active Deals</span>
                </div>
                <div class="panel-body">
                    {% if active_deals %}
                        {% for deal in active_deals %}
                        <div class="deal-row">
                            {% set stage_lower = (deal.stage_name or '')|lower %}
                            <div class="deal-stage {% if 'new' in stage_lower %}new-deal{% elif 'offer' in stage_lower %}offer{% elif 'contract' in stage_lower %}contract{% elif 'listed' in stage_lower %}listed{% elif 'pending' in stage_lower %}pending{% else %}default{% endif %}">
                                {{ deal.stage_name or 'Unknown' }}
                            </div>
                            <div class="deal-info">
                                <div class="deal-name">{{ deal.person_name or 'Unknown' }}</div>
                                <div class="deal-detail">
                                    {% if deal.property_address %}{{ deal.property_address }}{% endif %}
                                    {% if deal.property_city %}, {{ deal.property_city }}{% endif %}
                                </div>
                            </div>
                            {% if deal.deal_value %}
                            <div class="deal-value">${{ "{:,.0f}".format(deal.deal_value) }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-msg">
                            <div class="empty-icon">&#128188;</div>
                            No active deals in the pipeline
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- ZONE F: BUYERS NEEDING WORK -->
            <div class="panel">
                <div class="panel-head">
                    <span class="panel-title">Buyers Needing Properties</span>
                    <a href="/pursuits" class="panel-link">Pursuits &rarr;</a>
                </div>
                <div class="panel-body">
                    {% if buyers_needing_work %}
                        {% for buyer in buyers_needing_work %}
                        <div class="buyer-row">
                            <div class="buyer-days {{ 'urgent' if buyer.days_since_package is none or (buyer.days_since_package is not none and buyer.days_since_package > 14) else '' }}">
                                {% if buyer.days_since_package is not none %}
                                    {{ buyer.days_since_package }}d ago
                                {% else %}
                                    Never
                                {% endif %}
                            </div>
                            <div class="buyer-info">
                                <div class="buyer-name">
                                    <a href="/contacts/{{ buyer.id }}">{{ buyer.name }}</a>
                                </div>
                                <div class="buyer-criteria">
                                    {{ buyer.need_type or 'Buying' }}
                                    {% if buyer.preferred_cities %} &middot; {{ buyer.preferred_cities[:25] }}{% endif %}
                                    {% if buyer.min_price and buyer.max_price %}
                                        &middot; ${{ "{:,.0f}".format(buyer.min_price) }}-${{ "{:,.0f}".format(buyer.max_price) }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-msg">
                            <div class="empty-icon">&#128269;</div>
                            All buyers have recent property packages
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>

    </div><!-- /page-content -->
</div><!-- /main-content -->

<!-- ===== JAVASCRIPT ===== -->
<script>
(function() {
    // ===== CALL LIST TAB SWITCHING =====
    const tabs = document.querySelectorAll('.cl-tab');
    const panes = document.querySelectorAll('.cl-pane');

    function switchTab(tabName) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
        panes.forEach(p => p.classList.toggle('active', p.dataset.pane === tabName));
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // ===== KEYBOARD SHORTCUTS =====
    const tabOrder = ['priority', 'new_leads', 'hot', 'follow_up', 'going_cold'];
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        const num = parseInt(e.key);
        if (num >= 1 && num <= 5) {
            switchTab(tabOrder[num - 1]);
        }
    });

    // ===== MARK AS CALLING =====
    window.markCalling = function(contactId) {
        const row = document.getElementById('cl-' + contactId);
        if (row) {
            row.classList.add('calling');
        }
    };

    // ===== MOBILE SIDEBAR TOGGLE =====
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const toggle = document.getElementById('sidebarToggle');

    function openSidebar() {
        sidebar.classList.add('open');
        overlay.classList.add('open');
    }
    function closeSidebar() {
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
    }

    toggle.addEventListener('click', () => {
        sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
    });
    overlay.addEventListener('click', closeSidebar);
})();
</script>

</body>
</html>
