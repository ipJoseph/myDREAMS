<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMS Property Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ favicon }}">
    <!-- Shared Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/dreams.css') }}">
    <!-- Page-specific overrides (minimal) -->
    <style>
        /* Address column - moderate width, allow 2 lines */
        td.address-col {
            min-width: 180px;
            max-width: 220px;
            white-space: normal;
            line-height: 1.3;
        }

        /* Address city subtitle */
        .address-city {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* IDX Status badge (smaller inline badge) */
        .idx-status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 4px;
            vertical-align: middle;
        }

        .idx-status-badge.validated {
            background: var(--idx-validated-bg);
            color: var(--idx-validated-text);
        }

        .idx-status-badge.not-found {
            background: var(--idx-not-found-bg);
            color: var(--idx-not-found-text);
        }

        .idx-status-badge.pending {
            background: var(--idx-pending-bg);
            color: var(--idx-pending-text);
        }

        .idx-status-badge.error {
            background: var(--idx-error-bg);
            color: var(--idx-error-text);
        }

        /* Table minimum width */
        .dreams-table {
            min-width: 1400px;
        }

        /* IDX Progress Modal */
        .progress-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px 40px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .progress-modal h3 {
            margin: 0 0 20px 0;
            color: var(--primary-dark);
            font-size: 18px;
        }

        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--success-green));
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-message {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .progress-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-modal.complete .progress-bar {
            background: var(--success-green);
        }

        .progress-modal.error .progress-bar {
            background: var(--alert-red);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dreams-header">
        <div>
            <h1>DREAMS Property Dashboard</h1>
            <div class="dreams-header-subtitle">
                {% if selected_client %}
                    Properties for: {{ selected_client }}
                {% else %}
                    All Properties
                {% endif %}
            </div>
        </div>
        <nav style="display: flex; gap: 16px; align-items: center;">
            <a href="/" class="dreams-btn dreams-btn-secondary">Main</a>
            <span style="font-size: 13px; opacity: 0.8;">{{ refresh_time }}</span>
        </nav>
    </header>

    <!-- Filters -->
    <div class="dreams-filters">
        <div class="dreams-filter-group">
            <label>Client:</label>
            <select id="clientFilter" onchange="applyFilters()">
                <option value="">All Clients</option>
                {% for client in clients %}
                <option value="{{ client }}" {% if selected_client == client %}selected{% endif %}>{{ client }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="dreams-filter-group">
            <label>Status:</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="dreams-filter-group">
            <label>City:</label>
            <select id="cityFilter" onchange="applyFilters()">
                <option value="">All Cities</option>
                {% for city in cities %}
                <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="dreams-filter-group">
            <label>County:</label>
            <select id="countyFilter" onchange="applyFilters()">
                <option value="">All Counties</option>
                {% for county in counties %}
                <option value="{{ county }}" {% if selected_county == county %}selected{% endif %}>{{ county }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="dreams-metrics">
        <div class="dreams-metric-card highlight">
            <div class="dreams-metric-label">Avg Price</div>
            <div class="dreams-metric-value">{{ "${:,.0f}".format(metrics.avg_price) if metrics.avg_price else 'N/A' }}</div>
        </div>
        <div class="dreams-metric-card highlight">
            <div class="dreams-metric-label">Median Price</div>
            <div class="dreams-metric-value">{{ "${:,.0f}".format(metrics.median_price) if metrics.median_price else 'N/A' }}</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg $/SqFt</div>
            <div class="dreams-metric-value">{{ "${:,.0f}".format(metrics.avg_price_per_sqft) if metrics.avg_price_per_sqft else 'N/A' }}</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg Size</div>
            <div class="dreams-metric-value">{{ "{:,.0f}".format(metrics.avg_sqft) if metrics.avg_sqft else 'N/A' }} ft</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg DOM</div>
            <div class="dreams-metric-value">{{ metrics.avg_dom if metrics.avg_dom else 'N/A' }} days</div>
        </div>
        <div class="dreams-metric-card">
            <div class="dreams-metric-label">Avg Lot Size</div>
            <div class="dreams-metric-value">{{ "{:.2f}".format(metrics.avg_lot_acres) if metrics.avg_lot_acres else 'N/A' }} ac</div>
        </div>
    </div>

    <!-- Results Bar -->
    <div class="dreams-results-bar">
        <div class="dreams-results-count">
            <strong>{{ properties|length }}</strong> properties found
            {% if metrics.status_counts %}
                ({% for status, count in metrics.status_counts.items() %}{{ status }}: {{ count }}{% if not loop.last %}, {% endif %}{% endfor %})
            {% endif %}
            <br><span id="selectedCount" style="font-size: 13px; color: var(--text-secondary);"><strong>{{ properties|length }}</strong> properties selected</span>
        </div>
        <div class="dreams-results-actions">
            {% if selected_client %}
            <button class="dreams-btn dreams-btn-success" onclick="copyClientLink()" title="Copy shareable client link">
                <span id="clientLinkBtnText">Copy Client Link</span>
            </button>
            <button class="dreams-btn dreams-btn-secondary" onclick="viewClientLink()" title="Open client view in new tab">
                View Client Link
            </button>
            {% endif %}
            <button class="dreams-btn dreams-btn-primary" onclick="copyMLSNumbers()" title="Copy MLS numbers to clipboard">
                <span id="copyBtnText">Copy MLS #s</span>
            </button>
            <button class="dreams-btn dreams-btn-secondary" onclick="openIDXSearch()" title="Open IDX search page (paste MLS numbers)">
                Open IDX
            </button>
            <button class="dreams-btn dreams-btn-success" onclick="createIDXPortfolio()" title="Auto-fill IDX search with selected properties">
                <span id="portfolioBtnText">Create IDX Portfolio</span>
            </button>
        </div>
    </div>

    <!-- Properties Table -->
    <div class="dreams-table-container">
        <table class="dreams-table" id="propertiesTable">
            <thead>
                <tr>
                    <th class="checkbox-col"><input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this)"></th>
                    <th>#</th>
                    <th>Image</th>
                    <th data-sort="address">Address</th>
                    <th data-sort="mls_number">MLS #</th>
                    <th>IDX</th>
                    <th class="num-col" data-sort="price" data-type="number">Price</th>
                    <th class="num-col" data-sort="dom" data-type="number">DOM</th>
                    <th class="num-col" data-sort="beds" data-type="number">Beds</th>
                    <th class="num-col" data-sort="baths" data-type="number">Baths</th>
                    <th class="num-col" data-sort="sqft" data-type="number">SqFt</th>
                    <th class="num-col" data-sort="lot_acres" data-type="number">Lot</th>
                    <th class="num-col" data-sort="price_per_sqft" data-type="number">$/SqFt</th>
                    <th data-sort="property_type">Type</th>
                    <th class="num-col" data-sort="year_built" data-type="number">Year</th>
                    <th data-sort="county">County</th>
                    <th data-sort="added_for">Client</th>
                    <th data-sort="status">Status</th>
                    <th data-sort="source">Source</th>
                    <th data-sort="city">City</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in properties %}
                {% set idx_mls = prop.idx_mls_number or prop.mls_number %}
                {% set idx_status = prop.idx_validation_status or 'pending' %}
                {% set idx_status_class = idx_status|lower|replace(' ', '-')|replace('_', '-') %}
                <tr data-mls="{{ idx_mls or '' }}">
                    <td class="checkbox-col"><input type="checkbox" class="row-select" checked onchange="updateSelectAll()"></td>
                    <td class="row-num">{{ loop.index }}</td>
                    <td>
                        {% if prop.photo_url %}
                        <img src="{{ prop.photo_url }}" class="dreams-prop-image" alt="Property" onerror="this.outerHTML='<div class=\'dreams-prop-image-placeholder\'>üè†</div>'">
                        {% else %}
                        <div class="dreams-prop-image-placeholder">üè†</div>
                        {% endif %}
                    </td>
                    <td class="address-col">
                        {% if idx_mls %}
                        <a href="https://www.smokymountainhomes4sale.com/property/{{ idx_mls }}" target="_blank" class="dreams-link" title="View on IDX (MLS# {{ idx_mls }})">{{ prop.address or 'Unknown' }}</a>
                        {% elif prop.url %}
                        <a href="{{ prop.url }}" target="_blank" class="dreams-link" title="View on {{ prop.source|default('Redfin')|title }}">{{ prop.address or 'Unknown' }}</a>
                        {% else %}
                        <span>{{ prop.address or 'Unknown' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="dreams-mls">{{ idx_mls or '-' }}</span>
                        {% if prop.original_mls_number and prop.original_mls_number != idx_mls %}
                        <br><span class="dreams-mls" style="font-size: 10px; color: #9ca3af;" title="Original MLS#">{{ prop.original_mls_number }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if idx_mls %}
                        <a href="https://www.smokymountainhomes4sale.com/property/{{ idx_mls }}" target="_blank" class="dreams-idx-link {{ idx_status_class }}" title="View on team site{% if idx_status == 'Validated' %} (Verified){% elif idx_status == 'Not Found' %} (May not be available){% endif %}">View IDX</a>
                        {% else %}
                        <span class="idx-status-badge {{ idx_status_class }}">{{ idx_status }}</span>
                        {% endif %}
                    </td>
                    <td class="num-col dreams-price">{{ "${:,.0f}".format(prop.price) if prop.price else '-' }}</td>
                    <td class="num-col">{{ prop.dom if prop.dom is not none else '-' }}</td>
                    <td class="num-col">{{ prop.beds or '-' }}</td>
                    <td class="num-col">{{ prop.baths or '-' }}</td>
                    <td class="num-col">{{ "{:,.0f}".format(prop.sqft) if prop.sqft else '-' }}</td>
                    <td class="num-col">{{ "{:.2f}".format(prop.lot_acres) if prop.lot_acres else '-' }}</td>
                    <td class="num-col">{{ "${:,.0f}".format(prop.price_per_sqft) if prop.price_per_sqft else '-' }}</td>
                    <td>{{ prop.property_type or '-' }}</td>
                    <td class="num-col">{{ prop.year_built or '-' }}</td>
                    <td>{{ prop.county or '-' }}</td>
                    <td>{{ prop.added_for or '-' }}</td>
                    <td>
                        <span class="dreams-badge dreams-badge-{{ (prop.status or 'unknown')|lower|replace(' ', '-') }}">
                            {{ prop.status or 'Unknown' }}
                        </span>
                    </td>
                    <td>{{ prop.source or '-' }}</td>
                    <td>{{ prop.city or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- IDX Progress Modal -->
    <div id="idxProgressModal" class="progress-modal" style="display: none;">
        <div class="progress-modal-content">
            <h3 id="progressTitle">Creating IDX Portfolio</h3>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressMessage" class="progress-message">Initializing...</div>
            <div id="progressDetails" class="progress-details"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="dreams-footer">
        DREAMS - Desktop Real Estate Agent Management System
    </footer>

    <script>
        function applyFilters() {
            const client = document.getElementById('clientFilter').value;
            const status = document.getElementById('statusFilter').value;
            const city = document.getElementById('cityFilter').value;
            const county = document.getElementById('countyFilter').value;
            const params = new URLSearchParams();

            if (client) params.set('client', client);
            if (status) params.set('status', status);
            if (city) params.set('city', city);
            if (county) params.set('county', county);

            // Always set a marker param to ensure data loads
            params.set('_', '1');

            window.location.search = params.toString();
        }

        // Auto-trigger on initial load if no params (except our marker)
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('_')) {
                // First visit - trigger a reload with marker
                params.set('_', '1');
                window.location.search = params.toString();
            }
        });

        // Get MLS numbers from checked rows only
        function getMLSNumbers() {
            const table = document.getElementById('propertiesTable');
            const rows = table.querySelectorAll('tbody tr');
            const mlsNumbers = [];

            rows.forEach(row => {
                const checkbox = row.querySelector('.row-select');
                if (checkbox && checkbox.checked) {
                    const mls = row.dataset.mls;
                    if (mls && mls !== '') {
                        mlsNumbers.push(mls);
                    }
                }
            });

            return mlsNumbers;
        }

        // Get full property info from checked rows (for validation)
        function getSelectedProperties() {
            const table = document.getElementById('propertiesTable');
            const rows = table.querySelectorAll('tbody tr');
            const properties = [];

            rows.forEach(row => {
                const checkbox = row.querySelector('.row-select');
                if (checkbox && checkbox.checked) {
                    const mls = row.dataset.mls;
                    const addressLink = row.querySelector('.dreams-link');
                    const address = addressLink ? addressLink.textContent.trim() : '';
                    const idxLink = row.querySelector('.dreams-idx-link');
                    const idxStatus = idxLink ?
                        (idxLink.classList.contains('validated') ? 'validated' :
                         idxLink.classList.contains('pending') ? 'pending' :
                         idxLink.classList.contains('not-found') ? 'not_found' : 'pending')
                        : 'pending';

                    properties.push({
                        mls_number: mls || '',
                        address: address,
                        idx_status: idxStatus
                    });
                }
            });

            return properties;
        }

        // Update selected count display
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.row-select');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const countEl = document.getElementById('selectedCount');
            if (countEl) {
                countEl.innerHTML = `<strong>${selectedCount}</strong> properties selected`;
            }
        }

        // Toggle all checkboxes
        function toggleSelectAll(headerCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
            updateSelectedCount();
        }

        // Update header checkbox based on row selections
        function updateSelectAll() {
            const checkboxes = document.querySelectorAll('.row-select');
            const selectAll = document.getElementById('selectAll');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);

            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
            updateSelectedCount();
        }

        // Initialize selected count on page load
        document.addEventListener('DOMContentLoaded', updateSelectedCount);

        // Copy client link to clipboard
        async function copyClientLink() {
            const clientName = '{{ selected_client | default("", true) }}';
            if (!clientName) {
                alert('No client selected');
                return;
            }
            const baseUrl = window.location.origin;
            const clientUrl = `${baseUrl}/client/${encodeURIComponent(clientName)}?key=dreams2026`;

            try {
                await navigator.clipboard.writeText(clientUrl);
                const btn = document.getElementById('clientLinkBtnText');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy Client Link', 2000);
            } catch (err) {
                // Fallback
                prompt('Copy this link:', clientUrl);
            }
        }

        // Open client view in new tab
        function viewClientLink() {
            const clientName = '{{ selected_client | default("", true) }}';
            if (!clientName) {
                alert('No client selected');
                return;
            }
            const baseUrl = window.location.origin;
            const clientUrl = `${baseUrl}/client/${encodeURIComponent(clientName)}?key=dreams2026`;
            window.open(clientUrl, '_blank');
        }

        // Copy MLS numbers to clipboard
        async function copyMLSNumbers() {
            const mlsNumbers = getMLSNumbers();

            if (mlsNumbers.length === 0) {
                alert('No MLS numbers found in the current view.');
                return;
            }

            const mlsString = mlsNumbers.join(', ');

            try {
                await navigator.clipboard.writeText(mlsString);

                // Visual feedback
                const btn = document.getElementById('copyBtnText');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.parentElement.classList.add('dreams-btn-success');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.parentElement.classList.remove('dreams-btn-success');
                }, 2000);

            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = mlsString;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied ' + mlsNumbers.length + ' MLS numbers to clipboard!');
            }
        }

        // Open IDX search with MLS numbers
        function openIDXSearch() {
            const mlsNumbers = getMLSNumbers();

            if (mlsNumbers.length === 0) {
                alert('No MLS numbers found in the current view.');
                return;
            }

            // IDX site URL - we'll test if URL params work
            const baseUrl = 'https://www.smokymountainhomes4sale.com/search/mls_search/';

            // First, copy to clipboard as backup
            const mlsString = mlsNumbers.join(', ');
            navigator.clipboard.writeText(mlsString).catch(() => {});

            // Open the IDX page (user can paste if URL params don't work)
            window.open(baseUrl, '_blank');
        }

        // Create IDX Portfolio - validates pending properties first, then launches automation
        async function createIDXPortfolio() {
            const properties = getSelectedProperties();

            if (properties.length === 0) {
                alert('No properties selected. Check the boxes for properties you want to include.');
                return;
            }

            // Prompt for search name - default: YYMMDD.HHMM.ClientName
            const now = new Date();
            const yy = String(now.getFullYear()).slice(-2);
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const clientName = document.getElementById('clientFilter').value || 'Portfolio';
            const defaultName = `${yy}${mm}${dd}.${hh}${min}.${clientName}`;
            const searchName = prompt('Enter a name for this saved search:', defaultName);

            if (searchName === null) {
                // User cancelled
                return;
            }

            const btn = document.getElementById('portfolioBtnText');
            const originalText = btn.textContent;

            // Check for pending properties that need validation
            const pendingProps = properties.filter(p => p.idx_status === 'pending' && p.address);
            let finalMlsNumbers = [];

            if (pendingProps.length > 0) {
                // Validate pending properties first
                btn.textContent = `Validating ${pendingProps.length}...`;

                try {
                    const validateResponse = await fetch('/api/validate-idx', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ properties: pendingProps })
                    });

                    const validateData = await validateResponse.json();

                    if (validateData.success) {
                        // Build map of address -> validated MLS and track stats
                        const validatedMap = {};
                        let foundByMls = 0;
                        let foundByAddress = 0;
                        let notFound = 0;

                        validateData.results.forEach(r => {
                            if (r.idx_mls) {
                                validatedMap[r.address.toLowerCase()] = r.idx_mls;
                                // Check if found by original MLS or by address search
                                if (r.idx_mls === r.original_mls) {
                                    foundByMls++;
                                } else {
                                    foundByAddress++;
                                }
                            } else {
                                notFound++;
                            }
                        });

                        // Build final MLS list using validated numbers where available
                        properties.forEach(p => {
                            const validatedMls = validatedMap[p.address.toLowerCase()];
                            if (validatedMls) {
                                finalMlsNumbers.push(validatedMls);
                            } else if (p.mls_number) {
                                finalMlsNumbers.push(p.mls_number);
                            }
                        });

                        // Log validation summary
                        console.log(`IDX Validation Summary:`);
                        console.log(`  Total validated: ${validateData.total_count}`);
                        console.log(`  Found by MLS#: ${foundByMls}`);
                        console.log(`  Found by Address: ${foundByAddress}`);
                        console.log(`  Not on IDX: ${notFound}`);

                        // Show notification to user
                        const alreadyValidated = properties.length - pendingProps.length;
                        let summaryMsg = `Validation Complete:\n`;
                        summaryMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                        summaryMsg += `${properties.length} Properties Selected\n`;
                        if (alreadyValidated > 0) {
                            summaryMsg += `${alreadyValidated} Already Validated\n`;
                        }
                        summaryMsg += `${foundByMls} Found by MLS#\n`;
                        summaryMsg += `${foundByAddress} Found by Address\n`;
                        if (notFound > 0) {
                            summaryMsg += `${notFound} Not on IDX\n`;
                        }
                        summaryMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                        summaryMsg += `${finalMlsNumbers.length} will be added to portfolio`;

                        alert(summaryMsg);
                    } else {
                        // Validation failed, fall back to original MLS numbers
                        console.warn('Validation failed, using original MLS numbers');
                        finalMlsNumbers = properties.map(p => p.mls_number).filter(m => m);
                    }
                } catch (err) {
                    console.warn('Validation error, using original MLS numbers:', err);
                    finalMlsNumbers = properties.map(p => p.mls_number).filter(m => m);
                }
            } else {
                // No pending properties, use existing MLS numbers
                finalMlsNumbers = properties.map(p => p.mls_number).filter(m => m);
            }

            if (finalMlsNumbers.length === 0) {
                alert('No valid MLS numbers found for selected properties.');
                btn.textContent = originalText;
                return;
            }

            // Now launch the portfolio
            btn.textContent = 'Launching...';

            try {
                const response = await fetch('/api/idx-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mls_numbers: finalMlsNumbers,
                        search_name: searchName.trim() || defaultName
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show progress modal and start polling
                    const clientUrl = data.client_url;
                    showProgressModal(finalMlsNumbers.length, clientUrl);
                    btn.textContent = originalText;
                } else {
                    alert('Error: ' + data.error);
                    btn.textContent = originalText;
                }
            } catch (error) {
                alert('Error launching portfolio: ' + error.message);
                btn.textContent = originalText;
            }
        }

        // Progress modal functions
        let progressPollInterval = null;

        function showProgressModal(totalCount, clientUrl) {
            const modal = document.getElementById('idxProgressModal');
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressDetails = document.getElementById('progressDetails');
            const progressTitle = document.getElementById('progressTitle');

            // Reset modal state
            modal.classList.remove('complete', 'error');
            progressBar.style.width = '5%';
            progressMessage.textContent = 'Initializing...';
            progressDetails.textContent = `0 of ${totalCount} properties`;
            progressTitle.textContent = 'Creating IDX Portfolio';
            modal.style.display = 'flex';

            // Store clientUrl for later
            modal.dataset.clientUrl = clientUrl || '';

            // Start polling for progress
            progressPollInterval = setInterval(() => pollProgress(totalCount), 1000);
        }

        async function pollProgress(totalCount) {
            try {
                const response = await fetch('/api/idx-progress');
                const data = await response.json();

                const modal = document.getElementById('idxProgressModal');
                const progressBar = document.getElementById('progressBar');
                const progressMessage = document.getElementById('progressMessage');
                const progressDetails = document.getElementById('progressDetails');
                const progressTitle = document.getElementById('progressTitle');

                // Update progress based on status
                switch (data.status) {
                    case 'starting':
                        progressBar.style.width = '10%';
                        progressMessage.textContent = data.message || 'Initializing...';
                        break;

                    case 'logging_in':
                        progressBar.style.width = '20%';
                        progressMessage.textContent = data.message || 'Logging into IDX site...';
                        break;

                    case 'searching':
                        progressBar.style.width = '40%';
                        progressMessage.textContent = data.message || 'Searching properties...';
                        break;

                    case 'saving':
                        progressBar.style.width = '80%';
                        progressMessage.textContent = data.message || 'Saving search...';
                        break;

                    case 'complete':
                        progressBar.style.width = '100%';
                        progressMessage.textContent = data.message || 'Portfolio created successfully!';
                        progressTitle.textContent = 'Complete!';
                        modal.classList.add('complete');

                        // Stop polling
                        clearInterval(progressPollInterval);
                        progressPollInterval = null;

                        // Show client URL and saved searches link
                        const clientUrl = modal.dataset.clientUrl;
                        const savedSearchesUrl = 'https://www.smokymountainhomes4sale.com/member/saved_searches/';
                        let detailsHtml = `<br><strong>Verify on IDX:</strong><br><a href="${savedSearchesUrl}" target="_blank" style="color: var(--accent-blue);">View Saved Searches</a><br>`;

                        if (clientUrl) {
                            const prdUrl = clientUrl.replace(window.location.origin, 'https://app.wncmountain.homes');
                            detailsHtml += `<br><strong>Client URL:</strong><br><a href="${prdUrl}" target="_blank" style="color: var(--accent-blue);">${prdUrl}</a><br><br><small>Password: dreams2026</small>`;

                            // Copy to clipboard
                            navigator.clipboard.writeText(prdUrl).catch(() => {});
                        }
                        progressDetails.innerHTML = detailsHtml;

                        // Open saved searches page in new tab for verification
                        window.open(savedSearchesUrl, '_blank');

                        // Auto-hide after 8 seconds (more time to click links)
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 8000);
                        break;

                    case 'error':
                        progressBar.style.width = '100%';
                        progressMessage.textContent = 'Error: ' + (data.error || 'Unknown error');
                        progressTitle.textContent = 'Error';
                        modal.classList.add('error');

                        // Stop polling
                        clearInterval(progressPollInterval);
                        progressPollInterval = null;

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 5000);
                        break;

                    case 'idle':
                        // Check if we've been idle for too long (automation may have started)
                        // Keep showing initializing state
                        break;
                }

                // Update details with counts if available (but not on complete/error - those have their own content)
                if (data.status !== 'complete' && data.status !== 'error' &&
                    data.current !== undefined && data.total !== undefined && data.total > 0) {
                    progressDetails.textContent = `${data.current} of ${data.total} properties`;
                }

            } catch (error) {
                console.error('Error polling progress:', error);
            }
        }

        // Allow clicking outside modal to close it (after completion)
        document.getElementById('idxProgressModal').addEventListener('click', function(e) {
            if (e.target === this && (this.classList.contains('complete') || this.classList.contains('error'))) {
                this.style.display = 'none';
                if (progressPollInterval) {
                    clearInterval(progressPollInterval);
                    progressPollInterval = null;
                }
            }
        });

        // Table sorting
        let currentSort = { column: null, direction: null }; // null = unsorted, 'asc', 'desc'
        let originalOrder = []; // Store original row order

        // Save original order on page load
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.querySelector('#propertiesTable tbody');
            if (tbody) {
                originalOrder = Array.from(tbody.querySelectorAll('tr'));
            }
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => sortTable(th));
        });

        function sortTable(th) {
            const column = th.dataset.sort;
            const isNumeric = th.dataset.type === 'number';
            const table = document.getElementById('propertiesTable');
            const tbody = table.querySelector('tbody');
            let rows = Array.from(tbody.querySelectorAll('tr'));

            // Cycle through: null -> asc -> desc -> null
            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = null;
                    currentSort.column = null;
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header styling
            document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            if (currentSort.direction) {
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            // If unsorted, restore original order
            if (!currentSort.direction) {
                rows = [...originalOrder];
            } else {
                // Get column index
                const colIndex = Array.from(th.parentElement.children).indexOf(th);

                // Sort rows
                rows.sort((a, b) => {
                    let aVal = a.children[colIndex]?.textContent?.trim() || '';
                    let bVal = b.children[colIndex]?.textContent?.trim() || '';

                    if (isNumeric) {
                        aVal = parseFloat(aVal.replace(/[$,]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[$,]/g, '')) || 0;
                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        return currentSort.direction === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    }
                });
            }

            // Rebuild table
            rows.forEach((row, i) => {
                row.querySelector('.row-num').textContent = i + 1;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
