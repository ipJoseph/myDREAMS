<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMS Property Dashboard</title>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2b6cb0;
            --success: #137333;
            --warning: #f59e0b;
            --error: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Filters */
        .filters {
            background: var(--surface);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        /* Metrics Cards */
        .metrics-container {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .metric-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .metric-card.highlight {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
        }

        .metric-card.highlight .metric-value {
            color: white;
        }

        /* Results count */
        .results-bar {
            padding: 12px 24px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .results-count strong {
            color: var(--text);
        }

        .results-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .action-btn:hover {
            background: var(--primary-light);
        }

        .action-btn.secondary {
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .action-btn.secondary:hover {
            background: var(--bg);
        }

        .action-btn.success {
            background: var(--success);
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        .checkbox-col input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Table */
        .table-container {
            padding: 0 24px 24px;
            overflow-x: auto;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }

        table {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--primary-light);
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 10px;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 10px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Row number */
        .row-num {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Address column - wider, no wrap */
        td.address-col {
            min-width: 280px;
            white-space: nowrap;
        }

        /* IDX link button style */
        .idx-link {
            display: inline-block;
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.15s;
        }

        .idx-link:hover {
            background: var(--primary-light);
            color: white;
        }

        /* Property image */
        .prop-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--border);
        }

        .prop-image-placeholder {
            width: 80px;
            height: 60px;
            background: var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 24px;
        }

        /* Address link */
        .address-link {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 500;
        }

        .address-link:hover {
            text-decoration: underline;
        }

        .address-city {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active, .status-badge.for-sale {
            background: #dcfce7;
            color: #137333;
        }

        .status-badge.pending, .status-badge.contingent {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.sold, .status-badge.off-market {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Price formatting */
        .price {
            font-weight: 600;
            color: var(--text);
        }

        .price-cut {
            color: var(--success);
            font-size: 12px;
        }

        /* Numeric columns */
        .num-col {
            text-align: right;
        }

        /* N/A styling */
        .na {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Footer */
        .footer {
            padding: 16px 24px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .metrics-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <h1>DREAMS Property Dashboard</h1>
            <div class="header-subtitle">
                {% if selected_client %}
                    Properties for: {{ selected_client }}
                {% else %}
                    All Properties
                {% endif %}
            </div>
        </div>
        <div style="font-size: 13px; opacity: 0.8;">
            Last refreshed: {{ refresh_time }}
        </div>
    </header>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-group">
            <label>Client:</label>
            <select id="clientFilter" onchange="applyFilters()">
                <option value="">All Clients</option>
                {% for client in clients %}
                <option value="{{ client }}" {% if selected_client == client %}selected{% endif %}>{{ client }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Status:</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>City:</label>
            <select id="cityFilter" onchange="applyFilters()">
                <option value="">All Cities</option>
                {% for city in cities %}
                <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>County:</label>
            <select id="countyFilter" onchange="applyFilters()">
                <option value="">All Counties</option>
                {% for county in counties %}
                <option value="{{ county }}" {% if selected_county == county %}selected{% endif %}>{{ county }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-container">
        <div class="metric-card highlight">
            <div class="metric-label">Avg Price</div>
            <div class="metric-value">{{ "${:,.0f}".format(metrics.avg_price) if metrics.avg_price else 'N/A' }}</div>
        </div>
        <div class="metric-card highlight">
            <div class="metric-label">Median Price</div>
            <div class="metric-value">{{ "${:,.0f}".format(metrics.median_price) if metrics.median_price else 'N/A' }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg $/SqFt</div>
            <div class="metric-value">{{ "${:,.0f}".format(metrics.avg_price_per_sqft) if metrics.avg_price_per_sqft else 'N/A' }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Size</div>
            <div class="metric-value">{{ "{:,.0f}".format(metrics.avg_sqft) if metrics.avg_sqft else 'N/A' }} ft</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg DOM</div>
            <div class="metric-value">{{ metrics.avg_dom if metrics.avg_dom else 'N/A' }} days</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Lot Size</div>
            <div class="metric-value">{{ "{:.2f}".format(metrics.avg_lot_acres) if metrics.avg_lot_acres else 'N/A' }} ac</div>
        </div>
    </div>

    <!-- Results Bar -->
    <div class="results-bar">
        <div class="results-count">
            <strong>{{ properties|length }}</strong> properties found
            {% if metrics.status_counts %}
                ({% for status, count in metrics.status_counts.items() %}{{ status }}: {{ count }}{% if not loop.last %}, {% endif %}{% endfor %})
            {% endif %}
        </div>
        <div class="results-actions">
            <button class="action-btn" onclick="copyMLSNumbers()" title="Copy MLS numbers to clipboard">
                <span id="copyBtnText">Copy MLS #s</span>
            </button>
            <button class="action-btn secondary" onclick="openIDXSearch()" title="Open IDX search page (paste MLS numbers)">
                Open IDX
            </button>
            <button class="action-btn" onclick="createIDXPortfolio()" title="Auto-fill IDX search with selected properties" style="background: var(--success);">
                <span id="portfolioBtnText">Create IDX Portfolio</span>
            </button>
        </div>
    </div>

    <!-- Properties Table -->
    <div class="table-container">
        <table id="propertiesTable">
            <thead>
                <tr>
                    <th class="checkbox-col"><input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this)"></th>
                    <th>#</th>
                    <th>Image</th>
                    <th data-sort="address">Address</th>
                    <th data-sort="city">City</th>
                    <th data-sort="county">County</th>
                    <th data-sort="added_for">Client</th>
                    <th data-sort="status">Status</th>
                    <th class="num-col" data-sort="dom" data-type="number">DOM</th>
                    <th class="num-col" data-sort="price" data-type="number">Price</th>
                    <th class="num-col" data-sort="price_per_sqft" data-type="number">$/SqFt</th>
                    <th data-sort="property_type">Type</th>
                    <th class="num-col" data-sort="year_built" data-type="number">Year</th>
                    <th class="num-col" data-sort="beds" data-type="number">Beds</th>
                    <th class="num-col" data-sort="baths" data-type="number">Baths</th>
                    <th class="num-col" data-sort="sqft" data-type="number">SqFt</th>
                    <th class="num-col" data-sort="lot_acres" data-type="number">Lot</th>
                    <th data-sort="source">Source</th>
                    <th data-sort="mls_number">MLS #</th>
                    <th>IDX</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in properties %}
                <tr data-mls="{{ prop.mls_number or '' }}">
                    <td class="checkbox-col"><input type="checkbox" class="row-select" checked onchange="updateSelectAll()"></td>
                    <td class="row-num">{{ loop.index }}</td>
                    <td>
                        {% if prop.photo_url %}
                        <img src="{{ prop.photo_url }}" class="prop-image" alt="Property" onerror="this.outerHTML='<div class=\'prop-image-placeholder\'>üè†</div>'">
                        {% else %}
                        <div class="prop-image-placeholder">üè†</div>
                        {% endif %}
                    </td>
                    <td class="address-col">
                        {% if prop.url %}
                        <a href="{{ prop.url }}" target="_blank" class="address-link">{{ prop.address or 'Unknown' }}</a>
                        {% else %}
                        <a href="{{ prop.notion_url }}" target="_blank" class="address-link">{{ prop.address or 'Unknown' }}</a>
                        {% endif %}
                    </td>
                    <td>{{ prop.city or '-' }}</td>
                    <td>{{ prop.county or '-' }}</td>
                    <td>{{ prop.added_for or '-' }}</td>
                    <td>
                        <span class="status-badge {{ (prop.status or 'unknown')|lower|replace(' ', '-') }}">
                            {{ prop.status or 'Unknown' }}
                        </span>
                    </td>
                    <td class="num-col">{{ prop.dom if prop.dom is not none else '-' }}</td>
                    <td class="num-col price">{{ "${:,.0f}".format(prop.price) if prop.price else '-' }}</td>
                    <td class="num-col">{{ "${:,.0f}".format(prop.price_per_sqft) if prop.price_per_sqft else '-' }}</td>
                    <td>{{ prop.property_type or '-' }}</td>
                    <td class="num-col">{{ prop.year_built or '-' }}</td>
                    <td class="num-col">{{ prop.beds or '-' }}</td>
                    <td class="num-col">{{ prop.baths or '-' }}</td>
                    <td class="num-col">{{ "{:,.0f}".format(prop.sqft) if prop.sqft else '-' }}</td>
                    <td class="num-col">{{ "{:.2f}".format(prop.lot_acres) if prop.lot_acres else '-' }}</td>
                    <td>{{ prop.source or '-' }}</td>
                    <td>{{ prop.mls_number or '-' }}</td>
                    <td>
                        {% if prop.mls_number %}
                        <a href="https://www.smokymountainhomes4sale.com/property/{{ prop.mls_number }}" target="_blank" class="idx-link" title="View on team site">View</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <footer class="footer">
        DREAMS - Desktop Real Estate Agent Management System
    </footer>

    <script>
        function applyFilters() {
            const client = document.getElementById('clientFilter').value;
            const status = document.getElementById('statusFilter').value;
            const city = document.getElementById('cityFilter').value;
            const county = document.getElementById('countyFilter').value;
            const params = new URLSearchParams();

            if (client) params.set('client', client);
            if (status) params.set('status', status);
            if (city) params.set('city', city);
            if (county) params.set('county', county);

            // Always set a marker param to ensure data loads
            params.set('_', '1');

            window.location.search = params.toString();
        }

        // Auto-trigger on initial load if no params (except our marker)
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('_')) {
                // First visit - trigger a reload with marker
                params.set('_', '1');
                window.location.search = params.toString();
            }
        });

        // Get MLS numbers from checked rows only
        function getMLSNumbers() {
            const table = document.getElementById('propertiesTable');
            const rows = table.querySelectorAll('tbody tr');
            const mlsNumbers = [];

            rows.forEach(row => {
                const checkbox = row.querySelector('.row-select');
                if (checkbox && checkbox.checked) {
                    const mls = row.dataset.mls;
                    if (mls && mls !== '') {
                        mlsNumbers.push(mls);
                    }
                }
            });

            return mlsNumbers;
        }

        // Toggle all checkboxes
        function toggleSelectAll(headerCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
        }

        // Update header checkbox based on row selections
        function updateSelectAll() {
            const checkboxes = document.querySelectorAll('.row-select');
            const selectAll = document.getElementById('selectAll');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);

            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        // Copy MLS numbers to clipboard
        async function copyMLSNumbers() {
            const mlsNumbers = getMLSNumbers();

            if (mlsNumbers.length === 0) {
                alert('No MLS numbers found in the current view.');
                return;
            }

            const mlsString = mlsNumbers.join(', ');

            try {
                await navigator.clipboard.writeText(mlsString);

                // Visual feedback
                const btn = document.getElementById('copyBtnText');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.parentElement.classList.add('success');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.parentElement.classList.remove('success');
                }, 2000);

            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = mlsString;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied ' + mlsNumbers.length + ' MLS numbers to clipboard!');
            }
        }

        // Open IDX search with MLS numbers
        function openIDXSearch() {
            const mlsNumbers = getMLSNumbers();

            if (mlsNumbers.length === 0) {
                alert('No MLS numbers found in the current view.');
                return;
            }

            // IDX site URL - we'll test if URL params work
            const baseUrl = 'https://www.smokymountainhomes4sale.com/search/mls_search/';

            // First, copy to clipboard as backup
            const mlsString = mlsNumbers.join(', ');
            navigator.clipboard.writeText(mlsString).catch(() => {});

            // Open the IDX page (user can paste if URL params don't work)
            window.open(baseUrl, '_blank');
        }

        // Create IDX Portfolio - launches Playwright automation
        async function createIDXPortfolio() {
            const mlsNumbers = getMLSNumbers();

            if (mlsNumbers.length === 0) {
                alert('No properties selected. Check the boxes for properties you want to include.');
                return;
            }

            const btn = document.getElementById('portfolioBtnText');
            const originalText = btn.textContent;
            btn.textContent = 'Launching...';

            try {
                const response = await fetch('/api/idx-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mls_numbers: mlsNumbers })
                });

                const data = await response.json();

                if (data.success) {
                    btn.textContent = 'Launched!';
                    btn.parentElement.classList.add('success');
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 3000);
                } else {
                    alert('Error: ' + data.error);
                    btn.textContent = originalText;
                }
            } catch (error) {
                alert('Error launching portfolio: ' + error.message);
                btn.textContent = originalText;
            }
        }

        // Table sorting
        let currentSort = { column: null, direction: null }; // null = unsorted, 'asc', 'desc'
        let originalOrder = []; // Store original row order

        // Save original order on page load
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.querySelector('#propertiesTable tbody');
            if (tbody) {
                originalOrder = Array.from(tbody.querySelectorAll('tr'));
            }
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => sortTable(th));
        });

        function sortTable(th) {
            const column = th.dataset.sort;
            const isNumeric = th.dataset.type === 'number';
            const table = document.getElementById('propertiesTable');
            const tbody = table.querySelector('tbody');
            let rows = Array.from(tbody.querySelectorAll('tr'));

            // Cycle through: null -> asc -> desc -> null
            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = null;
                    currentSort.column = null;
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header styling
            document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            if (currentSort.direction) {
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            // If unsorted, restore original order
            if (!currentSort.direction) {
                rows = [...originalOrder];
            } else {
                // Get column index
                const colIndex = Array.from(th.parentElement.children).indexOf(th);

                // Sort rows
                rows.sort((a, b) => {
                    let aVal = a.children[colIndex]?.textContent?.trim() || '';
                    let bVal = b.children[colIndex]?.textContent?.trim() || '';

                    if (isNumeric) {
                        aVal = parseFloat(aVal.replace(/[$,]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[$,]/g, '')) || 0;
                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        return currentSort.direction === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    }
                });
            }

            // Rebuild table
            rows.forEach((row, i) => {
                row.querySelector('.row-num').textContent = i + 1;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
