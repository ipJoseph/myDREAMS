<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background: #f1f5f9;
    }
    .container {
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .header {
        background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
        color: white;
        padding: 24px 20px;
        text-align: center;
    }
    .header h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    .header .subtitle {
        opacity: 0.9;
        font-size: 13px;
        margin-top: 4px;
    }
    .stats-row {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 12px;
    }
    .stat-item {
        text-align: center;
    }
    .stat-value {
        font-size: 24px;
        font-weight: 700;
    }
    .stat-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }
    .content {
        padding: 24px 20px;
    }
    .section-title {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #1a365d;
        margin: 20px 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }
    .section-title:first-child {
        margin-top: 0;
    }
    .buyer-group {
        margin-bottom: 20px;
    }
    .buyer-header {
        font-size: 16px;
        font-weight: 600;
        color: #1a365d;
        margin: 0 0 8px 0;
    }
    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    .activity-item:last-child {
        border-bottom: none;
    }
    .activity-icon {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
        margin-top: 2px;
    }
    .icon-favorite { background: #fef2f2; color: #dc2626; }
    .icon-collection { background: #eff6ff; color: #2563eb; }
    .icon-showing { background: #fffbeb; color: #d97706; }
    .icon-search { background: #f0fdf4; color: #16a34a; }
    .icon-default { background: #f8fafc; color: #64748b; }
    .activity-text {
        font-size: 14px;
        color: #334155;
    }
    .activity-time {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 2px;
    }
    .activity-entity {
        color: #1a365d;
        font-weight: 500;
    }
    .cta {
        text-align: center;
        margin: 24px 0 8px 0;
    }
    .cta a {
        display: inline-block;
        padding: 12px 28px;
        background: #1a365d;
        color: #ffffff;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
    }
    .footer {
        text-align: center;
        padding: 16px 20px;
        color: #94a3b8;
        font-size: 11px;
        border-top: 1px solid #f1f5f9;
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Buyer Activity Digest</h1>
        <div class="subtitle">{{ date }}</div>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value">{{ total_actions }}</div>
                <div class="stat-label">Actions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ buyer_count }}</div>
                <div class="stat-label">Buyers</div>
            </div>
            {% if showing_request_count %}
            <div class="stat-item">
                <div class="stat-value">{{ showing_request_count }}</div>
                <div class="stat-label">Showing Requests</div>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="content">
        {% if showing_requests %}
        <div class="section-title">Showing Requests (Urgent)</div>
        {% for sr in showing_requests %}
        <div class="activity-item">
            <div class="activity-icon icon-showing">&#128197;</div>
            <div>
                <div class="activity-text">
                    <span class="activity-entity">{{ sr.buyer_name or sr.user_id }}</span>
                    requested showings for
                    <span class="activity-entity">{{ sr.entity_name or 'a collection' }}</span>
                </div>
                <div class="activity-time">{{ sr.occurred_at }}</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <div class="section-title">Activity Feed</div>
        {% for buyer_name, activities in grouped_activities.items() %}
        <div class="buyer-group">
            <p class="buyer-header">{{ buyer_name }}</p>
            {% for act in activities %}
            <div class="activity-item">
                <div class="activity-icon
                    {% if act.activity_type in ('favorite', 'unfavorite') %}icon-favorite
                    {% elif act.activity_type in ('create_collection', 'add_to_collection', 'remove_from_collection') %}icon-collection
                    {% elif act.activity_type in ('request_showings', 'cancel_showings') %}icon-showing
                    {% elif act.activity_type == 'save_search' %}icon-search
                    {% else %}icon-default{% endif %}
                ">
                    {% if act.activity_type == 'favorite' %}&#10084;
                    {% elif act.activity_type == 'unfavorite' %}&#9785;
                    {% elif act.activity_type == 'create_collection' %}&#128193;
                    {% elif act.activity_type in ('add_to_collection', 'remove_from_collection') %}&#128204;
                    {% elif act.activity_type in ('request_showings', 'cancel_showings') %}&#128197;
                    {% elif act.activity_type == 'save_search' %}&#128269;
                    {% else %}&#9679;{% endif %}
                </div>
                <div>
                    <div class="activity-text">
                        {% if act.activity_type == 'favorite' %}Favorited
                        {% elif act.activity_type == 'unfavorite' %}Unfavorited
                        {% elif act.activity_type == 'create_collection' %}Created collection
                        {% elif act.activity_type == 'add_to_collection' %}Added to collection:
                        {% elif act.activity_type == 'remove_from_collection' %}Removed from collection:
                        {% elif act.activity_type == 'request_showings' %}Requested showings for
                        {% elif act.activity_type == 'cancel_showings' %}Cancelled showings for
                        {% elif act.activity_type == 'save_search' %}Saved search:
                        {% else %}{{ act.activity_type }}{% endif %}
                        {% if act.entity_name %}<span class="activity-entity">{{ act.entity_name }}</span>{% endif %}
                    </div>
                    <div class="activity-time">{{ act.occurred_at }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="cta">
            <a href="{{ dashboard_url }}/buyer-activity">View Full Activity</a>
        </div>
    </div>
    <div class="footer">
        Generated by DREAMS Automation &middot; {{ agent_name }}
    </div>
</div>
</body>
</html>
