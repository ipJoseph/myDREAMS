<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FUB Lead Intelligence Dashboard</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --secondary: #764ba2;
      --success: #34A853;
      --warning: #FFD966;
      --danger: #E06666;
      --info: #4285F4;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
      --card-shadow-hover: 0 8px 12px rgba(0,0,0,0.15);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-gradient);
      color: #333;
      padding: 15px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-left h1 {
      color: var(--primary);
      margin-bottom: 5px;
      font-size: 1.8em;
    }
    
    .header-left .subtitle {
      color: #666;
      font-size: 0.9em;
    }
    
    .header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .refresh-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .refresh-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .last-updated {
      color: #999;
      font-size: 0.85em;
      text-align: right;
    }
    
    /* Metrics Overview */
    .metrics-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
      transition: height 0.3s;
    }
    
    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }
    
    .metric-card:hover::before {
      height: 8px;
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .metric-icon {
      font-size: 2.5em;
      opacity: 0.2;
      position: absolute;
      right: 15px;
      top: 15px;
    }
    
    .metric-label {
      color: #666;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .metric-value {
      font-size: 2.8em;
      font-weight: bold;
      color: var(--primary);
      line-height: 1;
      margin: 10px 0;
    }
    
    .metric-change {
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
    }
    
    .metric-change.positive {
      color: var(--success);
    }
    
    .metric-change.negative {
      color: var(--danger);
    }
    
    .metric-description {
      color: #999;
      font-size: 0.8em;
      margin-top: 5px;
    }
    
    /* Tabs */
    .tabs {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      box-shadow: var(--card-shadow);
    }
    
    .tab {
      padding: 12px 24px;
      border: none;
      background: #f5f5f5;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      white-space: nowrap;
      position: relative;
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--primary);
    }
    
    .tab:hover:not(.active) {
      background: #e0e0e0;
    }
    
    /* Content Sections */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 1.4em;
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Lead Cards */
    .lead-card {
      background: #f9f9f9;
      border-left: 4px solid var(--primary);
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .lead-card:hover {
      background: #f0f0f0;
      transform: translateX(5px);
      box-shadow: var(--card-shadow);
    }
    
    .lead-card.priority-urgent {
      border-left-color: #dc3545;
      background: #fff5f5;
    }
    
    .lead-card.priority-high {
      border-left-color: #ff6b6b;
    }
    
    .lead-card.priority-medium {
      border-left-color: #ffa500;
    }
    
    .lead-card.priority-low {
      border-left-color: #4285F4;
    }
    
    .lead-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .lead-name {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      flex: 1;
    }
    
    .lead-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    
    .badge-score {
      background: var(--primary);
      color: white;
    }
    
    .badge-hot {
      background: #dc3545;
      color: white;
    }
    
    .badge-value {
      background: #ffc107;
      color: #333;
    }
    
    .badge-intent {
      background: #28a745;
      color: white;
    }
    
    .lead-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 0.9em;
    }
    
    .detail-icon {
      width: 20px;
      text-align: center;
    }
    
    /* Score Visualization */
    .score-breakdown {
      margin-top: 15px;
    }
    
    .score-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .score-label {
      width: 100px;
      font-size: 0.85em;
      font-weight: 600;
      color: #666;
    }
    
    .score-bar-container {
      flex: 1;
      background: #e0e0e0;
      height: 24px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .score-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-size: 0.75em;
      font-weight: bold;
    }
    
    .score-value {
      min-width: 40px;
      text-align: right;
      font-weight: bold;
      font-size: 0.9em;
    }
    
    /* Intent Signals */
    .intent-signals {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }
    
    .signal {
      background: #e8f4f8;
      color: #0277bd;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .signal::before {
      content: '‚óè';
      color: #0277bd;
    }
    
    /* Action Buttons */
    .lead-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
    .action-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }
    
    .action-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    .action-btn.secondary {
      background: #6c757d;
    }
    
    .action-btn.secondary:hover {
      background: #5a6268;
    }
    
    /* Search and Filters */
    .controls-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    .search-box:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .filter-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .filter-chip {
      padding: 10px 18px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9em;
      font-weight: 500;
    }
    
    .filter-chip:hover {
      border-color: var(--primary);
      background: #f8f9fa;
    }
    
    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Charts and Visualizations */
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .mini-chart {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }
    
    .mini-chart-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #666;
    }
    
    .distribution-bar {
      display: flex;
      height: 40px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .dist-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.85em;
      transition: all 0.3s;
    }
    
    .dist-segment:hover {
      opacity: 0.8;
      transform: scaleY(1.1);
    }
    
    .dist-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      font-size: 0.85em;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    
    /* Action Queue */
    .queue-section {
      margin-bottom: 30px;
    }
    
    .queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
    }
    
    .queue-title {
      font-size: 1.2em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .queue-count {
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.9em;
    }
    
    .queue-items {
      background: white;
      border: 2px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 15px;
    }
    
    /* Loading & Errors */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--primary);
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #fff5f5;
      border: 2px solid var(--danger);
      color: #c0392b;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .error-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-icon {
      font-size: 4em;
      margin-bottom: 15px;
      opacity: 0.3;
    }
    
    .empty-message {
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    
    .empty-submessage {
      font-size: 0.9em;
      color: #bbb;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-right {
        width: 100%;
        justify-content: space-between;
        margin-top: 15px;
      }
      
      .metrics-overview {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        overflow-x: auto;
      }
      
      .lead-header {
        flex-direction: column;
      }
      
      .chart-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Utilities */
    .text-center { text-align: center; }
    .mb-20 { margin-bottom: 20px; }
    .mt-20 { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>üéØ FUB Lead Intelligence</h1>
        <p class="subtitle">Advanced Lead Scoring & Analytics Dashboard</p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="loadDashboard()">
          <span>üîÑ</span>
          <span>Refresh</span>
        </button>
        <div class="last-updated" id="lastUpdated">Loading...</div>
      </div>
    </div>
    
    <!-- Metrics Overview -->
    <div class="metrics-overview" id="metricsGrid">
      <div class="metric-card">
        <div class="metric-icon">üë•</div>
        <div class="metric-label">Total Leads</div>
        <div class="metric-value">--</div>
        <div class="metric-description">In database</div>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('hot')">üî• Hot Leads</button>
      <button class="tab" onclick="switchTab('queue')">üìã Action Queue</button>
      <button class="tab" onclick="switchTab('analysis')">üìä Score Analysis</button>
      <button class="tab" onclick="switchTab('trends')">üìà Trends</button>
      <button class="tab" onclick="switchTab('insights')">üí° Insights</button>
    </div>
    
    <!-- Hot Leads Section -->
    <div id="hot" class="content-section active">
      <div class="section-card">
        <h2 class="section-title">üî• Hot Leads</h2>
        
        <div class="controls-section">
          <input type="text" class="search-box" placeholder="üîç Search by name, email, phone, or stage..." onkeyup="filterLeads(this.value)">
          
          <div class="filter-group">
            <div class="filter-chip active" onclick="filterByScore('all')">All Leads</div>
            <div class="filter-chip" onclick="filterByScore('90+')">üî• 90+ Priority</div>
            <div class="filter-chip" onclick="filterByScore('intent')">üéØ High Intent</div>
            <div class="filter-chip" onclick="filterByScore('value')">üíé High Value</div>
            <div class="filter-chip" onclick="filterByScore('active')">‚ö° Active 7d</div>
          </div>
        </div>
        
        <div id="hotLeadsList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading hot leads...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action Queue Section -->
    <div id="queue" class="content-section">
      <div class="section-card">
        <h2 class="section-title">üìã Daily Action Queue</h2>
        <p style="color: #666; margin-bottom: 20px;">Prioritized list of leads requiring attention today</p>
        <div id="actionQueue">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading action queue...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Analysis Section -->
    <div id="analysis" class="content-section">
      <div class="section-card">
        <h2 class="section-title">üìä Score Analysis</h2>
        
        <div class="chart-grid">
          <div class="mini-chart">
            <div class="mini-chart-title">Priority Score Distribution</div>
            <div id="priorityDist"></div>
          </div>
          
          <div class="mini-chart">
            <div class="mini-chart-title">Heat Score Distribution</div>
            <div id="heatDist"></div>
          </div>
          
          <div class="mini-chart">
            <div class="mini-chart-title">Value Score Distribution</div>
            <div id="valueDist"></div>
          </div>
          
          <div class="mini-chart">
            <div class="mini-chart-title">Relationship Score Distribution</div>
            <div id="relationshipDist"></div>
          </div>
        </div>
        
        <div id="scoreAnalysis">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading analysis...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Trends Section -->
    <div id="trends" class="content-section">
      <div class="section-card">
        <h2 class="section-title">üìà Trends & Activity</h2>
        <div id="trendsView">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading trends...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Insights Section -->
    <div id="insights" class="content-section">
      <div class="section-card">
        <h2 class="section-title">üí° Strategic Insights</h2>
        <div id="insightsView">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Analyzing patterns...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let allLeads = [];
    let metrics = {};
    let currentFilter = 'all';
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboard();
    });
    
    function loadDashboard() {
      document.getElementById('lastUpdated').textContent = 'Updating...';
      
      google.script.run
        .withSuccessHandler(displayMetrics)
        .withFailureHandler(showError)
        .getMetrics();
      
      google.script.run
        .withSuccessHandler(displayHotLeads)
        .withFailureHandler(showError)
        .getHotLeads();
      
      google.script.run
        .withSuccessHandler(displayActionQueue)
        .withFailureHandler(showError)
        .getActionQueue();
      
      google.script.run
        .withSuccessHandler(displayAnalysis)
        .withFailureHandler(showError)
        .getScoreAnalysis();
      
      google.script.run
        .withSuccessHandler(displayTrends)
        .withFailureHandler(showError)
        .getTrends();
      
      google.script.run
        .withSuccessHandler(displayInsights)
        .withFailureHandler(showError)
        .getInsights();
      
      document.getElementById('lastUpdated').textContent = 
        'Updated: ' + new Date().toLocaleTimeString();
    }
    
    function displayMetrics(data) {
      metrics = data;
      const grid = document.getElementById('metricsGrid');
      
      grid.innerHTML = `
        <div class="metric-card">
          <div class="metric-icon">üë•</div>
          <div class="metric-label">Total Leads</div>
          <div class="metric-value">${data.totalLeads || 0}</div>
          <div class="metric-description">In database</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">üî•</div>
          <div class="metric-label">Hot Leads</div>
          <div class="metric-value">${data.hotLeads || 0}</div>
          <div class="metric-change positive">
            ‚Üó ${data.hotPercent || 0}% of total
          </div>
          <div class="metric-description">Priority ‚â• 75</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">üíé</div>
          <div class="metric-label">High Value</div>
          <div class="metric-value">${data.highValue || 0}</div>
          <div class="metric-description">Value ‚â• 25</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">‚ö°</div>
          <div class="metric-label">Active (7d)</div>
          <div class="metric-value">${data.activeThisWeek || 0}</div>
          <div class="metric-description">Recent activity</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">üìä</div>
          <div class="metric-label">Avg Priority</div>
          <div class="metric-value">${data.avgPriority || 0}</div>
          <div class="metric-description">Overall score</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">üéØ</div>
          <div class="metric-label">High Intent</div>
          <div class="metric-value">${data.highIntent || 0}</div>
          <div class="metric-description">‚â•2 intent signals</div>
        </div>
      `;
    }
    
    function displayHotLeads(leads) {
      allLeads = leads || [];
      renderLeads(leads);
    }
    
    function renderLeads(leads) {
      const container = document.getElementById('hotLeadsList');
      
      if (!leads || leads.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <div class="empty-message">No leads found</div>
            <div class="empty-submessage">Try adjusting your filters</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = leads.map(lead => createLeadCard(lead)).join('');
    }
    
    function createLeadCard(lead) {
      const priorityClass = lead.priority >= 90 ? 'priority-urgent' :
                           lead.priority >= 80 ? 'priority-high' :
                           lead.priority >= 60 ? 'priority-medium' : 'priority-low';
      
      const signals = lead.intentSignals || [];
      const badges = [];
      
      if (lead.priority >= 90) badges.push('<span class="badge badge-hot">üî• Urgent</span>');
      if (lead.value >= 70) badges.push('<span class="badge badge-value">üíé High Value</span>');
      if (signals.length >= 4) badges.push('<span class="badge badge-intent">üéØ High Intent</span>');
      
      return `
        <div class="lead-card ${priorityClass}">
          <div class="lead-header">
            <div class="lead-name">${lead.name || 'Unknown'}</div>
            <div class="lead-badges">
              <span class="badge badge-score">${lead.priority ? lead.priority.toFixed(1) : '0'}</span>
              ${badges.join('')}
            </div>
          </div>
          
          <div class="lead-details">
            <div class="detail-item">
              <span class="detail-icon">üìß</span>
              ${lead.email || 'No email'}
            </div>
            <div class="detail-item">
              <span class="detail-icon">üì±</span>
              ${lead.phone || 'No phone'}
            </div>
            <div class="detail-item">
              <span class="detail-icon">üìç</span>
              ${lead.stage || 'No stage'}
            </div>
            <div class="detail-item">
              <span class="detail-icon">‚è±Ô∏è</span>
              ${lead.daysSinceActivity !== undefined ? lead.daysSinceActivity + ' days ago' : 'N/A'}
            </div>
          </div>
          
          <div class="score-breakdown">
            <div class="score-row">
              <div class="score-label">Heat</div>
              <div class="score-bar-container">
                <div class="score-bar-fill" style="width: ${lead.heat || 0}%">
                  ${lead.heat >= 20 ? (lead.heat || 0).toFixed(0) + '%' : ''}
                </div>
              </div>
              <div class="score-value">${(lead.heat || 0).toFixed(0)}</div>
            </div>
            
            <div class="score-row">
              <div class="score-label">Value</div>
              <div class="score-bar-container">
                <div class="score-bar-fill" style="width: ${lead.value || 0}%; background: linear-gradient(90deg, #ffc107, #ff9800);">
                  ${lead.value >= 20 ? (lead.value || 0).toFixed(0) + '%' : ''}
                </div>
              </div>
              <div class="score-value">${(lead.value || 0).toFixed(0)}</div>
            </div>
            
            <div class="score-row">
              <div class="score-label">Relationship</div>
              <div class="score-bar-container">
                <div class="score-bar-fill" style="width: ${lead.relationship || 0}%; background: linear-gradient(90deg, #28a745, #20c997);">
                  ${lead.relationship >= 20 ? (lead.relationship || 0).toFixed(0) + '%' : ''}
                </div>
              </div>
              <div class="score-value">${(lead.relationship || 0).toFixed(0)}</div>
            </div>
          </div>
          
          ${signals.length > 0 ? `
            <div class="intent-signals">
              ${signals.map(s => `<span class="signal">${s}</span>`).join('')}
            </div>
          ` : ''}
          
          <div class="lead-actions">
            <button class="action-btn" onclick="contactLead('${lead.email}', 'email')">
              üìß Email
            </button>
            <button class="action-btn" onclick="contactLead('${lead.phone}', 'call')">
              üì± Call
            </button>
            <button class="action-btn secondary" onclick="viewDetails('${lead.id || lead.email}')">
              üëÅÔ∏è Details
            </button>
          </div>
        </div>
      `;
    }
    
    function displayActionQueue(queue) {
      const container = document.getElementById('actionQueue');
      
      if (!queue || queue.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <div class="empty-message">All caught up!</div>
            <div class="empty-submessage">No pending actions at this time</div>
          </div>
        `;
        return;
      }
      
      const grouped = queue.reduce((acc, item) => {
        const priority = item.priority || 4;
        if (!acc[priority]) acc[priority] = [];
        acc[priority].push(item);
        return acc;
      }, {});
      
      const priorityConfig = {
        '1': { label: 'üî• Priority 1: Immediate Contact', color: '#dc3545' },
        '2': { label: 'üíé Priority 2: High Value Warm', color: '#ffc107' },
        '3': { label: 'üå± Priority 3: Nurture & Engage', color: '#28a745' },
        '4': { label: '‚è∞ Priority 4: Re-engagement', color: '#6c757d' }
      };
      
      container.innerHTML = Object.entries(grouped).map(([priority, items]) => {
        const config = priorityConfig[priority] || { label: 'Other', color: '#999' };
        
        return `
          <div class="queue-section">
            <div class="queue-header" style="background: ${config.color};">
              <div class="queue-title">${config.label}</div>
              <div class="queue-count">${items.length} ${items.length === 1 ? 'lead' : 'leads'}</div>
            </div>
            <div class="queue-items">
              ${items.map(item => createLeadCard(item)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function displayAnalysis(analysis) {
      if (!analysis) return;
      
      // Display distribution charts
      displayDistribution('priorityDist', analysis.priorityDist, 'Priority');
      displayDistribution('heatDist', analysis.heatDist, 'Heat');
      displayDistribution('valueDist', analysis.valueDist, 'Value');
      displayDistribution('relationshipDist', analysis.relationshipDist, 'Relationship');
      
      // Display detailed analysis
      const container = document.getElementById('scoreAnalysis');
      container.innerHTML = `
        <div class="section-card">
          <h3 style="margin-bottom: 20px;">Score Insights</h3>
          ${createInsightsList(analysis.insights || [])}
        </div>
      `;
    }
    
    function displayDistribution(elementId, dist, label) {
      const container = document.getElementById(elementId);
      if (!dist) return;
      
      const total = (dist.excellent || 0) + (dist.good || 0) + (dist.medium || 0) + (dist.low || 0);
      if (total === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">No data</p>';
        return;
      }
      
      const percentages = {
        excellent: ((dist.excellent || 0) / total * 100).toFixed(1),
        good: ((dist.good || 0) / total * 100).toFixed(1),
        medium: ((dist.medium || 0) / total * 100).toFixed(1),
        low: ((dist.low || 0) / total * 100).toFixed(1)
      };
      
      container.innerHTML = `
        <div class="distribution-bar">
          ${dist.excellent ? `<div class="dist-segment" style="width: ${percentages.excellent}%; background: #34A853;" title="Excellent: ${dist.excellent}">${percentages.excellent}%</div>` : ''}
          ${dist.good ? `<div class="dist-segment" style="width: ${percentages.good}%; background: #93C47D;" title="Good: ${dist.good}">${percentages.good}%</div>` : ''}
          ${dist.medium ? `<div class="dist-segment" style="width: ${percentages.medium}%; background: #FFD966;" title="Medium: ${dist.medium}">${percentages.medium}%</div>` : ''}
          ${dist.low ? `<div class="dist-segment" style="width: ${percentages.low}%; background: #E06666;" title="Low: ${dist.low}">${percentages.low}%</div>` : ''}
        </div>
        
        <div class="dist-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #34A853;"></div>
            <span>Excellent (${dist.excellent || 0})</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #93C47D;"></div>
            <span>Good (${dist.good || 0})</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FFD966;"></div>
            <span>Medium (${dist.medium || 0})</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #E06666;"></div>
            <span>Low (${dist.low || 0})</span>
          </div>
        </div>
      `;
    }
    
    function createInsightsList(insights) {
      if (!insights || insights.length === 0) {
        return '<p style="color: #999;">No insights available</p>';
      }
      
      return insights.map(insight => `
        <div class="lead-card" style="border-left-color: #667eea;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${insight.category}</strong>
              <p style="color: #666; margin-top: 5px;">${insight.description}</p>
            </div>
            <div style="font-size: 2em; font-weight: bold; color: #667eea;">
              ${insight.count}
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function displayTrends(trends) {
      const container = document.getElementById('trendsView');
      
      if (!trends) {
        container.innerHTML = '<p style="color: #999;">No trend data available</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="chart-grid">
          <div class="mini-chart">
            <div class="mini-chart-title">Activity Patterns</div>
            <div id="activityPattern"></div>
          </div>
        </div>
      `;
      
      if (trends.activityPattern) {
        displayActivityPattern(trends.activityPattern);
      }
    }
    
    function displayActivityPattern(pattern) {
      const container = document.getElementById('activityPattern');
      const total = Object.values(pattern).reduce((a, b) => a + b, 0);
      
      container.innerHTML = `
        <div style="margin-bottom: 15px;">
          ${Object.entries(pattern).map(([label, count]) => {
            const percent = total > 0 ? (count / total * 100).toFixed(1) : 0;
            return `
              <div class="score-row">
                <div class="score-label" style="width: 120px;">${label}</div>
                <div class="score-bar-container">
                  <div class="score-bar-fill" style="width: ${percent}%;">
                    ${percent}%
                  </div>
                </div>
                <div class="score-value">${count}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function displayInsights(insights) {
      const container = document.getElementById('insightsView');
      
      if (!insights || insights.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üí°</div>
            <div class="empty-message">No insights yet</div>
            <div class="empty-submessage">Check back after more data is collected</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = insights.map(insight => `
        <div class="lead-card" style="border-left-color: ${insight.type === 'opportunity' ? '#28a745' : '#ffc107'};">
          <div>
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">
              ${insight.type === 'opportunity' ? 'üåü' : '‚ö†Ô∏è'} ${insight.title}
            </div>
            <p style="color: #666; line-height: 1.6;">${insight.description}</p>
            ${insight.action ? `
              <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <strong>Recommended Action:</strong> ${insight.action}
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }
    
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
    }
    
    function filterLeads(searchTerm) {
      const filtered = allLeads.filter(lead => {
        const searchLower = searchTerm.toLowerCase();
        return (lead.name && lead.name.toLowerCase().includes(searchLower)) ||
               (lead.email && lead.email.toLowerCase().includes(searchLower)) ||
               (lead.phone && lead.phone.includes(searchTerm)) ||
               (lead.stage && lead.stage.toLowerCase().includes(searchLower));
      });
      
      renderLeads(filtered);
    }
    
    function filterByScore(type) {
      currentFilter = type;
      
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.classList.add('active');
      
      let filtered = allLeads;
      
      switch(type) {
        case '90+':
          filtered = allLeads.filter(l => l.priority >= 90);
          break;
        case 'intent':
          filtered = allLeads.filter(l => l.intentSignals && l.intentSignals.length >= 2);
          break;
        case 'value':
          filtered = allLeads.filter(l => l.value >= 25);
          break;
        case 'active':
          filtered = allLeads.filter(l => l.daysSinceActivity !== undefined && l.daysSinceActivity <= 7);
          break;
        case 'all':
        default:
          filtered = allLeads;
      }
      
      renderLeads(filtered);
    }
    
    function contactLead(contact, type) {
      if (!contact || contact === 'No email' || contact === 'No phone') {
        alert('Contact information not available');
        return;
      }
      
      if (type === 'email') {
        window.location.href = `mailto:${contact}`;
      } else if (type === 'call') {
        window.location.href = `tel:${contact}`;
      }
    }
    
    function viewDetails(id) {
      alert('Lead details view - Coming soon!\nLead ID: ' + id);
    }
    
    function showError(error) {
      console.error('Error:', error);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = `
        <div class="error-title">‚ö†Ô∏è Error Loading Data</div>
        <div>${error.message || 'An unexpected error occurred'}</div>
      `;
      document.querySelector('.container').prepend(errorDiv);
      
      setTimeout(() => errorDiv.remove(), 5000);
    }
    
    // Auto-refresh every 5 minutes
    setInterval(loadDashboard, 5 * 60 * 1000);
  </script>
</body>
</html>
