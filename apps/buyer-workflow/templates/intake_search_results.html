{% extends "base.html" %}

{% block title %}Search Results - DREAMS{% endblock %}

{% block content %}
<form id="package-form" method="POST" action="{{ url_for('package_save') }}">
<input type="hidden" name="lead_id" value="{{ lead.id }}">
<input type="hidden" name="intake_form_id" value="{{ form.id }}">
<input type="hidden" name="name" value="{{ form.form_name or 'Property Package' }} - {{ now().strftime('%b %d') if now else 'Today' }}">

<div class="page-header">
    <div>
        <h1 class="page-title">Search Results</h1>
        <div style="color: var(--gray-500);">
            {{ form.form_name or 'Search' }} for {{ lead.first_name }} {{ lead.last_name }}
            | {{ properties|length }} properties found
            {% if properties %}| <span id="selected-count">0</span> selected{% endif %}
        </div>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        {% if properties %}
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="select-all" style="width: 18px; height: 18px;">
            <span>Select All</span>
        </label>
        {% endif %}
        <a href="{{ url_for('intake_edit', form_id=form.id) }}" class="btn btn-secondary">Edit Criteria</a>
        <button type="submit" class="btn btn-primary" id="create-package-btn" disabled>Create Package (<span id="btn-count">0</span>)</button>
    </div>
</div>

<div class="card" style="margin-bottom: 1rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <strong>Search Criteria:</strong>
        {% if form.min_price or form.max_price %}
            Price: ${{ "{:,}".format(form.min_price|int) if form.min_price else '0' }} - ${{ "{:,}".format(form.max_price|int) if form.max_price else 'Any' }}
        {% endif %}
        {% if form.min_beds %}| {{ form.min_beds }}+ beds{% endif %}
        {% if form.min_baths %}| {{ form.min_baths }}+ baths{% endif %}
        {% if form.counties %}| Counties: {{ form.counties }}{% endif %}
    </div>
</div>

{% if properties %}
<div class="property-grid">
    {% for prop in properties %}
    <div class="property-card" style="position: relative;">
        <label class="property-checkbox" style="position: absolute; top: 0.5rem; left: 0.5rem; z-index: 10;">
            <input type="checkbox" name="property_ids" value="{{ prop.id }}" class="property-select" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
        <div class="property-image" style="background-image: url('{{ prop.primary_photo or '' }}');">
            {% if not prop.primary_photo %}
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gray-500); background: var(--gray-100);">
                No Photo
            </div>
            {% endif %}
        </div>
        <div class="property-info">
            <div class="property-price">${{ "{:,}".format(prop.list_price) if prop.list_price else 'N/A' }}</div>
            {% if prop.mls_url %}
            <a href="{{ prop.mls_url }}" target="_blank" class="property-address" style="color: var(--primary); text-decoration: none;">{{ prop.address }}</a>
            {% else %}
            <div class="property-address">{{ prop.address }}</div>
            {% endif %}
            <div style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.5rem;">
                {{ prop.city }}, {{ prop.state }} {{ prop.zip }} | {{ prop.county }} County
            </div>
            <div class="property-details">
                <span>{{ prop.beds or '-' }} bd</span>
                <span>{{ prop.baths or '-' }} ba</span>
                <span>{{ "{:,}".format(prop.sqft) if prop.sqft else '-' }} sqft</span>
                {% if prop.acreage %}<span>{{ prop.acreage }} ac</span>{% endif %}
            </div>
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% if prop.mls_number %}
                <a href="#" onclick="openMLS('{{ prop.mls_number }}'); return false;" class="badge badge-gray" style="text-decoration: none; cursor: pointer;" title="Open in Canopy MLS">MLS# {{ prop.mls_number }}</a>
                {% endif %}
                {% if prop.days_on_market %}
                <span class="badge badge-primary">{{ prop.days_on_market }} DOM</span>
                {% endif %}
                {% if prop.documents_count %}
                <span class="badge badge-success">{{ prop.documents_count }} docs</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <h3>No Properties Found</h3>
    <p style="color: var(--gray-500);">
        Try adjusting the search criteria to find more properties.
    </p>
    <a href="{{ url_for('intake_edit', form_id=form.id) }}" class="btn btn-primary" style="margin-top: 1rem;">
        Edit Search Criteria
    </a>
</div>
{% endif %}
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.property-select');
    const selectedCount = document.getElementById('selected-count');
    const btnCount = document.getElementById('btn-count');
    const createBtn = document.getElementById('create-package-btn');

    function updateCount() {
        const checked = document.querySelectorAll('.property-select:checked').length;
        if (selectedCount) selectedCount.textContent = checked;
        if (btnCount) btnCount.textContent = checked;
        if (createBtn) createBtn.disabled = checked === 0;
    }

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateCount();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateCount();
            if (selectAll) {
                selectAll.checked = document.querySelectorAll('.property-select:checked').length === checkboxes.length;
            }
        });
    });
});

function openMLS(mlsNumber) {
    fetch('/api/mls/open/' + mlsNumber)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('MLS Login Required\n\nRun this command first:\npython apps/redfin-importer/mls_opener.py --login');
            }
        })
        .catch(err => {
            console.error('MLS open error:', err);
            alert('Error opening MLS. Check console for details.');
        });
}

</script>
{% endblock %}
